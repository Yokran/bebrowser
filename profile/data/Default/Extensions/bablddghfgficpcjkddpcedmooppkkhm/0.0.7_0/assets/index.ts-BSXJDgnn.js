var F=Object.defineProperty;var k=(e,t,a)=>t in e?F(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var y=(e,t,a)=>k(e,typeof t!="symbol"?t+"":t,a);import{E as c,a as g,P as f,h,G as R,b as B,s as j,p as S,d as N,e as H}from"./shareConst-CJiZrIdS.js";var U=(e=>(e[e.FREE=0]="FREE",e[e.BASIC=1]="BASIC",e[e.PREMIUM=2]="PREMIUM",e))(U||{});U.FREE;var G=(e=>(e[e.FREE=0]="FREE",e[e.BASIC=1]="BASIC",e[e.PREMIUM=2]="PREMIUM",e))(G||{}),$=(e=>(e[e.SUBSCRIPTION=0]="SUBSCRIPTION",e[e.ONETIME_PAYMENT=1]="ONETIME_PAYMENT",e))($||{}),X=(e=>(e[e.ONE_MONTH=1]="ONE_MONTH",e[e.THREE_MONTH=3]="THREE_MONTH",e[e.SIX_MONTH=6]="SIX_MONTH",e[e.A_YEAR=12]="A_YEAR",e))(X||{}),Y=(e=>(e[e.STRIPE=0]="STRIPE",e[e.PAYPAL=1]="PAYPAL",e))(Y||{}),K=(e=>(e[e.FACEBOOK=0]="FACEBOOK",e[e.INSTAGRAM=1]="INSTAGRAM",e))(K||{}),W=(e=>(e.SUBSCRIPTION="paypal_subscription",e.PAYMENT="paypal_payment",e))(W||{}),q=(e=>(e.RETURN_PAGE="RETURN_PAGE",e.RETURN_EXT="RETURN_EXT",e.RETURN_EXT_LOCAL="RETURN_EXT_LOCAL",e))(q||{});function w(e,t){Object.keys(e).map(a=>t(e[a],a,e))}function A(e,t){function a(o,s){switch(o.type){case"object":return r(o,s);case"array":return n(o,s);default:return s!==void 0?s:o.default!==void 0?o.default:void 0}}function r(o,s){const i={},u=o.properties??{};return w(u,(l,d)=>{if(o.required.includes(d)||s!==void 0&&s[d]!==void 0){let p=s!==void 0?s[d]:void 0;!l.properties&&l.default&&l.type==="object"&&l.additionalProperties&&(p=l.default),i[d]=a(l,p)}}),s&&w(s,(l,d)=>{i[d]===void 0&&l!==void 0&&(i[d]=l)}),i}function n(o,s){if(s===void 0)return o.default?o.default:void 0;const i=[];for(let u=0;u<s.length;u++)i.push(a(o.items??{},s[u]));return i}return a(t,e)}function O(e,t){async function a(s){let i;return await navigator.locks.request(b(s),{mode:"shared"},async()=>{i=(await M(s))[s]}),i===void 0&&(i=A(i,e[s])),i}async function r(s,i){await navigator.locks.request(b(s),{mode:"exclusive"},async()=>{let u=(await M(s))[s];u===void 0&&(u=A(u,e[s]));const l=await i(u);await chrome.storage.local.set({[s]:l})})}async function n(s,i){await navigator.locks.request(b(s),{mode:"exclusive"},async()=>{let u=i||{};i||(u=A(u,e[s])),await chrome.storage.local.set({[s]:u})})}async function o(s){return await navigator.locks.request(b(s),{mode:"exclusive"},async()=>{await chrome.storage.local.remove([s])}),Promise.resolve()}return{updateBucket:r,setBucket:n,getBucket:a,deleteBucket:o}}function b(e){return`storage.local.${e}`}function M(e){return new Promise(t=>{chrome.storage.local.get(e,a=>{t(a)})})}function J(e,t){(async()=>{let a=0,r=(await chrome.declarativeNetRequest.getDynamicRules()).map(o=>o.id);const n=e.map((o,s)=>(a=s+1,{id:a,priority:1,action:{type:"modifyHeaders",responseHeaders:[{header:"Content-Security-Policy",operation:"remove"},{header:"Content-Security-Policy-Report-Only",operation:"remove"}]},condition:{regexFilter:o,resourceTypes:["main_frame","xmlhttprequest"]}}));await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:r,addRules:n})})()}function V(e){const{hostMatch:t,extensionId:a,extensionName:r}=e;chrome.tabs.onUpdated.addListener(async(n,o,s)=>{if(s&&s.url&&s&&s.url&&o&&o.status==="loading"){const i=new URL(s.url).hostname;if(t.find(u=>!!~u.indexOf(i))){const u=chrome.runtime.getManifest();chrome.scripting.executeScript({injectImmediately:!0,world:"MAIN",target:{tabId:n,allFrames:!0},func:l=>{window[l.slug]=l},args:[{id:chrome.runtime.id,slug:a,extensionName:r,version:u.version,icons:u.icons,extensionFolderUri:chrome.runtime.getURL("/"),isProdMode:"update_url"in chrome.runtime.getManifest()}]})}}})}function z(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}const I={};class Q{constructor(t,a){y(this,"listeners",{});y(this,"slug");y(this,"isDebugger");this.slug=t,this.isDebugger=!!a,this.bindMessage()}on(t,a){if(this.listeners[t])throw new Error(`error: event listener ${String(t)} already exist!`);return this.listeners[t]=a,()=>{delete this.listeners[t]}}async send(t,a,r,n=3e4){this.isDebugger&&console.log(`TO CONTENT - [${t.toString()}]`,{action:t,payload:r});const o=z();return chrome.tabs.sendMessage(a,{from:this.slug,payload:{action:t,payload:r,__callbackId:o}}),new Promise(s=>{const i=setTimeout(()=>{delete I[o],s({status:c.FAILED,errorMessage:"TIMEOUT"})},n);I[o]=(u,l)=>{clearTimeout(i),s(u==="success"?{status:c.SUCCESS,payload:l}:{status:c.FAILED,errorMessage:l.toString()}),delete I[o]}})}bindMessage(){chrome.runtime.onMessageExternal.addListener((t,a,r)=>{var n,o,s;if((n=a==null?void 0:a.tab)!=null&&n.id){if(this.isDebugger&&console.log(`IN - [${t.action}]`,{request:t,sender:a}),t.action==="__eventCallback"){const{__callbackId:i,payload:u}=t;(o=I[i])==null||o.call(I,u.status,u.payload)}return this.listeners[t.action]?(s=a==null?void 0:a.tab)!=null&&s.id?(this.listeners[t.action].bind({request:t,sender:a})(...t.payload).then(i=>{this.isDebugger&&console.log(`OUT - [${t.action}]`,{request:t,sender:a,res:i}),r(i)}).catch(i=>{r(i.toString())}),!0):r(`error:${g.EXT_UNABLE_READ_SENDER_TAB_ID}`):r(`error:${g.EXT_UNKNOWN_EVENT} ${t.action}`)}})}}const Z={type:"object",properties:{[f.FACEBOOK]:{type:"object",default:{}},[f.INSTAGRAM]:{type:"object",default:{}},[f.MESSENGER]:{type:"object",default:{}},[f.BUSINESS_SUIT]:{type:"object",default:{}},[f.THREADS]:{type:"object",default:{}}},required:[f.FACEBOOK,f.INSTAGRAM,f.MESSENGER,f.BUSINESS_SUIT,f.THREADS],default:{}},P={UserInfo:Z},{updateBucket:ee,setBucket:fe,getBucket:me,deleteBucket:ge}=O(P),m={};async function E(e){return((await chrome.storage.session.get("platformTabIdMap")).platformTabIdMap||{})[e]||null}async function v(e,t){const r=(await chrome.storage.session.get("platformTabIdMap")).platformTabIdMap||{};r[e]=t,await chrome.storage.session.set({platformTabIdMap:r})}async function _(e){await v(e,null)}function te(e){e.on("inject_isCurrentPlatformTab",async function(t){var n,o;const a=(o=(n=this.sender)==null?void 0:n.tab)==null?void 0:o.id;return await E(t)===a}),e.on("inject_platformInitializeComplete",async function(t,a){if(await ee("UserInfo",r=>(r[t]=a.status===c.SUCCESS?a.payload:null,r)),m[t]){for(const r of m[t])a.status===c.SUCCESS?(await v(t,this.sender.tab.id),r({status:c.SUCCESS,payload:a.payload})):a.status===c.FAILED&&r({status:c.FAILED,errorMessage:a.errorMessage});m[t]=[]}}),e.on("dashboard_openSocialHelperPage",async function(t){const a=j[t],r=await E(t);return r&&await chrome.tabs.remove(r),new Promise((n,o)=>{var u;let s=!1;const i=((u=m[t])==null?void 0:u.length)??0;m[t]=m[t]||[],m[t].push(l=>{s=!0,n(l)}),i===0&&ae(t).then(()=>{Promise.race([new Promise(l=>setTimeout(()=>l("timeout"),2e4)),new Promise(l=>{chrome.tabs.create({url:a},function(d){const p=d.id;chrome.tabs.onRemoved.addListener(function x(D,ue){D===p&&(_(t),chrome.tabs.onRemoved.removeListener(x),l("closed"))})})})]).then(l=>{if(!s){if(s=!0,m[t])for(const d of m[t])d({status:c.FAILED,errorMessage:l==="timeout"?g.EXT_PLATFORM_INJECT_PAGE_TIMEOUT_DURING_CREATING:g.EXT_PLATFORM_INJECT_PAGE_CLOSED_DURING_CREATING});m[t]=[]}})})})}),e.on("dashboard_isSocialHelperAvailable",async t=>{const a=await T(t,e);if(a)return a.errorMessage}),e.on("dashboard_getErrorMessageHistory",async t=>{const a=await T(t,e);if(a)return a;const r=await e.send("getErrorMessageHistory",await E(t),[],5e3);return r.status===c.FAILED?{status:c.FAILED,errorMessage:r.errorMessage}:{status:c.SUCCESS,payload:r.payload}}),e.on("dashboard_runGraphql",async(t,a)=>{const r=await T(t,e);if(r)return r;const n=await E(t),o=await e.send("runGraphql",n,[a],6e4);return o.status===c.FAILED?{status:c.FAILED,errorMessage:o.errorMessage}:{status:c.SUCCESS,payload:o.payload}}),e.on("dashboard_bulkRouteDefinitions",async(t,a)=>{const r=await T(t,e);if(r)return r;const n=await e.send("bulkRouteDefinitions",await E(t),[a],5e3);return n.status===c.FAILED?{status:c.FAILED,errorMessage:n.errorMessage}:{status:c.SUCCESS,payload:n.payload}})}async function T(e,t){const a=await E(e);if(!a)return{status:c.FAILED,errorMessage:g.EXT_NEED_OPEN_A_PLATFORM_PAGE_TO_RUN_SCRIPT};if(!await chrome.tabs.get(a))return await _(e),{status:c.FAILED,errorMessage:g.EXT_NEED_OPEN_A_PLATFORM_PAGE_TO_RUN_SCRIPT};const n=await t.send("pingSocialHelper",a,[],2e3);if(n.status===c.FAILED)return await _(e),{status:c.FAILED,errorMessage:n.errorMessage==="TIMEOUT"?g.EXT_SOCIAL_HELPER_DISCONNECTED:`${g.EXT_SOCIAL_HELPER_PING_ERROR}: ${n.errorMessage}`}}chrome.tabs.onRemoved.addListener(async e=>{const a=(await chrome.storage.session.get("platformTabIdMap")).platformTabIdMap||{};for(const[r,n]of Object.entries(a))n===e&&await _(r)});async function ae(e){const t=await chrome.tabs.query({url:h.filter(a=>!~a.indexOf("esuit")&&!~a.indexOf("localhost")).map(a=>`${a.replaceAll("*","")}?${R.INJECT_PAGE_QUERY_KEY}`)});for(const a of t)a.url&&a.id&&re(a.url)===e&&await chrome.tabs.remove(a.id)}function re(e){for(const[t,a]of Object.entries(B))if(a.some(r=>e.startsWith(r)))return t;return null}function L(e,t){if(!e)return;const a=e.startsWith("chrome.");let r=a?chrome:t;const n=e.split(".");return(a?n.slice(1):n).reduce((s,i)=>s==null?void 0:s[i],r)}async function se(e,t=[],a=chrome){try{const r=L(e,a);if(typeof r!="function")return{status:c.FAILED,errorMessage:`Unable to find fnPath: ${e}`};const n=await r(...t);return{status:c.SUCCESS,payload:n}}catch(r){const n=r instanceof Error?r.message:"Unknown error";return console.error(`runWithPromise error [${e}]:`,r),{status:c.FAILED,errorMessage:n}}}async function ne(e,t=[],a=chrome){try{const r=L(e,a);return typeof r!="function"?{status:c.FAILED,errorMessage:`Unable to find fnPath: ${e}`}:new Promise(n=>{const o=setTimeout(()=>{n({status:c.FAILED,errorMessage:`TIMEOUT: ${e}`})},3e4),s=i=>{clearTimeout(o),n({status:c.SUCCESS,payload:i})};try{r(...t,s)}catch(i){clearTimeout(o);const u=i instanceof Error?i.message:"Unknown error";n({status:c.FAILED,errorMessage:u})}})}catch(r){const n=r instanceof Error?r.message:"UNKNOWN";return console.error(`runWithCallback ERROR [${e}]:`,r),{status:c.FAILED,errorMessage:n}}}const{updateBucket:oe,getBucket:C}=O(P);function ie(){const e=new Q(S,ce());te(e),e.on("downloadFile",async(t,a)=>{await chrome.downloads.download({url:t,filename:a,conflictAction:"overwrite"})}),e.on("dashboard_runBackgroundPromiseFn",async t=>await se(t.fnPath,t.args??[])),e.on("dashboard_runBackgroundCallbackFn",async t=>await ne(t.fnPath,t.args??[])),e.on("dashboard_getCurrentTabId",async function(){return this.sender.tab.id}),e.on("dashboard_getExtensionInfo",async()=>{const t=await C("UserInfo"),a=chrome.runtime.getManifest();return{status:c.SUCCESS,payload:{version:a.version,userInfo:t[f.FACEBOOK]}}}),e.on("dashboard_getUserInfo",async t=>{const a=await C("UserInfo");if(a[t])return{status:c.SUCCESS,payload:a[t]};const r=await E(t);return r?await e.send("getUserInfo",r,[]):{status:c.FAILED,errorMessage:g.EXT_USER_NO_LOGIN}}),e.on("inject_updateUserInfo",async(t,a)=>{t&&await oe("UserInfo",r=>(r[a]=t,r))}),e.on("inject_focusDashboardPage",async()=>{const t=await chrome.tabs.query({url:`${R.DASHBOARD_URL}/*`});t.length>0?(await chrome.tabs.update(t[0].id,{active:!0}),await chrome.windows.update(t[0].windowId,{focused:!0})):await chrome.tabs.create({url:R.DASHBOARD_URL,active:!0})})}function ce(){return!("update_url"in chrome.runtime.getManifest())}chrome.runtime.onInstalled.addListener(e=>{e.reason==="install"&&chrome.tabs.create({url:N,active:!0})});chrome.action.onClicked.addListener(()=>{chrome.tabs.create({url:N,active:!0})});V({hostMatch:h,extensionId:S,extensionName:H});J(h);ie();chrome.scripting.registerContentScripts([{id:`inject-${S}`,js:["injects/proxy.js"],matches:h,runAt:"document_start",world:"MAIN"}]);chrome.scripting.registerContentScripts([{id:`inject-${S}-module`,js:["injects/vendors.js","injects/index.js"],matches:h,runAt:"document_end",world:"MAIN"}]);
