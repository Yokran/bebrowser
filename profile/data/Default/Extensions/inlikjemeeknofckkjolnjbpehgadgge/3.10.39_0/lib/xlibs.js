!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).xlibs=t()}(this,(function(){"use strict";class BaseError extends Error{code;meta;constructor(e,t,r){super(t,r),this.code=e,this.meta=r?.meta??{}}set(e,t){if("object"==typeof e){if(e.hasOwnProperty("message")||e.hasOwnProperty("code"))throw new Error("meta can't have message or code as keys");Object.assign(this.meta,e)}else{if(["message","code"].includes(e))throw new Error("meta can't have message or code as keys");this.meta[e]=t}}get(e){return this.meta[e]}delete(e){delete this.meta[e]}toJSON(){let e;if(this.cause&&(e=this.cause.toJSON?.(),!e)){const{code:t,message:r,stack:n}=this.cause;e={code:t,message:r,stack:n}}return{code:this.code,message:this.message,stack:this.stack,cause:e,...this.meta}}}class StackedError extends BaseError{stackEx;constructor(e,t){const{code:r,message:n,stack:a,stackEx:s,meta:i,cause:o,stackLineNames:c,...u}=e;super(r,n,{cause:a?{stack:a}:void 0,meta:i}),this.stackEx=s??[],t&&this.add(t),this.set(u)}static handle(e,t,r={}){let n;return"object"==typeof t?n=t:"string"==typeof t&&(n={__name__:t,...r}),e instanceof StackedError?n?(e.add(n),e):e:new StackedError(e,n)}get stackLineNames(){return this.stackEx.map((e=>e.__name__)).join(".")}add(e,t={}){let r;r="object"==typeof e?e:{__name__:e,...t},this.stackEx.unshift(r)}find(e){"string"==typeof e&&(e={__name__:e});return this.stackEx.find((t=>Object.keys(e).every((r=>e[r]===t[r]))))}findLast(e){"string"==typeof e&&(e={__name__:e});return this.stackEx.findLast((t=>Object.keys(e).every((r=>e[r]===t[r]))))}findIndex(e){"string"==typeof e&&(e={__name__:e});return this.stackEx.findIndex((t=>Object.keys(e).every((r=>e[r]===t[r]))))}findLastIndex(e){"string"==typeof e&&(e={__name__:e});return this.stackEx.findLastIndex((t=>Object.keys(e).every((r=>e[r]===t[r]))))}clone(){const e=new StackedError(this);return e.stackEx=[...this.stackEx],e}toJSON(){return{...super.toJSON(),stackEx:this.stackEx,stackLineNames:this.stackLineNames}}}const ErrorCodes$1={E_PARSE:"E_PARSE",E_INTERRUPT:"E_INTERRUPT",E_REQUEST:"E_REQUEST"};class EventEmitter{__ee_listeners;constructor(){this.__ee_listeners={}}emit(e,...t){(this.__ee_listeners[e]||[]).forEach((e=>e(...t)))}hasListener(e){return(this.__ee_listeners[e]||[]).length>0}off(e,t){let r=this.__ee_listeners[e];null==r&&(r=this.__ee_listeners[e]=[]);let n=r.indexOf(t);for(;n>=0;)r.splice(n,1),n=r.indexOf(t);return this}on(e,t){let r=this.__ee_listeners[e];return null==r&&(r=this.__ee_listeners[e]=[]),r.push(t),this}once(e,t){const r=(...n)=>{this.off(e,r),t(...n)};return this.on(e,r),this}removeListeners(){this.__ee_listeners={}}waitForEvent(e,...t){return new Promise((r=>{this.on(e,((...e)=>{for(let r=0,n=t.length;r<n;r+=1)if(t[r]!==e[r])return;r(e[0])}))}))}}class RejectablePromise extends Promise{_resolve;_reject;settled=!1;state="pending";constructor(e=()=>{}){let t,r;super(((n,a)=>(t=n,r=a,e(n,a)))),this._resolve=t,this._reject=r}resolve(e){this._resolve(e),this.state="fulfilled",this.settled=!0}reject(e){this._reject(e),this.state="rejected",this.settled=!0}}var types=Object.freeze({__proto__:null,BaseError:BaseError,ErrorCodes:ErrorCodes$1,EventEmitter:EventEmitter,RejectablePromise:RejectablePromise,StackedError:StackedError}),C={STRING:"string",SECRET:"secret",INT:"int",FLOAT:"float",BOOLEAN:"boolean",JSON:"json",ARRAY:"array",FUNCTION:"function",ITERABLE:"iterable",VOID:"void",BLOCK:"BLOCK",VARIABLE_DECLARATION:"VARIABLE_DECLARATION",COND:"COND",WHILE:"WHILE",FOR:"FOR",ASSIGNMENT:"ASSIGNMENT",VARIABLE_REFERENCE:"VARIABLE_REFERENCE",ERROR:"ERROR",CLAUSE:"CLAUSE",FUNCTION_CALL:"FUNCTION_CALL",FUNCTION_DEFINITION:"FUNCTION_DEFINITION",FUNCTION_PARAMETER:"FUNCTION_PARAMETER",LITERAL:"LITERAL",STRUCT:"STRUCT",ENUM:"ENUM",MAP_NODE:"MAP_NODE",ARRAY_NODE:"ARRAY_NODE",RETURN:"RETURN",OPERATOR:"OPERATOR",OP_AND:"and",OP_OR:"or",OP_NOT:"not",DUPLICATE_DECLARATION:"duplicate_declaration",MISSING_ARGUMENT:"missing_argument",INVALID_SYNTAX:"invalid_syntax",TYPE_MISMATCH:"type_mismatch",UNDEFINED_TYPE:"undefined_type",INVALID_VARIABLE_NAME:"invalid_variable_name",INVALID_VARIABLE_REFERENCE:"invalid_variable_reference",INVALID_VARIABLE_TYPE:"invalid_variable_type",INVALID_FIELD_NAME:"invalid_field_name",CHANGE:"change",CONTEXT:"_context_",UNTITLED:"_untitled_",VALUE:"VALUE",NULL:"null",UNDEFINED:"undefined",UNKNOWN:"unknown"};const HOOK_EVENT={BEFORE_RUN:"beforeRun",BEFORE_EVAL:"beforeEval",AFTER_EVAL:"afterEval",AFTER_RUN:"afterRun"};function isValidFunctionDefinitionSyntax(e){if(!Array.isArray(e))return!1;if(4!==e.length)return!1;if("func"!==e[0])return!1;if("string"!=typeof e[1])return!1;if(!Array.isArray(e[2]))return!1;for(let t of e[2]){if(!Array.isArray(t))return!1;if(2!==t.length)return!1;if("string"!=typeof t[0])return!1;if("string"!=typeof t[1])return!1}return!0}function isValidLambdaSyntax(e){if(!Array.isArray(e))return!1;if(3!==e.length)return!1;if("lambda"!==e[0])return!1;if(!Array.isArray(e[1]))return!1;for(let t of e[1]){if(!Array.isArray(t))return!1;if(2!==t.length)return!1;if("string"!=typeof t[0])return!1;if("string"!=typeof t[1])return!1}return!0}function isValidVariableDeclarationSyntax(e){return Array.isArray(e)&&e.length>=3&&"var"===e[0]&&"string"==typeof e[1]&&"string"==typeof e[2]}function isDeclaration(e){return isVariableDeclaration(e)||isFunctionDefinition(e)}function isFunctionDefinition(e){return e instanceof FunctionDefinition}function isVariableDeclaration(e){return e instanceof VariableDeclaration}function getReferences(e){let t=e.parent,r=[];for(let n=t.nodes.indexOf(e)+1;n<t.nodes.length;n++)r.push(...getReferencesInExpr(t.nodes[n],e));return r}function getReferencesInExpr(e,t){let r=[];e instanceof VariableReference&&e._ref===t.name&&e.scope.get(e._ref)?.ref===t&&r.push(e);for(let n of e.children)r.push(...getReferencesInExpr(n,t));return r}function getParamReferences(e,t){return getReferencesInExpr(t.expression,e)}class ValidationScope extends EventEmitter{basicTypes=[C.STRING,C.SECRET,C.BOOLEAN,C.JSON,C.ARRAY,C.INT,C.FLOAT];parent;entries=new Map;constructor(e){super(),this.parent=e}clearVar(){for(let e of this.entries.keys())this.entries.get(e).type===C.VALUE&&this.entries.delete(e)}has(e){return this.entries.has(e)||this.parent?.has(e)||!1}hasBasicType(e){return this.basicTypes.includes(e)}hasEnum(e){return this.has(e)&&this.get(e).type===C.ENUM}hasFunc(e){return this.has(e)&&this.get(e).type===C.FUNCTION}hasStruct(e){return this.has(e)&&this.get(e).type===C.STRUCT}hasType(e){for(;isArrayType(e);)e=getArrayElementType(e);return this.hasEnum(e)||this.hasStruct(e)||this.hasBasicType(e)}hasVar(e){return this.has(e)&&"VALUE"===this.get(e).type}get(e){if(this.entries.has(e))return this.entries.get(e);if(this.parent?.has(e))return this.parent.get(e);throw new Error(`${e} not found`)}getBasicTypes(){return[...this.basicTypes]}getEnum(e){if(this.hasEnum(e))return this.get(e).value;throw new Error(`No Enum named: ${e}`)}getAllEnums(){let e=new Map;this.parent&&(e=this.parent.getAllEnums());for(let[t,r]of this.entries)r.type===C.ENUM&&e.set(t,r.value);return e}getFunc(e){if(this.hasFunc(e))return this.get(e).value;throw new Error(`No Function named: ${e}`)}getAllFuncs(){let e=new Map;this.parent&&(e=this.parent.getAllFuncs());for(let[t,r]of this.entries)r.type===C.FUNCTION&&e.set(t,r.value);return e}getStruct(e){if(this.hasStruct(e))return this.get(e).value;throw new Error(`No Struct named: ${e}`)}getAllStructs(){let e=new Map;this.parent&&(e=this.parent.getAllStructs());for(let[t,r]of this.entries)r.type===C.STRUCT&&e.set(t,r.value);return e}getVar(e){if(this.hasVar(e))return this.get(e).value;throw new Error(`No Variable named: ${e}`)}getAllVars(){let e=new Map;this.parent&&(e=this.parent.getAllVars());for(let[t,r]of this.entries)r.type===C.VALUE&&e.set(t,r.value);return e}setEnum(e,t){this.entries.set(e,{type:C.ENUM,value:t})}setFunc(e,t,r){this.entries.set(e,{type:C.FUNCTION,value:t,ref:r})}setStruct(e,t){this.entries.set(e,{type:C.STRUCT,value:t})}setVar(e,t,r){this.entries.set(e,{type:C.VALUE,value:t,ref:r})}}function parseBlock(e,t,r){if(!Array.isArray(e))throw new Error("Invalid statement list");const n=(t instanceof Root?t:t.root).allowNamedBlocks??!1;let a=!n||t instanceof Root||"block"!==e[0]||!e[1]?C.UNTITLED:e[1];return!n||t instanceof Root||"block"!==e[0]||(e=e[2]??[]),new Block(t,r,a,e)}function parseStatement(e,t,r){const n=t instanceof Root?t:t.root;if(Array.isArray(e)){if(0===e.length)throw new Error("Invalid statement");if("var"===e[0])return parseVariableDeclaration(e,t,r);if("cond"===e[0])return parseConditional(e,t,r);if("="===e[0])return parseAssignment(e,t,r);if("return"===e[0])return _parseReturn(e,t,r);if("for"===e[0])return parseForStatement(e,t,r);if("while"===e[0])return parseWhileStatement(e,t,r);if("func"===e[0])return parseFunctionDefinition(e,t,r);if(n.allowNamedBlocks&&"block"===e[0])return parseBlock(e,t,r)}return parseExpression(e,t,r)}function parseExpression(e,t,r){if(null==e)throw new Error("invalid expression");if("string"==typeof e&&"$"===e[0]){if(1===e.length)throw new Error(`Invalid expression: ${JSON.stringify(e)}`);return parseVariableReference(e,t,r)}if(Array.isArray(e)&&e.length>0&&"string"==typeof e[0]){if("ERROR"===e[0])return new ErrorExp(t,r,e[1]);if(e[0]===C.ARRAY)return parseArray(e,t,r);if("map"===e[0])return parseMap(e,t,r);if(["and","or","not"].includes(e[0]))return parseLogicalOperator(e,t,r);if("->"===e[0])return parseAccessor(e,t,r);if("secret"===e[0])return parseSecret(e,t,r);if(r.hasFunc(e[0]))return _parseFunctionCall(e,t,r);if(r.hasStruct(e[0]))return parseStruct(e,t,r);if(r.hasEnum(e[0]))return parseEnum(e,t,r);throw new Error(`Type ${e[0]} not found in scope`)}if(isPlainObject(e)||Array.isArray(e)&&"array"===e[0]||isPrimitive(e))return parseLiteral(e,t,r);throw new Error(`Invalid expression: ${JSON.stringify(e)}`)}function parseSecret(e,t,r){if(!Array.isArray(e)||2!==e.length||"string"!=typeof e[1])throw new Error("Invalid secret expression");return new Literal(t,r,e[1],{isSecret:!0})}function parseMap(e,t,r){if(3!==e.length||"map"!==e[0])throw new Error("Invalid map expression");return new MapExp(t,r,e[1],e[2])}function parseFunctionDefinition(e,t,r){if(!isValidFunctionDefinitionSyntax(e))throw new Error("Invalid function definition syntax");return new FunctionDefinition(t,r,e[1],e[2],e.slice(3))}function parseArray(e,t,r){if(3!==e.length||e[0]!==C.ARRAY||"string"!=typeof e[1]||!Array.isArray(e[2]))throw new Error("Invalid array expression");return new ArrayExp(t,r,e[1],e[2])}function parseStruct(e,t,r){if(!Array.isArray(e)||"string"!=typeof e[0]||e[1]&&!isPlainObject(e[1]))throw new Error("Invalid struct expression");if(!r.hasStruct(e[0]))throw new Error("Struct not found in registry");return new Struct(t,r,e[0],e[1])}function parseEnum(e,t,r){if(!Array.isArray(e)||"string"!=typeof e[0])throw new Error("Invalid enum expression");if(!r.hasEnum(e[0]))throw new Error("Enum not found in registry");return new Enum(t,r,e[0],e[1])}function parseVariableDeclaration(e,t,r){if(isValidVariableDeclarationSyntax(e)){if(r.hasType(e[2]))return new VariableDeclaration(t,r,e[1],e[2],e[3]);throw new Error("the variable declaration has an invalid type")}throw new Error("Invalid variable declaration syntax")}function parseConditional(e,t,r){if(!Array.isArray(e)||0===e.length||"cond"!==e[0])throw new Error("Invalid conditional statement");return new Conditional(t,r,e.slice(1))}function parseWhileStatement(e,t,r){if(!Array.isArray(e)||0===e.length||"while"!==e[0])throw new Error("Invalid while statement");return new While(t,r,e.slice(1))}function parseForStatement(e,t,r){if(!Array.isArray(e)||0===e.length||"for"!==e[0])throw new Error("Invalid for statement");return new For(t,r,e.slice(1))}function parseAssignment(e,t,r){if(!Array.isArray(e)||3!==e.length||"="!==e[0])throw new Error("Invalid assignment statement");return new Assignment(t,r,e[1],e[2])}function _parseReturn(e,t,r){if(!Array.isArray(e))throw new Error("Invalid return statement");return new Return(t,r,e[1])}function parseVariableReference(e,t,r){if("string"!=typeof e||0===e.length||"$"!==e[0])throw new Error("Invalid variable reference");return new VariableReference(t,r,e.slice(1))}function parseCallback(e,t,r){return"string"==typeof e&&e.length>1&&"$"===e[0]?parseVariableReference(e,t,r):parseLambda(e,t,r)}function parseLambda(e,t,r){if(!isValidLambdaSyntax(e))throw new Error("Invalid Lambda syntax");return new Lambda(t,r,e[1],e.slice(2))}function parseLiteral(e,t,r){if(!(isPrimitive(e)||Array.isArray(e)&&"array"===e[0]||isPlainObject(e)))throw new Error("Invalid literal");return new Literal(t,r,e)}function _parseFunctionCall(e,t,r){if(!Array.isArray(e)||0===e.length||"string"!=typeof e[0])throw new Error("Invalid function call");if(!r.hasFunc(e[0]))throw new Error("Function not found in scope");let n=e.length>1?e.slice(1):void 0;return new FunctionCall(t,r,e[0],n)}function parseLogicalOperator(e,t,r){if(!Array.isArray(e)||0===e.length||"string"!=typeof e[0])throw new Error("Invalid logical operator");if(e[0]===C.OP_NOT&&2!==e.length)throw new Error("NOT requires exactly one operand");const n=e.slice(1);return new LogicalOperator(t,r,e[0],n)}function parseAccessor(e,t,r){if(!Array.isArray(e)||0==e.length)throw new Error("Invalid Accessor");if(3!==e.length)throw new Error("Accessor requires exactly two operands");const n=e.slice(1);return new Accessor(t,r,e[0],n)}class Declarations extends EventEmitter{_params;_root;get length(){return this._params.length}get list(){return[...this._params]}get names(){return this._params.map((e=>e.name))}constructor(e,t=[]){super(),this._root=e,this._params=[];for(let e of t)this.add(e)}emitChange(){this.emit("change"),this._root.emit("change")}add(e){if(this.names.some((t=>t===e.name)))throw new Error(`Param with name "${e.name}" already exists`);if(!isValidName(e.name))throw new Error(`Invalid param name "${e.name}"`);this._params.push({...e}),this.emitChange()}changeType(e,t){const r=this.get(e);r.dataType!==t&&(r.dataType=t,this.emitChange())}get(e){if(!this.has(e))throw new Error(`Param name "${e}" is not found.`);return this._params.find((t=>t.name===e))}has(e){return this._params.findIndex((t=>t.name===e))>-1}remove(e){let t=this._params.findIndex((t=>t.name===e));if(t<0)throw new Error(`Param name "${e}" not found`);this._params.splice(t,1),this.emitChange()}rename(e,t){if(e===t)return;if(this.has(t))throw new Error(`Param name "${t}" already exists`);if(!isValidName(t))throw new Error(`Invalid name "${t}" for param`);let r=this.get(e);getParamReferences(r,this._root).forEach((e=>{e._ref=t,e.emitChange()})),r.name=t,this.emitChange()}toJSON(){return structuredClone(this._params)}}const NodeTypes=[C.BLOCK,C.VARIABLE_DECLARATION,C.COND,C.ASSIGNMENT,C.VARIABLE_REFERENCE,C.ERROR,C.CLAUSE,C.FUNCTION_CALL,C.LITERAL,C.STRUCT,C.ENUM,C.MAP_NODE,C.ARRAY_NODE,C.OPERATOR],ErrorCodes=[C.DUPLICATE_DECLARATION,C.MISSING_ARGUMENT,C.INVALID_SYNTAX,C.TYPE_MISMATCH,C.UNDEFINED_TYPE,C.INVALID_VARIABLE_NAME,C.INVALID_VARIABLE_REFERENCE,C.INVALID_VARIABLE_TYPE,C.INVALID_FIELD_NAME];class Root extends EventEmitter{allowNamedBlocks;expression;declarations;registry;scope=new ValidationScope;constructor(e,t,r){super(),this.registry=e,this.allowNamedBlocks=r?.allowNamedBlocks??!1,this.declarations=new Declarations(this,r?.declarations??[]);const n=r?.sourceType??C.BLOCK;for(let t in e.enums)this.scope.setEnum(t,e.enums[t]);for(let t in e.structs)this.scope.setStruct(t,e.structs[t]);for(let t in e.funcs)this.scope.setFunc(t,e.funcs[t]);this.updateScope(),this.declarations.on("change",this.updateScope),Array.isArray(t)||(t=[t]),n===C.BLOCK?this.expression=parseBlock(t,this,this.scope):this.expression=parseStatement(t,this,this.scope)}emitChange(e){this.emit(C.CHANGE,e)}async evaluate(e){let t;await e.runHooks(HOOK_EVENT.BEFORE_RUN);try{const t=e.appendNewInterruptPromise();return await Promise.race([t,this.expression.evaluate(e)])}catch(r){if(r instanceof ReturnMarker)return r.data;t=r;const n=e.observer.expressionStack.at(-1);throw StackedError.handle(r,"node",{path:n?.path(),name:n?.title})}finally{e.interruptPromises.pop(),await e.runHooks(HOOK_EVENT.AFTER_RUN,{error:t})}}getAll(){let e=[];e.push(this.expression);for(let t of e)e.push(...t.children);return e}hasErrors(){return this.getAll().some((e=>e instanceof ErrorExp||e.error instanceof ErrorExp))}getErrorNodes(){return this.getAll().filter((e=>e instanceof ErrorExp||e.error instanceof ErrorExp))}getNode(e){let t=this.expression;for(const r of e)t=t.children[r];return t}toJSON(){if(this.hasErrors())throw new Error("Cannot serialize tree with errors");return this.expression.toJSON()}onRenameVar(e){this.updateScope()}updateScope=()=>{this.scope.clearVar();for(let e of this.declarations.list)this.scope.setVar(e.name,{name:e.name,dataType:e.dataType},e);this.expression?.scopeChange(this.scope)};replace(e){this.expression=parseBlock(e,this,this.scope),this.emitChange(this.expression)}}class Expression extends EventEmitter{type;parent;scope;error;get root(){let e=this.parent;for(;!(e instanceof Root);)e=e.parent;return e}get returnType(){return C.UNKNOWN}get title(){return this.type}constructor(e,t,r){super(),this.type=e,this.parent=t,this.scope=r}emitChange(e=this){this.emit(C.CHANGE,e),this.parent?.emitChange(e)}async evaluate(e,...t){let r;await e.runHooks(HOOK_EVENT.BEFORE_EVAL,{node:this});try{const r=e.appendNewInterruptPromise();return await Promise.race([r,this._evaluate(e,...t)])}catch(e){throw r=e,r}finally{e.interruptPromises.pop(),await e.runHooks(HOOK_EVENT.AFTER_EVAL,{node:this,error:r})}}scopeChange(e){this.scope=e;for(let t of this.children)t.scopeChange(e)}path(){const e=(t,r)=>{if(t.parent instanceof Root)return r;const n=t.parent.children.indexOf(t);return r.unshift(n),e(t.parent,r)};return e(this,[])}}class Operator extends Expression{name;operands=[];get children(){return[...this.operands]}get title(){return this.name}constructor(e,t,r,n){super(C.OPERATOR,e,t),this.name=r,this.operands=this.parse(n)}parse(e){return e.map((e=>parseExpression(e,this,this.scope)))}insertAt(e,t){const r=parseExpression(t,this,this.scope);this.operands.splice(e,0,r),this.emitChange(),this.emit("child_addition",r)}remove(e){const t=this.operands.indexOf(e);if(-1===t)throw new Error("Operand not found in the list");this.operands.splice(t,1),this.emitChange()}replace(e,t){let r=this.children.indexOf(e);if(r<0)throw new Error("No child matching the given node");this.operands[r]=parseExpression(t,this,this.scope),this.emitChange()}}class LogicalOperator extends Operator{get returnType(){return C.BOOLEAN}async _evaluate(e){switch(this.name){case C.OP_AND:return await this.and(e);case C.OP_OR:return await this.or(e);case C.OP_NOT:return await this.not(e)}}async and(e){for(const t of this.operands){if(!await t.evaluate(e))return!1}return!0}async or(e){for(const t of this.operands){if(await t.evaluate(e))return!0}return!1}async not(e){return!await this.operands[0].evaluate(e)}insertAt(e,t){if(this.name===C.OP_NOT)throw new Error("Error: Cannot perform 'insertAt' operation on a NOT operator");super.insertAt(e,t)}remove(e){if(this.name===C.OP_NOT)throw new Error("Error: Cannot perform 'replace' operation on a NOT operator");super.remove(e)}parse(e){const t=[];for(let r=0;r<e.length;r++){let n=parseExpression(e[r],this,this.scope);if(!(n instanceof ErrorExp)&&n.returnType!==C.BOOLEAN){let e;e=n instanceof FunctionCall?`${n.name} returns ${n.returnType}`:n instanceof Literal?`${n.value} is of type ${n.returnType}`:`Got type ${n.returnType}`;throw new Error(`Error: Type Mismatch - ${e} expected boolean`)}t.push(n)}return t}toJSON(){return[this.name,...this.operands.map((e=>e.toJSON()))]}}class Accessor extends Operator{get returnType(){const e=this.scope.get(this.operands[0].returnType).value,t=this.operands[1].value;return e.fields[t]?e.fields[t].types[0]:C.UNKNOWN}async _evaluate(e){return(await this.operands[0].evaluate(e))[await this.operands[1].evaluate(e)]}insertAt(){throw new Error("Cannot perform 'insertAt' operation on a Accessor operator")}replace(e,t){const r=this.children.indexOf(e);if(r<0)throw new Error("No child matching the given node");const n=parseExpression(t,this,this.scope);let a,s,i;if(0===r){if(a=n.returnType,!this.scope.hasStruct(a))throw new Error(`${a} cannot be assigned to a struct`);i=this.operands[1].value}else{if(n.returnType!==C.STRING)throw new Error(`Field name must be a string got ${n.returnType}`);a=this.operands[0].returnType,i=n.value}s=this.scope.get(a).value,s.fields[i]?this.error&&(this.error=void 0):this.error=new ErrorExp(this,this.scope,C.INVALID_FIELD_NAME,`Field ${i} does not exist on struct ${a}`),this.operands[r]=n,this.emitChange()}parse(e){const t=super.parse(e);if(!(this.scope.hasStruct(t[0].returnType)||t[0]instanceof Struct))throw new Error("Left hand side must return a struct");if(!(t[1]instanceof Literal&&t[1].returnType==C.STRING))throw new Error("Right hand side must be a string");const r=t[0].returnType,n=this.scope.get(r).value,a=t[1].value;return n.fields[a]||(this.error=new ErrorExp(this,this.scope,C.INVALID_FIELD_NAME,`Field ${a} does not exist on struct ${r}`)),t}toJSON(){return["->",this.operands[0].toJSON(),this.operands[1].toJSON()]}}class Block extends Expression{_name;nodes=[];get name(){return this._name}set name(e){if(!isValidName(e))throw new Error("Invalid name for Block");this._name=e}constructor(e,t,r,n){super(C.BLOCK,e,t),this.scope=t,this._name=r,n?.forEach((e=>{let t,r=this.getScope(this.nodes.length);try{t=parseStatement(e,this,r)}catch(e){console.error(e),t=new ErrorExp(this,r,C.INVALID_SYNTAX,e.message)}this.nodes.push(t)})),this.emitChange()}get children(){return[...this.nodes]}clear(){this.nodes=[],this.emitChange()}async _evaluate(e){let t;e.scopeStack.push(),this.name!==C.UNTITLED&&e.scopeStack.set(C.CONTEXT,this.name);for(let r of this.nodes)t=await r.evaluate(e);return e.scopeStack.pop(),t}getScope(e){let t=new ValidationScope(this.scope);this.parent instanceof _FuncDef&&this.parent.parameters.forEach((e=>t.setVar(e.name,{name:e.name,dataType:e.dataType},e)));for(let r=0;r<e;r++){let e=this.nodes[r];isVariableDeclaration(e)?t.setVar(e.name,{name:e.name,dataType:e.dataType},e):isFunctionDefinition(e)&&t.setFunc(e.name,{name:e.name,args:Object.fromEntries(e.parameters.map((e=>[e.name,{types:[e.dataType]}]))),returnType:e.returnType,fn:()=>()=>{}},e)}return t}remove(e){let t=this.nodes.indexOf(e);if(-1===t)throw new Error("Node not found in the list");this.nodes.splice(t,1),this.updateScope(t),this.emitChange()}insertAt(e,t){let r=parseStatement(t,this,this.getScope(e));if(isDeclaration(r)&&this.nodes.some((e=>isDeclaration(e)&&e.name===r.name)))throw new Error("Declaration with same name already exists in current block");this.nodes.splice(e,0,r),this.updateScope(e+1),this.emitChange(),this.emit("child_addition",r)}replace(e,t){let r=this.nodes.indexOf(e);if(-1===r)throw new Error("Node not found in the list");let n=parseStatement(t,this,this.getScope(r));if(isDeclaration(n)&&this.nodes.some((e=>isDeclaration(e)&&e.name===n.name)))throw new Error("Declaration with same name already exists in current block");this.nodes[r]=n,this.updateScope(r+1),this.emitChange()}scopeChange(e){this.scope=e;let t=this.children;for(let e=0;e<t.length;e++)t[e].scopeChange(this.getScope(e))}toJSON(){let e=this.nodes.map((e=>e.toJSON()));return!this.root.allowNamedBlocks||this.parent instanceof Root?e:["block",this.name,e]}onRenameVar(e){this.updateScope(this.nodes.indexOf(e)+1)}updateScope(e){for(let t=e;t<this.nodes.length;t++)this.nodes[t].scopeChange(this.getScope(t))}}class Literal extends Expression{_value;_returnType;get children(){return[]}get returnType(){return this._returnType}get value(){return this._value}set returnType(e){this._returnType=e}set value(e){this._value=e,this.emitChange()}constructor(e,t,r,n){super(C.LITERAL,e,t),this._returnType=getLiteralType(r),"string"===this._returnType&&(r=unEscapeDollar(r)),n?.isSecret&&(this._returnType="secret"),this._value=r}async _evaluate(e){return this.value}toJSON(){return"string"===this.returnType?escapeDollar(this.value):"secret"===this.returnType?["secret",escapeDollar(this.value)]:this.value}}class ArrayExp extends Expression{_value;_elementType;get children(){return[...this._value]}get returnType(){return"array<"+this._elementType+">"}get value(){return this._value}get elementType(){return this._elementType}onChange=e=>{e instanceof Accessor&&-1!==this.children.indexOf(e)&&(e.returnType!==this.elementType?this.error=new ErrorExp(this,this.scope,C.TYPE_MISMATCH,`${this.returnType} cannot have ${e.returnType} as an element`):this.error&&(this.error=void 0))};constructor(e,t,r,n){super(C.ARRAY_NODE,e,t),this._elementType=r;let a=n.map((e=>parseExpression(e,this,this.scope)));if(a.some((e=>e.returnType!==this._elementType)))throw new Error("One or more of the array elements are of different type from the array's declared element type");this._value=a,this.on(C.CHANGE,this.onChange)}async _evaluate(e){let t=[];for(let r of this.value)t.push(await r.evaluate(e));return t}async replace(e,t){let r=this.children.indexOf(e);if(r<0)throw new Error("No child matching the given node");let n=this.parse(t);n.returnType!==this.elementType&&(n=castToTypeOrError(n,[this.elementType])),this._value[r]=n,this.emitChange()}parse(e){return parseExpression(e,this,this.scope)}toJSON(){return["array",this._elementType,this.value.map((e=>e.toJSON()))]}}class Struct extends Expression{name;fields;get children(){return[...this.fields.values()]}get returnType(){return this.name}get(e){return this.fields.get(e)}has(e){return this.fields.has(e)}onChange=e=>{if(e instanceof Accessor)for(let[t,r]of this.fields)if(r===e){const r=this.scope.getStruct(this.name).fields[t];r.types.includes(e.returnType)?this.error&&(this.error=void 0):this.error=new ErrorExp(this,this.scope,C.TYPE_MISMATCH,`Field of type ${r.types} cannot be assigned a ${e.returnType}`)}};constructor(e,t,r,n){if(super(C.STRUCT,e,t),!this.scope.hasStruct(r))throw new Error(`Struct ${r} not defined in scope`);this.name=r,this.fields=n?this.prepare(n):this.getDefaults(r),this.on(C.CHANGE,this.onChange)}async _evaluate(e){let t={};if([...this.fields.values()].some((e=>e instanceof ErrorExp)))throw new Error("StructNode has an error in one of its fields");for(let[r,n]of this.fields)t[r]=await n.evaluate(e);return t}getDefaults(e){let t=this.scope.getStruct(e).fields,r=new Map;for(let e in t)t[e].optional||r.set(e,getDefault(this,this.scope,t[e]));return r}prepare(e){let t=new Map,r=this.scope.getStruct(this.name).fields;for(let n in r)if(n in e){let a=parseExpression(e[n],this,this.scope),s=r[n].types;s.includes(a.returnType)||(a=castToTypeOrError(a,s)),t.set(n,a)}else if(!r[n].optional)throw new Error(`Missing field ${n}`);return t}removeOptional(e){let t=this.scope.getStruct(this.name).fields;for(let[r,n]of this.fields)if(n===e){if(t[r].optional)return this.fields.delete(r),void this.emitChange();throw new Error("Cannot remove non-optional field")}throw new Error("Child not found in fields")}replace(e,t){for(let[r,n]of this.fields)if(n===e)return void this.set(r,t);throw new Error("oldChild not found in fields")}set(e,t){let r=this.scope.getStruct(this.name).fields;if(!r.hasOwnProperty(e))throw new Error("No field with that name");let n=parseExpression(t,this,this.scope),a=r[e].types;a.includes(n.returnType)||(n=castToTypeOrError(n,a)),this.fields.set(e,n),this.emitChange()}setAllOptional(){let e=this.scope.getStruct(this.name).fields;for(let t in e)this.fields.has(t)||this.fields.set(t,getDefault(this,this.scope,e[t]));this.emitChange()}toJSON(){let e={};for(let[t,r]of this.fields)e[t]=r.toJSON();return e}}class Enum extends Expression{name;_value;get value(){return this._value}set value(e){this._value=e,this.emitChange()}get children(){return[]}get returnType(){return this.name}constructor(e,t,r,n){if(super(C.ENUM,e,t),!this.scope.hasEnum(r))throw new Error(`Enum ${r} not found in registry`);if(this.name=r,this._value=this.checkValidity(n)?n:this.getDefaults(r),!this.scope.getEnum(r).values.includes(this.value))throw new Error(`Invalid enum value: ${this.value}`)}checkValidity(e){let t=this.scope.getEnum(this.name);return typeof e===t.enumType&&t.values.includes(e)}async _evaluate(e){return this.value}getDefaults(e){return this.scope.getEnum(e).values[0]}toJSON(){return this.value}}class Return extends Expression{_value;constructor(e,t,r){super(C.RETURN,e,t),this._value=this.parse(r)}get children(){return this._value?[this._value]:[]}get value(){return this._value}replace(e,t){if(e!==this._value)throw new Error("No child matching the given node");this._value=this.parse(t),this.emitChange()}parse(e){if(void 0===e)return;return parseExpression(e,this,this.scope)}async _evaluate(e){let t;throw this._value&&(t=await this._value.evaluate(e)),new ReturnMarker(t)}toJSON(){return["return",this._value?.toJSON()]}}class FunctionCall extends Expression{name;argList=[];get children(){return[...this.argList]}get returnType(){return this.scope.getFunc(this.name).returnType}get title(){return this.name}onChange=e=>{if(!(e instanceof Accessor))return;const t=this.argList.indexOf(e);if(-1===t)return;const r=this.scope.getFunc(this.name),n=Object.values(r.args)[t];if(n.types.includes(e.returnType))this.error&&(this.error=void 0);else try{castToTypeOrError(e,n.types)}catch(t){this.error=new ErrorExp(this,this.scope,C.TYPE_MISMATCH,`Field of type ${e.returnType} cannot be assigned to arg of type ${n.types}`)}};constructor(e,t,r,n){if(super(C.FUNCTION_CALL,e,t),!this.scope.hasFunc(r))throw new Error(`Func ${r} not defined in scope`);this.name=r,this.argList=n?this.prepare(n):this.getDefaults(r),this.on(C.CHANGE,this.onChange)}async _evaluate(e){let t=[];for(let r of this.argList)t.push(await r.evaluate(e));let r=e.scopeStack.get(this.name);return e.scopeStack.isFromRegistry(this.name)?await r(e.context,...t):await r(e,...t)}getDefaults(e){let t=this.scope.getFunc(e);return Object.values(t.args).filter((e=>!e.optional)).map((e=>getDefault(this,this.scope,e)))}prepare(e){let t=this.scope.getFunc(this.name),r=[],n=Object.keys(t.args);for(let a=0;a<n.length;a++){let s=t.args[n[a]];if(a<e.length){let t=parseExpression(e[a],this,this.scope);t instanceof ErrorExp||s.types.includes(t.returnType)||(t=castToTypeOrError(t,s.types)),r.push(t)}else if(!s.optional)throw new Error(`Missing argument at position ${a}`)}return r}removeOptional(e){let t=this.argList.indexOf(e);if(-1===t)throw new Error("Child not found in argList");let r=this.scope.getFunc(this.name);if(!Object.values(r.args)[t].optional)throw new Error("Argument is not optional");for(let e=this.argList.length-1;e>=t;e--)this.argList.pop();this.emitChange()}replace(e,t){let r=this.argList.indexOf(e);if(-1===r)throw new Error("oldChild is not an argument of this function call");let n=this.scope.getFunc(this.name),a=Object.values(n.args)[r],s=parseExpression(t,this,this.scope);a.types.includes(s.returnType)?this.argList[r]=s:this.argList[r]=castToTypeOrError(s,a.types),this.emitChange()}addNextOptional(e){let t=this.scope.getFunc(this.name),r=Object.values(t.args);if(!(r.length>this.argList.length))throw new Error("All optional arguments are already set");{let t=r[this.argList.length],n=e?parseExpression(e,this,this.scope):getDefault(this,this.scope,t);t.types.includes(n.returnType)||(n=castToTypeOrError(n,t.types)),this.argList.push(n),this.emitChange()}}setAllOptional(){let e=this.scope.getFunc(this.name),t=Object.values(e.args);for(let e=this.argList.length;e<t.length;e++){let r=t[e];this.argList.push(getDefault(this,this.scope,r))}this.emitChange()}toJSON(){return[this.name,...this.argList.map((e=>e.toJSON()))]}}class Conditional extends Expression{clauses;get children(){return[...this.clauses]}constructor(e,t,r){super(C.COND,e,t),this.clauses=r&&r.length>0?this.prepare(r):this.getDefaults()}async _evaluate(e){for(let t of this.clauses){let{status:r,value:n}=await t.evaluate(e);if(r)return n}}getDefaults(){return[new Clause(this,this.scope)]}insertAt(e){this.clauses.splice(e,0,new Clause(this,this.scope,["or",["and",!0]],[])),this.emitChange()}prepare(e){let t=[];for(let r of e){let e,n=r[0];e=this.root.allowNamedBlocks&&Array.isArray(r[1])&&"block"===r[1][0]?r[1]:r.slice(1),t.push(new Clause(this,this.scope,n,e))}return t}remove(e){let t=-1;for(let r=0;r<this.clauses.length;r++)if(this.clauses[r]===e){t=r;break}t>-1&&(this.clauses.splice(t,1),this.emitChange())}replace(e,t){let r=new Clause(this,this.scope,...t);for(let t=0;t<this.clauses.length;t++)if(this.clauses[t]===e)return this.clauses[t]=r,void this.emitChange();throw new Error("Node not found in the list")}toJSON(){return["cond",...this.clauses.map((e=>e.toJSON()))]}}class For extends Expression{itemVar;body;iterable;get children(){return[this.iterable,this.itemVar,this.body]}constructor(e,t,r){if(super(C.FOR,e,t),!r)throw new Error("expected block for for loop");if(!r[0])throw new Error("expected var name");if(!r[1])throw new Error("expected iterable");if(!r[2])throw new Error("expected body for for loop");this.iterable=parseExpression(r[1],this,this.scope),this.itemVar=new VariableDeclaration(this,this.scope,r[0],this.getItemType(this.iterable.returnType)),this.itemVar.setDeclarationOnly();let n=this.getForScope(this.scope);this.body=parseBlock(r[2],this,n)}getItemType(e){if(isIterableType(e))return getIterableElementType(e);if(isArrayType(e))return getArrayElementType(e);if(this.scope.hasStruct(e)){const t=this.scope.getStruct(e);if(void 0===t.iterator)throw new Error(`Type ${t.name} is not iterable`);return t.iterator.type}if(this.scope.hasEnum(e)){const t=this.scope.getEnum(e);if(void 0===t.iterator)throw new Error(`Type ${t.name} is not iterable`);return t.iterator.type}throw new Error(`type ${e} is not iterable`)}getForScope(e){const t=new ValidationScope(e),r=this.getItemType(this.iterable.returnType);return t.setVar(this.itemVar.name,{name:this.itemVar.name,dataType:r},this.itemVar),t}async _evaluate(e){const t=this.iterable.returnType;let r;if(isArrayType(t))r=await this.iterable.evaluate(e);else if(isIterableType(t))r=await this.iterable.evaluate(e);else{const t=this.scope.get(this.iterable.returnType).value;let n=await this.iterable.evaluate(e);r=await t.iterator.iter(e.context,n)}for(let t of r)e.scopeStack.push(),e.scopeStack.set(this.itemVar.name,t),await this.body.evaluate(e),e.scopeStack.pop()}onRenameVar(e){this.updateScope(this.scope)}updateScope(e){this.iterable.scopeChange(e);const t=this.getForScope(e);this.body.scopeChange(t),this.emitChange()}scopeChange(e){this.updateScope(e)}replace(e,t){this.iterable=parseExpression(t,this,this.scope),this.updateScope(this.scope)}toJSON(){let e;return e=this.iterable instanceof Struct||this.iterable instanceof Enum?[this.iterable.name,this.iterable.toJSON()]:this.iterable.toJSON(),["for",this.itemVar.name,e,this.body.toJSON()]}}class While extends Expression{condition;body;get children(){return[this.condition,this.body]}constructor(e,t,r){if(super(C.WHILE,e,t),!r)throw new Error("expected block for while loop");if(!r[0])throw new Error("expected condition");if(!r[1])throw new Error("expected block");this.condition=parseExpression(r[0],this,this.scope),this.body=parseBlock(r[1],this,this.scope)}async _evaluate(e){for(;await this.condition.evaluate(e);)await this.body.evaluate(e)}toJSON(){return["while",this.condition.toJSON(),this.body.toJSON()]}}class Clause extends Expression{condition;body;get children(){return[this.condition,this.body]}constructor(e,t,r,n){if(super(C.CLAUSE,e,t),this.condition=parseExpression(r??["or",["and",!0]],this,this.scope),"boolean"!==this.condition.returnType)throw new Error("Condition must return a boolean value");this.body=parseBlock(n??[],this,this.scope)}async _evaluate(e){return await this.condition.evaluate(e)?{status:!0,value:await this.body.evaluate(e)}:{status:!1}}replace(e,t){if(this.condition!==e)throw new Error("No child matching the given node");this.condition=parseExpression(t,this,this.scope),this.emitChange()}toJSON(){let e=this.body.toJSON();return this.root.allowNamedBlocks?[this.condition.toJSON(),e]:[this.condition.toJSON(),...e]}}class VariableDeclaration extends Expression{name;dataType;value;declarationOnly=!1;get children(){return this.declarationOnly?[]:[this.value]}constructor(e,t,r,n,a){super(C.VARIABLE_DECLARATION,e,t),this.validateName(r),this.name=r,this.dataType=n??C.INT,this.value=this.parse(a)??getDefault(this,this.scope,{types:[this.dataType]})}setDeclarationOnly(){this.declarationOnly=!0}changeType(e){if(e===this.dataType)return;this.dataType=e,this.value=getDefault(this,this.scope,{types:[e]});const t=this.parent;t.updateScope(t.nodes.indexOf(this)+1),this.emitChange()}async _evaluate(e){let t=await this.value.evaluate(e);return e.scopeStack.set(this.name,t),t}getDefaults(e){let t=e.type??C.STRING;return{name:"_",type:t,value:getDefault(this,this.scope,{types:[t]})}}parse(e){if(void 0===e)return;let t=parseExpression(e,this,this.scope);return t.returnType!==this.dataType&&(t=castToTypeOrError(t,this.dataType)),t}validateName(e){if(!isValidName(e,{allowFirstUnderscore:!0}))throw new Error("Invalid name for VariableDeclaration");if(this.scope.hasType(e))throw new Error("the variable declaration has the same name as a registered type")}rename(e){if(this.parent.children.some((t=>(t instanceof VariableDeclaration||t instanceof FunctionDefinition)&&t.name===e)))throw new Error("Variable with same name already exists in current scope");if(this.validateName(e),this.parent instanceof Root)throw new Error("Cannot rename variable in root");let t;t=this.parent instanceof Block?getReferences(this):getReferencesInExpr(this.parent,this),t.forEach((t=>{t._ref=e,t.emitChange()})),this.name=e;this.parent.onRenameVar(this),this.emitChange()}replace(e,t){if(e!==this.value)throw new Error("No child matching the given node");let r=parseExpression(t,this,this.scope);r.returnType!==this.dataType&&(r=castToTypeOrError(r,this.dataType)),this.value=r,this.emitChange()}scopeChange(e){this.scope=e;let t=this.parent,r=t.children.slice(0,t.children.indexOf(this)).some((e=>isDeclaration(e)&&e.name===this.name));!this.error&&r?(this.error=new ErrorExp(this,this.scope,C.DUPLICATE_DECLARATION),this.emit("change")):this.error&&!r&&(this.error=void 0,this.emit("change")),super.scopeChange(e)}toJSON(){let e=["var",this.name,this.dataType];return this.value&&e.push(this.value.toJSON()),e}}class VariableReference extends Expression{_ref;get children(){return[]}get name(){return this._ref}get returnType(){let e=this.scope.get(this._ref);return e.type===C.VALUE?e.value.dataType:e.type}constructor(e,t,r){if(super(C.VARIABLE_REFERENCE,e,t),!this.scope.has(r))throw new Error(`"${r}" is not a valid identifier`);this._ref=r}async _evaluate(e){if(e.scopeStack.has(this._ref))return e.scopeStack.get(this._ref);throw new Error(`"${this._ref}" is not a valid identifier`)}scopeChange(e){this.scope=e,this.scope.hasVar(this.name)?this.error?.code===C.INVALID_VARIABLE_REFERENCE&&(this.error=void 0,this.emit("change")):this.error?.code!==C.INVALID_VARIABLE_REFERENCE&&(this.error=new ErrorExp(this,this.scope,C.INVALID_VARIABLE_REFERENCE),this.emit("change")),this.error?.code!==C.INVALID_VARIABLE_REFERENCE&&(isMatchingType(this)?this.error?.code===C.TYPE_MISMATCH&&(this.error=void 0,this.emit("change")):this.error?.code!==C.TYPE_MISMATCH&&(this.error=new ErrorExp(this,this.scope,C.TYPE_MISMATCH),this.emit("change"))),super.scopeChange(e)}toJSON(){return"$"+this.name}}class Assignment extends Expression{reference;value;get children(){return[this.reference,this.value]}constructor(e,t,r,n){super(C.ASSIGNMENT,e,t),this.reference=parseVariableReference(r,this,t),this.value=this.parseValue(n)}async _evaluate(e){let t=await this.value.evaluate(e),r=this.reference.name;return e.scopeStack.update(r,t),t}parseValue(e){if(void 0===e)return getDefault(this,this.scope,{types:[this.reference.returnType]});{let t=parseExpression(e,this,this.scope);return t.returnType!==this.reference.returnType&&(t=castToTypeOrError(t,this.reference.returnType)),t}}replace(e,t){let r=parseExpression(t,this,this.scope);if(e===this.reference){if(!(r instanceof VariableReference))throw new Error("the new value is not of type VariableReference");this.reference=r,this.reference.returnType!==this.value.returnType&&(this.value=getDefault(this,this.scope,{types:[this.reference.returnType]}))}else{if(e!==this.value)throw new Error("No child matching the given node");r.returnType!==this.reference.returnType&&(r=castToTypeOrError(r,this.reference.returnType)),this.value=r}this.emitChange()}toJSON(){return["=",this.reference.toJSON(),this.value.toJSON()]}}class _FuncDef extends Expression{parameters=[];body;get children(){return[...this.parameters,...this.body.nodes]}get returnType(){return this.body.nodes[this.body.nodes.length-1].returnType}constructor(e,t,r,n,a){if(super(r,e,t),new Set(n.map((e=>e[0]))).size!==n.length)throw new Error("Duplicate argument names in function definition");this.parameters=n.map((([e,t])=>new VariableDeclaration(this,this.scope,e,t))),this.body=parseBlock(a,this,this.scope),this.evaluate=this.evaluate.bind(this)}async _evaluate(e,...t){e.scopeStack.push();for(let r=0;r<t.length;r++)e.scopeStack.set(this.parameters[r].name,t[r]);let r=await this.body.evaluate(e);return e.scopeStack.pop(),r}}class Lambda extends _FuncDef{constructor(e,t,r,n){super(e,t,"LAMBDA",r,n)}toJSON(){return["lambda",this.parameters.map((e=>e.toJSON())),this.returnType,this.body.toJSON()]}}class FunctionDefinition extends _FuncDef{name;constructor(e,t,r,n,a){super(e,t,"FUNCTION_DEFINITION",n,a),this.name=r}call=async(e,...t)=>await super._evaluate(e,...t);toJSON(){return["func",this.name,this.parameters.map((e=>e.toJSON())),this.returnType,this.body.toJSON()]}async _evaluate(e){e.scopeStack.set(this.name,this.call)}}class MapExp extends Expression{list;callback;constructor(e,t,r,n){super(C.MAP_NODE,e,t);let a=parseExpression(r,this,this.scope);if(!isArrayType(a.returnType))throw new Error("First argument must be an array");this.list=a;let s=parseCallback(n,this,this.scope);if(!(s instanceof Lambda)&&"function"!==s.returnType)throw new Error("Callback must be a function definition or a variable reference");this.verifyListCallbackMatch(s),this.callback=s}get children(){return[this.list,this.callback]}async _evaluate(e){let t,r=await this.list.evaluate(e);t=this.callback instanceof VariableReference?e.scopeStack.get(this.callback.name):this.callback.evaluate;let n=[];for(let a of r)n.push(await t(e,a));return n}get returnType(){return"array:"+this.callback.returnType}toJSON(){return["map",this.list.toJSON(),this.callback.toJSON()]}verifyListCallbackMatch(e){let t,r;if(t=e instanceof VariableReference?Object.keys(this.scope.getFunc(e.name).args).length:e.parameters.length,1!==t)throw new Error("A Map Callback must have exactly one argument");if(r=e instanceof VariableReference?Object.values(this.scope.getFunc(e.name).args)[0].types:[e.parameters[0].dataType],!r.includes(this.list.returnType.slice(6,-1)))throw new Error("List and callback must have matching types")}}class ErrorExp extends Expression{code;description;get children(){return[]}constructor(e,t,r,n){super(C.ERROR,e,t),this.code=r,this.description=n}async _evaluate(e){throw new Error("Error: "+this.code)}toJSON(){return["ERROR",this.code]}}class ReturnMarker{data;constructor(e){this.data=e}}function castToTypeOrError(e,t){t=Array.isArray(t)?t:[t];for(const r of t)try{if(e.returnType===C.INT&&r===C.FLOAT)return e instanceof Literal&&(e.returnType=C.FLOAT),e;if(!(e instanceof Literal))continue;if(e.scope.hasStruct(r)&&e.returnType===C.JSON)return parseStruct([r,e.value],e.parent,e.scope);if(e.scope.hasEnum(r)&&(e.returnType===C.STRING||e.returnType===C.INT||e.returnType===C.FLOAT))return parseEnum([r,e.value],e.parent,e.scope);if(e.returnType===C.INT&&r===C.FLOAT){const t=e.value;if(!Number.isInteger(t))continue;const r=new Literal(e.parent,e.scope,t);return r.returnType=C.FLOAT,r}}catch(e){}throw new Error(`the node: ${JSON.stringify(e.toJSON())}, couldn't be cast to one of the types expected: "${JSON.stringify(t)}"`)}function escapeDollar(e){return e.replace(/^\$/g,"\\$")}function getArrayElementType(e){return e.slice(6,-1)}function getIterableElementType(e){return e.slice(9,-1)}function getDefault(e,t,r){if(void 0!==r.default){let n=parseExpression(r.default,e,t);return r.types.includes(n.returnType)||(n=castToTypeOrError(n,r.types)),n}let n=r.types[0];if(n.startsWith(C.ARRAY))return new ArrayExp(e,t,n.slice(6,-1),[]);if(t.hasStruct(n))return new Struct(e,t,n);if(t.hasEnum(n))return new Enum(e,t,n,t.getEnum(n).values[0]);if(t.hasFunc(n))return new FunctionCall(e,t,n);if([C.STRING,C.SECRET,C.BOOLEAN,C.JSON,C.INT,C.FLOAT].includes(n)){const r=new Literal(e,t,getDefaultPrimitive(n));return r.returnType=n,r}throw new Error(`Type ${n} not found in scope`)}function getDefaultPrimitive(e){switch(e){case C.INT:case C.FLOAT:return 0;case C.STRING||C.SECRET:return"";case C.BOOLEAN:return!1;case C.JSON:return{};default:throw new Error(`Unknown primitive type ${e}`)}}function getLiteralType(e){if(isPlainObject(e))return C.JSON;if("string"==typeof e)return C.STRING;if("number"==typeof e)return Number.isInteger(e)?C.INT:C.FLOAT;if("boolean"==typeof e)return C.BOOLEAN;throw new Error("Unknown literal type "+typeof e)}function matchesDataType(e,t,r){if(t===r)return!0;if(isArrayType(t)&&isArrayType(r)){return matchesDataType(e,getArrayElementType(t),getArrayElementType(r))}return!("json"!==r||!e.hasStruct(t))||!(!["string","int"].includes(r)||!e.hasEnum(t))}function isOfType(e,t,r){if(r.startsWith("array")&&Array.isArray(t)){const n=getArrayElementType(r);return t.every((t=>isOfType(e,t,n)))}if(e.hasEnum(r)){return e.getEnum(r).values.includes(t)}if(e.hasStruct(r)&&isPlainObject(t)){const n=e.getStruct(r);return Object.entries(n.fields).every((([r,n])=>t.hasOwnProperty(r)?n.types.some((n=>isOfType(e,t[r],n))):!!n.optional))}if(isPrimitive(t)){if("number"==typeof t){if("int"===r)return Number.isInteger(t);if("float"===r)return!0}return typeof t===r||"string"==typeof t&&"secret"===r}return!1}function isArrayType(e){return e.startsWith("array")}function isIterableType(e){return e.startsWith("iterable")}function isMatchingType(e){if(e.parent instanceof FunctionCall){let t=e.parent,r=t.argList.indexOf(e),n=t.scope.getFunc(t.name);return Object.values(n.args)[r].types.includes(e.returnType)}if(e.parent instanceof Struct){let t=e.parent,r=[...t.fields.values()].indexOf(e),n=t.scope.getStruct(t.name);return Object.values(n.fields)[r].types.includes(e.returnType)}return!0}function isPlainObject(e){if("object"!=typeof e||"[object Object]"!==e.toString())return!1;if(null===Object.getPrototypeOf(e))return!0;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function isPrimitive(e){return e!==Object(e)}function isValidName(e,t){return t?.allowFirstUnderscore?/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e):/^[a-zA-Z][a-zA-Z0-9_]*$/.test(e)}function isValidType(e){return isPrimitive(e)||isPlainObject(e)||Array.isArray(e)}function unEscapeDollar(e){return e.replace(/^\\\$/g,"$")}const RESERVED=[C.STRING,C.SECRET,C.INT,C.FLOAT,C.BOOLEAN,C.JSON,C.ARRAY,C.FUNCTION,C.VOID,C.BLOCK,C.VARIABLE_DECLARATION,C.COND,C.VARIABLE_REFERENCE,C.ASSIGNMENT,C.ERROR,C.CLAUSE,C.FUNCTION_CALL,C.FUNCTION_DEFINITION,C.FUNCTION_PARAMETER,C.LITERAL,C.STRUCT,C.ENUM,C.MAP_NODE,C.ARRAY_NODE,C.DUPLICATE_DECLARATION,C.MISSING_ARGUMENT,C.INVALID_SYNTAX,C.TYPE_MISMATCH,C.UNDEFINED_TYPE,C.INVALID_VARIABLE_NAME,C.INVALID_VARIABLE_REFERENCE,C.INVALID_VARIABLE_TYPE,C.OP_AND,C.OP_OR,C.OP_NOT];class Registry{basicTypes=[C.STRING,C.SECRET,C.BOOLEAN,C.JSON,C.ARRAY,C.INT,C.FLOAT];funcs={};structs={};enums={};constructor(e={}){e.enums&&this.addEnums(e.enums),e.structs&&this.addStructs(e.structs),e.funcs&&this.addFuncs(e.funcs)}addFunc(e,t){if(RESERVED.includes(e))throw new Error(`Cannot use reserved word ${e} as function name`);if(this.hasDef(e))throw new Error(`name "${e}" already exists in registry`);let r=!1;for(let n of Object.values(t.args)){if(n.optional&&!r&&(r=!0),!n.optional&&r)throw new Error(`Required argument after optional argument in function ${e}`);for(let e of n.types)if(!this.hasType(e))throw new Error(`type "${e}" not found in registry`)}if("void"!==t.returnType&&!this.hasType(t.returnType))throw new Error(`Type "${t.returnType}" not found in registry`);this.funcs[e]=t}addFuncs(e){for(const[t,r]of Object.entries(e))this.addFunc(t,r)}addStruct(e,t){if(RESERVED.includes(e))throw new Error(`Cannot use reserved word ${e} as type name`);if(this.hasDef(e))throw new Error(`type "${e}" already exists in registry`);this.structs[e]=t}addEnum(e,t){if(RESERVED.includes(e))throw new Error(`Cannot use reserved word ${e} as type name`);if(this.hasDef(e))throw new Error(`type "${e}" already exists in registry`);this.enums[e]=t}addStructs(e){for(const[t,r]of Object.entries(e))this.addStruct(t,r)}addEnums(e){for(const[t,r]of Object.entries(e))this.addEnum(t,r)}clone(){return new Registry({funcs:this.funcs,structs:this.structs,enums:this.enums})}getFunc(e){if(this.hasFunc(e))return this.funcs[e];throw new Error(`Function ${e} not found in registry`)}hasDef(e){return this.hasFunc(e)||this.hasType(e)}hasFunc(e){return e in this.funcs}hasBasicType(e){return this.basicTypes.includes(e)}isContainerType(e){return isArrayType(e)||isIterableType(e)}getInnerType(e){if(isArrayType(e))return getArrayElementType(e);if(isIterableType(e))return getIterableElementType(e);throw"unreachable"}hasType(e){for(;this.isContainerType(e);)e=this.getInnerType(e);return this.hasBasicType(e)||this.hasStruct(e)||this.hasEnum(e)}hasEnum(e){return e in this.enums}hasStruct(e){return e in this.structs}getStruct(e){if(this.hasStruct(e))return this.structs[e];throw new Error(`Struct ${e} not found in registry`)}getEnum(e){if(this.hasEnum(e))return this.enums[e];throw new Error(`Enum ${e} not found in registry`)}}class RuntimeScope{stack;get top(){return this.stack[this.stack.length-1]}constructor(){this.stack=[{}]}set(e,t){if(RESERVED.includes(e))throw new Error(`Cannot use reserved word ${e} as variable name`);if(e in this.top)throw new Error(`Variable ${e} already exists`);if(!isValidType(t)&&"function"!=typeof t)throw new Error(`Error setting variable: "${e}". Value: "${JSON.stringify(t)}" doesn't match any valid type.`);this.top[e]=t}get(e){for(let t=this.stack.length-1;t>=0;t--)if(e in this.stack[t])return this.stack[t][e];throw new Error(`Variable ${e} does not exist`)}update(e,t){if(!isValidType(t))throw new Error(`Error updating variable: "${e}". Value: "${JSON.stringify(t)}" doesn't match any valid type.`);for(let r=this.stack.length-1;r>=0;r--)if(e in this.stack[r])return void(this.stack[r][e]=t);throw new Error(`Variable ${e} does not exist`)}has(e){for(let t=this.stack.length-1;t>=0;t--)if(e in this.stack[t])return!0;return!1}push(){this.stack.push({})}pop(){this.stack.pop()}isFromRegistry(e){return e in this.stack[0]}}class VM extends EventEmitter{observer={expressionStack:[]};interruptPromises=[];scopeStack;context;registry;tree;hooks=[];_running=!1;constructor(e,t,r,n){super(),this.registry=e,this.context=t,this.context.getExpression=this.getExpression,this.scopeStack=new RuntimeScope;for(let t in e.funcs)this.scopeStack.set(t,e.getFunc(t).fn);this.tree=r instanceof Root?r:new Root(this.registry,r,{declarations:n?.vars});try{this.setVars(n?.vars??[]),this.validate()}catch(e){throw e.code||(e.code=ErrorCodes$1.E_PARSE),StackedError.handle(e,"parse")}this.addHook(this._hookForObserver),this.addHook(this._hookToEmit)}setVars(e){const t=this.tree.declarations;for(let r of e){if(!t.has(r.name))throw new Error(`No declaration with name ${r.name} found`);if(this.scopeStack.has(r.name))throw new Error(`Error setting value. Value already set for name ${r.name}`);let e=t.get(r.name);if(!matchesDataType(this.tree.scope,e.dataType,r.dataType))throw new Error(`Error type ${r.dataType} is not compatible with ${e.dataType}`);if(!isOfType(this.tree.scope,r.value,e.dataType))throw new Error(`Error setting value. Provided value is not of type ${r.dataType}`);this.scopeStack.set(r.name,r.value)}}validate(){if(this.tree.hasErrors()){const e=this.tree.getErrorNodes();let t=e[0].error;throw e[0]instanceof ErrorExp&&(t=e[0]),StackedError.handle({message:t.description,code:t.code},"node",{path:t.path(),node:t.title})}for(let e of this.tree.declarations.list)if(!this.scopeStack.has(e.name))throw new Error(`Value not set for declaration: ${e.name}`)}getExpression=()=>this.observer.expressionStack[this.observer.expressionStack.length-1];interrupt(e){if(!this._running)return;if(!this.interruptPromises.length)throw new Error("Cannot interrupt: VM is not running");e||(e=new Error("Interrupted")),e.code||(e.code=ErrorCodes$1.E_INTERRUPT),e=StackedError.handle(e,"interrupt");this.interruptPromises[this.interruptPromises.length-1].reject(e)}_hookForObserver=async(e,t)=>{e===HOOK_EVENT.BEFORE_EVAL?this.observer.expressionStack.push(t.node):e!==HOOK_EVENT.AFTER_EVAL||t.error||this.observer.expressionStack.pop()};_hookToEmit=async(e,t)=>{switch(e){case HOOK_EVENT.BEFORE_EVAL:case HOOK_EVENT.AFTER_EVAL:this.emit("replay:change",e,t.node,t.error)}};runHooks=async(e,t)=>{try{for(const r of this.hooks){const n=this.appendNewInterruptPromise();try{await Promise.race([n,r(e,{scope:this.scopeStack,context:this.context,...t})])}finally{this.interruptPromises.pop()}}}catch(r){throw t?.error&&[HOOK_EVENT.AFTER_EVAL,HOOK_EVENT.AFTER_RUN].includes(e)&&(r.cause=t?.error),StackedError.handle(r,"hook",{type:e})}};addHook(e){this.hooks.unshift(e)}removeHook(e){const t=this.hooks.indexOf(e);this.hooks.splice(t,1)}appendNewInterruptPromise(){return this.interruptPromises.push(new RejectablePromise),this.interruptPromises[this.interruptPromises.length-1]}isRunning(){return this._running}async run(){if(this.tree){if(this._running)throw new Error("VM is already running");this._running=!0;try{return await this.tree.evaluate(this)}catch(e){throw StackedError.handle(e,"run")}finally{this._running=!1}}else console.error("source not set")}}const VERSION=2;var expressions=Object.freeze({__proto__:null,Accessor:Accessor,ArrayExp:ArrayExp,Assignment:Assignment,Block:Block,C:C,Clause:Clause,Conditional:Conditional,Declarations:Declarations,Enum:Enum,ErrorCodes:ErrorCodes,ErrorExp:ErrorExp,Expression:Expression,For:For,FunctionCall:FunctionCall,FunctionDefinition:FunctionDefinition,HOOK_EVENT:HOOK_EVENT,Lambda:Lambda,Literal:Literal,LogicalOperator:LogicalOperator,MapExp:MapExp,NodeTypes:NodeTypes,Operator:Operator,Registry:Registry,Return:Return,Root:Root,Struct:Struct,VERSION:VERSION,VM:VM,ValidationScope:ValidationScope,VariableDeclaration:VariableDeclaration,VariableReference:VariableReference,While:While,escapeDollar:escapeDollar,getParamReferences:getParamReferences,getReferences:getReferences,isArrayType:isArrayType,isIterableType:isIterableType,isValidName:isValidName,parseBlock:parseBlock,parseExpression:parseExpression,parseStatement:parseStatement});const MAX_TIMEOUT=60,isSelector=e=>e.hasOwnProperty("type")&&e.hasOwnProperty("value");class BrowserWrapper{constructor(e){this.browserImpl=e}get status_code(){return this.browserImpl.status_code}set status_code(e){this.browserImpl.status_code=e}get body_text_length(){return this.browserImpl.body_text_length}set body_text_length(e){this.browserImpl.body_text_length=e}capTimeout(e){e&&e.timeout&&e.timeout>MAX_TIMEOUT&&(e.timeout=MAX_TIMEOUT)}async click(e,t,r){return this.capTimeout(r),this.browserImpl.click(e,t,r)}async waitForDoc(e){this.capTimeout(e);const t=await this._waitForDoc(e);if(!(null==e?void 0:e.frame)||0===e.frame)try{const e=await this.getElementText({type:"css",value:"body"});this.body_text_length=e.replace(/\s+/g," ").trim().length}catch(e){this.body_text_length=0;const t=e.message.toLowerCase();if(!["execution context was destroyed","cannot find context with specified id"].some((e=>t.includes(e))))throw e}return t}async _waitForDoc(e){if(await this.browserImpl.waitForDoc(e),null==e?void 0:e.wait_for_redirects){try{await this.waitForDocumentRequest({frame:null==e?void 0:e.frame,timeout:e.wait_for_redirects})}catch(e){return}await this._waitForDoc(e)}}async waitForDocumentRequest(e){return this.capTimeout(e),this.browserImpl.waitForDocumentRequest(e)}async select(e,t,r){return this.capTimeout(r),this.browserImpl.select(e,t,r)}async keypress(e,t,r){return this.capTimeout(r),this.browserImpl.keypress(e,t,r)}async mousemove(e,t,r){return this.capTimeout(r),this.browserImpl.mousemove(e,t,r)}async drag(e,t,r,n,a){return this.capTimeout(a),this.browserImpl.drag(e,t,r,n,a)}async fill(e,t,r){return this.capTimeout(r),this.browserImpl.fill(e,t,r)}async focus(e,t){return this.capTimeout(t),this.browserImpl.focus(e,t)}async type(e,t,r){return this.capTimeout(r),this.browserImpl.type(e,t,r)}async scroll(e,t,r,n){return this.capTimeout(n),this.browserImpl.scroll(e,t,r,n)}async open(e,t){return this.capTimeout(t),this.browserImpl.open(e,t)}async getElementsCount(e,t){return this.capTimeout(t),this.browserImpl.getElementsCount(e,t)}async getElementText(e,t){this.capTimeout(t);try{return await this.browserImpl.getElementText(e,t)}catch(e){if(e.message.toLowerCase().includes("failed to find element matching selector"))return"";throw e}}async getSelectors(e,t){return this.capTimeout(t),this.browserImpl.getSelectors(e,t)}async evalOnSelector(e,t,r,n){return this.capTimeout(n),this.browserImpl.evalOnSelector(e,t,r,n)}async destroy(){var e,t;null===(t=(e=this.browserImpl).destroy)||void 0===t||t.call(e)}}function wait(e){return new Promise((t=>setTimeout(t,e)))}function containsText(e,t){return e.toLowerCase().includes(t.toLowerCase())}function getContextStack(e){const t=[null];let r=e;for(;r instanceof Expression;)r instanceof Block&&r.name!==C.UNTITLED&&t.push(r.name),r=r.parent;return t}function getLocator(e,t,r){const n=getContextStack(r);for(;n.length>0;){const r=n.pop(),a=t.filter((e=>e.context===r));for(let t of a)if(t.name===e){if(t.selectors.length>0)return t.selectors[0];throw new Error(`Tag "${e}" in context "${r}" has not selector`)}}throw new Error(`Tag "${e}" not found in context`)}function getExpressionVars(e,t={}){if(!e.params)return[];let r=[];return e.params.forEach((e=>{let n=t[e.name];if(void 0!==n)r.push({name:e.name,dataType:e.dataType,value:n});else{if(void 0===e.default||""===e.default||null===e.default)throw new BaseError("E_MISSING_INPUT",`${e.name}'s value is required but not set`);r.push({name:e.name,dataType:e.dataType,value:e.default})}})),r}var common=Object.freeze({__proto__:null,BrowserWrapper:BrowserWrapper,getExpressionVars:getExpressionVars});let Player$3=class extends EventEmitter{constructor(e,t){var r,n;let a;super(),this.emitChange=(e,t)=>{let r=t.parent;"beforeEval"===e&&(r instanceof Block||r instanceof Clause||r instanceof Conditional)&&this.emit("statusChange",{step:t})},a=e instanceof Root?e.registry:null!==(r=null==t?void 0:t.registry)&&void 0!==r?r:this.getNewRegistry(),this.context=null!==(n=null==t?void 0:t.context)&&void 0!==n?n:{},this.vm=new VM(a,this.context,e,{vars:null==t?void 0:t.vars})}getNewRegistry(){return new Registry}interrupt(e){this.vm.interrupt(e)}async play(){this.vm.on("replay:change",this.emitChange);let e=await this.vm.run();return this.vm.off("replay:change",this.emitChange),e}};const TIME_LIMIT=3e4;function getStepDefs(e){const t=(e,t)=>isSelector(e)?e:getLocator(e,t.tagList,t.getExpression()),r={};return r.click={name:"click",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"],default:{value:"html",type:"css",meta:{}}},pos:{types:["position"],default:{x:0,y:0}},options:{types:["click_opts"],default:{button:"left",clickCount:1,delay:0,frame:0,timeout:30},optional:!0}},returnType:C.VOID,fn:async(e,r,n,a)=>{await wait(1e3);let s=await t(r,e);await e.browser.click(s,n,a)},labels:["action"]},r.wait_doc={name:"wait_doc",args:{options:{types:["wait_doc_opts"],default:{wait_for_redirects:0,frame:0,timeout:30},optional:!0}},returnType:C.VOID,fn:async(e,t)=>{await e.browser.waitForDoc(t)},labels:["action"]},r.select={name:"select",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"],default:{value:"html",type:"css",meta:{}}},value:{types:[C.STRING],default:"Enter Select Option"},options:{types:["default_opts"],default:{frame:0,timeout:30},optional:!0}},returnType:C.VOID,fn:async(e,r,n,a)=>{await wait(1e3);let s=await t(r,e);await e.browser.select(s,n,a)},labels:["action"]},r.keypress={name:"keypress",args:{code:{types:["kb_key"],default:"Enter"},count:{types:[C.INT],default:1},options:{types:["keypress_opts"],default:{page:0,timeout:30},optional:!0}},returnType:C.VOID,fn:async(e,t,r,n)=>{await wait(1e3),await e.browser.keypress(t,r,n)},labels:["action"]},r.mousemove={name:"mousemove",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"],default:{value:"html",type:"css",meta:{}}},pos:{types:["position"],default:{x:0,y:0}},options:{types:["default_opts"],default:{frame:0,timeout:30},optional:!0}},returnType:C.VOID,fn:async(e,r,n,a)=>{await wait(1e3);let s=await t(r,e);await e.browser.mousemove(s,n,a)},labels:["action"]},r.drag={name:"drag",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"],default:{value:"html",type:"css",meta:{}}},pos:{types:["position"],default:{x:0,y:0}},targetSelector:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"],default:{value:"html",type:"css",meta:{}}},targetPos:{types:["position"],default:{x:0,y:0}},options:{types:["default_opts"],optional:!0}},returnType:C.VOID,fn:async(e,r,n,a,s,i)=>{await wait(1e3);let o=await t(r,e),c=await t(a,e);await e.browser.drag(o,n,c,s,i)},labels:["action"]},r.fill={name:"fill",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:[(null==e?void 0:e.tagMode)?"tag":"selector"],default:{value:"html",type:"css",meta:{}}},value:{types:[C.STRING],default:"Value to Fill"},options:{types:["default_opts"],optional:!0}},returnType:C.VOID,fn:async(t,r,n,a)=>{await wait(1e3);let s=(null==e?void 0:e.tagMode)?getLocator(r,t.tagList,t.getExpression()):r;await t.browser.fill(s,n,a)},labels:["action"]},r.focus={name:"focus",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"],default:{value:"html",type:"css",meta:{}}},options:{types:["default_opts"],default:{frame:0,timeout:30},optional:!0}},returnType:C.VOID,fn:async(e,r,n)=>{await wait(1e3);let a=await t(r,e);await e.browser.focus(a,n)},labels:["action"]},r.type={name:"type",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"],default:{value:"html",type:"css",meta:{}}},text:{types:[C.STRING],default:"Enter Text"},options:{types:["default_opts"],optional:!0}},returnType:C.VOID,fn:async(e,r,n,a)=>{await wait(1e3);let s=await t(r,e);await e.browser.type(s,n,a)},labels:["action"]},r.type_secret={name:"type_secret",args:{locator:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"],default:{value:"html",type:"css",meta:{}}},text:{types:[C.SECRET]},options:{types:["default_opts"],optional:!0}},returnType:C.VOID,fn:async(e,r,n,a)=>{await wait(1e3);let s=await t(r,e);await e.browser.type(s,n,a)},labels:["action"]},r.scroll={name:"scroll",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"],default:{value:"html",type:"css",meta:{}}},left:{types:[C.INT],default:0},top:{types:[C.INT],default:0},options:{types:["default_opts"],default:{frame:0,timeout:30},optional:!0}},returnType:C.VOID,fn:async(e,r,n,a,s)=>{await wait(1e3);let i=await t(r,e);await e.browser.scroll(i,n,a,s)},labels:["action"]},r.wait_for_duration={name:"wait_for_duration",args:{duration:{types:[C.INT],default:1}},returnType:C.VOID,fn:async(e,t)=>{await wait(1e3*t)},labels:["action"]},r.wait_for_element={name:"wait_for_element",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"],default:{value:"html",type:"css",meta:{}}},options:{types:["default_opts"],default:{frame:0,timeout:30},optional:!0}},returnType:C.VOID,fn:async(e,r,n)=>{let a=await t(r,e),s=await e.browser.getElementsCount(a,n),i=Date.now()+TIME_LIMIT;for(;0===s&&i>Date.now();)await wait(500),s=await e.browser.getElementsCount(a,n);if(0===s)throw new Error(`No element found for locator: ${a.value} not found`)},labels:["action"]},r.open={name:"open",args:{url:{types:[C.STRING],default:"https://www.example.com"},options:{types:["open_opts"],default:{page:0,timeout:30},optional:!0}},returnType:C.VOID,fn:async(e,t,r)=>{await e.browser.open(t,r)},labels:["action"]},r.go_back={name:"go_back",args:{opts:{types:["go_back_opts"],default:{waitUntil:"load",timeout:30},optional:!0}},returnType:C.VOID,fn:async(e,t)=>{await e.browser.goBack(t)},labels:["action"]},r.assert={name:"assert",args:{condition:{types:[C.BOOLEAN],default:["and",["element_exists"]]},error_code:{types:["error_code"],default:"E_ASSERTION_FAILED"},message:{types:[C.STRING],default:"",optional:!0}},returnType:C.VOID,fn:(e,t,r,n)=>{if(n||(n="Assertion Failed"),!t)throw new BaseError(r,n)},labels:["action","utils"]},r.range={name:"range",args:{to:{types:[C.INT],default:10},from:{types:[C.INT],optional:!0,default:0},step:{types:[C.INT],optional:!0,default:1}},returnType:`iterable<${C.INT}>`,fn:async(e,t,r,n)=>new RangeIterator({to:t,from:r,step:n}),labels:["utils"]},r.panic={name:"panic",args:{condition:{types:[C.BOOLEAN],default:["and",["element_exists"]]},error_code:{types:["error_code"],default:"E_REQUEST_FORBIDDEN"},message:{types:[C.STRING],default:""}},returnType:C.VOID,fn:(e,t,r,n)=>{if(t)throw new BaseError(r,n)},labels:["action","utils"]},r.get_response={name:"get_response",returnType:"response",args:{},fn:e=>({status_code:e.browser.status_code,body_text_length:e.browser.body_text_length})},r.length={name:"length",args:{str:{types:[C.STRING]}},returnType:C.INT,fn:async(e,t)=>t.length,labels:["utils"]},r.lower={name:"lower",args:{str:{types:[C.STRING]}},returnType:C.STRING,fn:async(e,t)=>t.toLowerCase(),labels:["utils"]},r.upper={name:"upper",args:{str1:{types:[C.STRING]}},returnType:C.STRING,fn:async(e,t)=>t.toUpperCase(),labels:["utils"]},r.trim={name:"trim",args:{str:{types:[C.STRING]},pos:{types:[C.STRING],optional:!0}},returnType:C.STRING,fn:async(e,t,r="BOTH")=>"LEADING"===r?t.trimStart():"TRAILING"===r?t.trimEnd():t.trim(),labels:["utils"]},r.substring={name:"substring",args:{str:{types:[C.STRING]},startPos:{types:[C.INT]},endPos:{types:[C.INT]}},returnType:C.STRING,fn:async(e,t,r,n)=>t.slice(r,n),labels:["utils"]},r.join={name:"join",args:{val:{types:["array<string>"]},seperator:{types:[C.STRING],optional:!0}},returnType:C.STRING,fn:async(e,t,r="")=>t.join(r),labels:["utils"]},r.re_match={name:"re_match",args:{str:{types:[C.STRING]},pattern:{types:[C.STRING]},flags:{types:[C.STRING],optional:!0}},returnType:"array<string>",fn:async(e,t,r,n="g")=>{const a=new RegExp(r,n),s=t.match(a);return s||[]},labels:["utils"]},r.re_replace={name:"re_replace",args:{str:{types:[C.STRING]},pattern:{types:[C.STRING]},replacement:{types:[C.STRING]},start:{types:[C.INT],optional:!0},N:{types:[C.INT],optional:!0},flags:{types:[C.STRING],optional:!0}},returnType:C.STRING,fn:async(e,t,r,n,a=0,s=-1,i="")=>{i.includes("g")||(i+="g");const o=new RegExp(r,i),c=(e,t)=>e.replace(o,(e=>t-- >0?n:e));if(a>0){const e=t.substring(0,a);let r=t.substring(a);return r=s>=0?c(r,s):r.replace(o,n),e+r}return s>=0?c(t,s):t.replace(o,n)},labels:["utils"]},r.index={name:"index",args:{val:{types:["array<string>"]},index:{types:[C.INT]}},returnType:C.STRING,fn:async(e,t,r=-1)=>{if(r<0||r>=t.length)throw new Error("Invalid argument: index out of bounds");return t[r]},labels:["utils"]},r.element_text={name:"element_text",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"]},options:{types:["default_opts"],optional:!0}},returnType:C.STRING,fn:async(t,r,n)=>{let a=(null==e?void 0:e.tagMode)?getLocator(r,t.tagList,t.getExpression()):r;return await t.browser.getElementText(a,n)},labels:["element"]},r.element_attr={name:"element_attr",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"]},attr:{types:[C.STRING]},options:{types:["default_opts"],optional:!0}},returnType:C.STRING,fn:async(t,r,n,a)=>{let s=(null==e?void 0:e.tagMode)?getLocator(r,t.tagList,t.getExpression()):r;return await t.browser.evalOnSelector(s,((e,t)=>{var r;return null!==(r=e.getAttribute(t.attr))&&void 0!==r?r:""}),{attr:n},a)},labels:["element"]},r.element_prop={name:"element_prop",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"]},prop:{types:[C.STRING]},options:{types:["default_opts"],optional:!0}},returnType:C.STRING,fn:async(t,r,n,a)=>{let s=(null==e?void 0:e.tagMode)?getLocator(r,t.tagList,t.getExpression()):r;return await t.browser.evalOnSelector(s,((e,t)=>{var r;return null!==(r=e[t.prop])&&void 0!==r?r:""}),{prop:n},a)},labels:["element"]},r}function getConditionDefs(e){const t={};return t.element_exists={name:"element_exists",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"]},options:{types:["default_opts"],optional:!0}},returnType:C.BOOLEAN,fn:async(t,r,n)=>{let a=(null==e?void 0:e.tagMode)?getLocator(r,t.tagList,t.getExpression()):r;return await t.browser.getElementsCount(a,n)>0},labels:["element"]},t.element_has_text={name:"element_has_text",args:{[(null==e?void 0:e.tagMode)?"tag":"locator"]:{types:(null==e?void 0:e.tagMode)?["tag","selector"]:["selector"]},text:{types:[C.STRING],default:"Search Text"},options:{types:["default_opts"],optional:!0}},returnType:C.BOOLEAN,fn:async(t,r,n,a={})=>{let s=(null==e?void 0:e.tagMode)?getLocator(r,t.tagList,t.getExpression()):r;return a.state="attached",containsText(await t.browser.getElementText(s,a),n)},labels:["element"]},t.lt={name:"lt",args:{num1:{types:[C.FLOAT]},num2:{types:[C.FLOAT]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>t<r},t.lte={name:"lte",args:{num1:{types:[C.FLOAT]},num2:{types:[C.FLOAT]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>t<=r},t.gt={name:"gt",args:{num1:{types:[C.FLOAT]},num2:{types:[C.FLOAT]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>t>r},t.gte={name:"gte",args:{num1:{types:[C.FLOAT]},num2:{types:[C.FLOAT]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>t>=r},t.eq={name:"eq",args:{num1:{types:[C.FLOAT]},num2:{types:[C.FLOAT]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>t===r},t.contains={name:"contains",args:{str1:{types:[C.STRING]},str2:{types:[C.STRING]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>t.includes(r)},t.not_contains={name:"not_contains",args:{str1:{types:[C.STRING]},str2:{types:[C.STRING]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>!t.includes(r)},t.starts_with={name:"starts_with",args:{str1:{types:[C.STRING]},str2:{types:[C.STRING]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>t.startsWith(r)},t.not_starts_with={name:"not_starts_with",args:{str1:{types:[C.STRING]},str2:{types:[C.STRING]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>!t.startsWith(r)},t.ends_with={name:"ends_with",args:{str:{types:[C.STRING]},target:{types:[C.STRING]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>t.endsWith(r)},t.not_ends_with={name:"not_ends_with",args:{str:{types:[C.STRING]},target:{types:[C.STRING]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>!t.endsWith(r)},t.is_empty={name:"is_empty",args:{str1:{types:[C.STRING]}},returnType:C.BOOLEAN,fn:async(e,t)=>!t||0===t.length},t.not_is_empty={name:"not_is_empty",args:{str1:{types:[C.STRING]}},returnType:C.BOOLEAN,fn:async(e,t)=>(null==t?void 0:t.length)>0},t.match_regex={name:"match_regex",args:{str1:{types:[C.STRING]},regex:{types:["regex"]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>t.match(new RegExp(r.expr,r.flags))},t.not_match_regex={name:"not_match_regex",args:{str1:{types:[C.STRING]},regex:{types:["regex"]}},returnType:C.BOOLEAN,fn:async(e,t,r)=>!t.match(new RegExp(r.expr,r.flags))},t}const structDefs={};structDefs.selector={name:"selector",fields:{value:{types:[C.STRING],default:"html"},type:{types:["selector_type"],default:"css"},meta:{types:[C.JSON],default:{},optional:!0}},iterator:{type:"selector",iter:async(e,t)=>await e.browser.getSelectors(t)}},structDefs.position={name:"position",fields:{x:{types:[C.FLOAT],default:0},y:{types:[C.FLOAT],default:0}}},structDefs.frame_locator={name:"frame_locator",fields:{index:{types:[C.INT],default:0,optional:!0},name:{types:[C.STRING],default:"",optional:!0},page:{types:[C.INT],default:0,optional:!0}}},structDefs.default_opts={name:"options",fields:{frame:{types:[C.INT,"frame_locator"],default:0,optional:!0},timeout:{types:[C.INT],default:30,optional:!0}}},structDefs.wait_doc_opts={name:"options",fields:{wait_for_redirects:{types:[C.INT],default:0,optional:!0},frame:{types:[C.INT,"frame_locator"],default:0,optional:!0},timeout:{types:[C.INT],default:30,optional:!0}}},structDefs.click_opts={name:"options",fields:{frame:{types:[C.INT,"frame_locator"],default:0,optional:!0},timeout:{types:[C.INT],default:30,optional:!0},button:{types:["mouse_button"],default:"left",optional:!0},clickCount:{types:[C.INT],default:1,optional:!0},delay:{types:[C.INT],default:0,optional:!0}}},structDefs.keypress_opts={name:"options",fields:{page:{types:[C.INT],default:0,optional:!0},timeout:{types:[C.INT],default:30,optional:!0}}},structDefs.open_opts={name:"options",fields:{page:{types:[C.INT],default:0,optional:!0},timeout:{types:[C.INT],default:30,optional:!0}}},structDefs.response={name:"response",fields:{status_code:{types:[C.INT]},body_text_length:{types:[C.INT]}}},structDefs.regex={name:"regex",fields:{expr:{types:[C.STRING]},flags:{types:[C.STRING],optional:!0}}};class RangeIterator{constructor({to:e,from:t=0,step:r=1}){if(this.current=t,this.to=e,this.step=r,0===r)throw new Error("Step cannot be 0");this.condition=this.step>0?this.lt:this.gt}gt(e,t){return e>t}lt(e,t){return e<t}next(){if(this.condition(this.current,this.to)){const e={done:!1,value:this.current};return this.current=this.current+this.step,e}return{done:!0,value:null}}[Symbol.iterator](){return this}}structDefs.go_back_opts={name:"options",fields:{waitUntil:{types:[C.STRING],default:"load",optional:!0},timeout:{types:[C.INT],default:60,optional:!0}}};const enumDefs={selector_type:{name:"selector_type",enumType:"string",values:["css","xpath"]},kb_key:{name:"kb_key",enumType:"string",values:["ArrowDown","ArrowLeft","ArrowRight","ArrowUp","Backspace","Delete","Enter","Escape","Tab"]},mouse_button:{name:"mouse_button",enumType:"string",values:["left","right","middle","forward","back"]},error_code:{name:"error_code",enumType:"string",values:["E_ASSERT","E_CAPTCHA","E_ELEMENT_NOT_FOUND","E_REQUEST","E_REQUEST_BAD_GATEWAY","E_REQUEST_FORBIDDEN","E_REQUEST_INTERNAL_SERVER_ERROR","E_REQUEST_NOT_FOUND","E_REQUEST_SERVICE_UNAVAILABLE","E_REQUEST_TOO_MANY_REQUESTS","E_REQUEST_UNAUTHORIZED","E_TIMED_OUT","E_UNKNOWN"]}},stepDefs$1=getStepDefs(),conditionDefs$1=getConditionDefs(),builtInDeclarations$1=[{name:"start_url",dataType:"string",builtIn:!0}];function parseSteps$2(e,t){return t||(t={}),t.declarations||(t.declarations=[]),t.declarations=[...t.declarations,...builtInDeclarations$1],new Root(createRegistry$2(),e,t)}function createRegistry$2(){return new Registry({funcs:{...stepDefs$1,...conditionDefs$1},structs:{...structDefs},enums:{...enumDefs}})}let Player$2=class extends Player$3{constructor(e,t,r){super(e,{...r,context:{...null==r?void 0:r.context,browser:new BrowserWrapper(t)}})}getNewRegistry(){return createRegistry$2()}};var macro=Object.freeze({__proto__:null,BrowserWrapper:BrowserWrapper,MAX_TIMEOUT:MAX_TIMEOUT,Player:Player$2,builtInDeclarations:builtInDeclarations$1,conditionDefs:conditionDefs$1,enumDefs:enumDefs,isSelector:isSelector,parseSteps:parseSteps$2,stepDefs:stepDefs$1,structDefs:structDefs});const workflowEnums={tag:{name:"tag",enumType:"string",values:[],iterator:{type:"selector",iter:async(e,t)=>{let r=getLocator(t,e.tagList,e.getExpression());return await e.browser.getSelectors(r)}}}},stepDefs=getStepDefs({tagMode:!0}),conditionDefs=getConditionDefs({tagMode:!0}),builtInDeclarations=[{name:"start_url",dataType:"string",builtIn:!0}];function parseSteps$1(e,t,r){return r||(r={}),r.declarations||(r.declarations=[]),r.declarations=[...r.declarations,...builtInDeclarations],workflowEnums.tag.values=[...t],new Root(createRegistry$1(),e,{allowNamedBlocks:!0,...r})}function createRegistry$1(){return new Registry({funcs:{...stepDefs,...conditionDefs},structs:{...structDefs},enums:{...enumDefs,...workflowEnums}})}let Player$1=class extends Player$3{constructor(e,t,r,n){super(e,{...n,context:{...null==n?void 0:n.context,browser:new BrowserWrapper(t),tagList:r}})}getNewRegistry(){return createRegistry$1()}};var workflow=Object.freeze({__proto__:null,BrowserWrapper:BrowserWrapper,MAX_TIMEOUT:MAX_TIMEOUT,Player:Player$1,builtInDeclarations:builtInDeclarations,conditionDefs:conditionDefs,enumDefs:enumDefs,getContextStack:getContextStack,isSelector:isSelector,parseSteps:parseSteps$1,stepDefs:stepDefs,structDefs:structDefs});const procStructDefs={regex:structDefs.regex},procFuncDefs=getProcFuncDefs(),scraperDefs={scrape:{name:"scrape",args:{id:{types:[C.STRING]}},returnType:C.VOID,fn:async(e,t)=>await e.scraper.scrape(t)}};function getProcFuncDefs(){var e,t;const r={};for(const[t,n]of Object.entries(getStepDefs()))(null===(e=n.labels)||void 0===e?void 0:e.includes("utils"))&&(r[t]=n);for(const[e,n]of Object.entries(getConditionDefs()))(null===(t=n.labels)||void 0===t?void 0:t.includes("element"))||(r[e]=n);return r}function parseSteps(e,t){return new Root(createRegistry(),e,t)}function parseProcs(e,t){return new Root(createProcRegistry(),e,t)}function createRegistry(){return new Registry({funcs:{...stepDefs$1,...conditionDefs$1,...scraperDefs},structs:{...structDefs},enums:{...enumDefs}})}function createProcRegistry(){return new Registry({funcs:procFuncDefs,structs:procStructDefs,enums:{...enumDefs}})}class Player extends Player$3{constructor(e,t,r,n){super(e,{...n,context:{...null==n?void 0:n.context,browser:new BrowserWrapper(t),scraper:r}})}getNewRegistry(){return createRegistry()}}class ProcPlayer extends Player$3{constructor(e,t){super(e,t)}getNewRegistry(){return createProcRegistry()}}var scraper=Object.freeze({__proto__:null,Player:Player,ProcPlayer:ProcPlayer,conditionDefs:conditionDefs$1,enumDefs:enumDefs,parseProcs:parseProcs,parseSteps:parseSteps,procFuncDefs:procFuncDefs,procStructDefs:procStructDefs,scraperDefs:scraperDefs,stepDefs:stepDefs$1,structDefs:structDefs}),Type;!function(e){e.json="json",e.string="string",e.number="number",e.boolean="boolean",e.currency="currency",e.date="date",e.url="url"}(Type||(Type={}));const PRIMITIVES=[Type.json,Type.string,Type.number,Type.date,Type.boolean,Type.url,Type.currency];var ErrorCode;!function(e){e.E_DATATYPE_NA="E_DATATYPE_NA",e.E_EXTRACTOR_NA="E_EXTRACTOR_NA",e.E_ZERO_SELECTORS="E_ZERO_SELECTORS",e.E_ATTRIBUTE_NOT_EXIST="E_ATTRIBUTE_NOT_EXIST",e.E_PROP_NOT_EXIST="E_PROP_NOT_EXIST",e.E_BUILTIN_NA="E_BUILTIN_NA",e.E_NO_REDUCER_EXISTS="E_NO_REDUCER_EXISTS",e.E_NO_DATA_EXISTS="E_NO_DATA_EXISTS",e.E_TAG_INVALID_SELECTOR="E_TAG_INVALID_SELECTOR",e.E_REQUIRED_VALUE_NA="E_REQUIRED_VALUE_NA",e.E_TABLE_ROW_ELEMENT_NOT_EXIST="E_TABLE_ROW_ELEMENT_NOT_EXIST",e.E_VALIDATION_FAILED="E_VALIDATION_FAILED",e.E_INVALID_CONDITION="E_INVALID_CONDITION",e.E_ASSERTION="E_ASSERTION",e.E_FORMAT="E_FORMAT",e.E_SYNTAX="E_SYNTAX"}(ErrorCode||(ErrorCode={}));const trimText=e=>e.replace(/[\s]+$/gm,"").replace(/\s{2,}/gm," "),runExpressions=(e,t)=>new ProcPlayer(e,t).play(),typeAliases={currency:"float",number:"float"};function resolveAlias(e){return typeAliases[e]?typeAliases[e]:e}function getPrimitive$1(e){return typeAliases[e]||isArrayType(e)&&(e=e.slice(6,-1),typeAliases[e])?typeAliases[e]:e}function getElementDepth(e){let t=0;for(;e;)if(t++,e.parentNode)e=e.parentNode;else{if(!e.host){if(e.defaultView&&e.defaultView.frameElement)return e=e.defaultView.frameElement,t++,t;break}e=e.host,t++}return t}function detectBrowser(){const e=navigator.userAgent;return e.indexOf("Edg")>-1?"Microsoft Edge":e.indexOf("Chrome")>-1?"Chrome":e.indexOf("Firefox")>-1?"Firefox":e.indexOf("Safari")>-1?"Safari":e.indexOf("Opera")>-1?"Opera":e.indexOf("Trident")>-1||e.indexOf("MSIE")>-1?"Internet Explorer":"Unknown"}function getElementComputedStyle(e,t){try{return e.ownerDocument?.defaultView?.getComputedStyle(e,t)}catch(e){}}function isVisibleTextNode(e){const t=e.ownerDocument.createRange();t.selectNode(e);const r=t.getBoundingClientRect();return r.width>0&&r.height>0}function isElementStyleVisibilityVisible(e,t){if(!(t=t??getElementComputedStyle(e)))return!0;if(Element.prototype.checkVisibility&&"Safari"!==detectBrowser()){if(!e.checkVisibility({checkOpacity:!1,checkVisibilityCSS:!1}))return!1}else{const t=e.closest("details,summary");if(t!==e&&"DETAILS"===t?.nodeName&&!t.open)return!1}return"visible"===t.visibility}function isElementVisible(e){const t=getElementComputedStyle(e);if(!t)return!0;if("contents"===t.display){for(let t=e.firstChild;t;t=t.nextSibling){if(1===t.nodeType&&isElementVisible(t))return!0;if(3===t.nodeType&&isVisibleTextNode(t))return!0}return!1}if(!isElementStyleVisibilityVisible(e,t))return!1;const r=e.getBoundingClientRect();return r.width>0&&r.height>0}Error.prototype.toJSON=function(){return{code:this.code,message:this.message,stack:this.stack}};class UnsupportedBuiltInTypeError extends BaseError{constructor(e){super(ErrorCode.E_BUILTIN_NA,`The builtin extractor '${e.name}' is not supported`)}}class UnsupportedDataTypeError extends BaseError{constructor(e){super(ErrorCode.E_DATATYPE_NA,`The datatype ${e} is not supported`)}}class UnsupportedExtractorTypeError extends BaseError{constructor(e){super(ErrorCode.E_EXTRACTOR_NA,`The extractor type ${e} is not supported`)}}class ExtractorReturnedNull extends BaseError{constructor(e){super(ErrorCode.E_REQUIRED_VALUE_NA,`Extracted value of the tag '${e.name}' is null`)}}class InvalidSelectorError extends BaseError{constructor(e){super(ErrorCode.E_TAG_INVALID_SELECTOR,`Selector "${e}" is invalid.`)}}class ZeroSelectorsError extends BaseError{constructor(){super(ErrorCode.E_ZERO_SELECTORS,"No selectors are available. Please add a selector.")}}class PropDoesNotExistError extends BaseError{constructor(e){super(ErrorCode.E_PROP_NOT_EXIST,`Prop '${e}' does not exist`)}}class InValidFormatError extends BaseError{constructor(e,t){super(ErrorCode.E_FORMAT,`Invalid ${e?`${e} `:""}format: ${t}`)}}class InValidSyntaxError extends BaseError{constructor(e,t,r){super(ErrorCode.E_SYNTAX,`Invalid ${e?`${e} `:""}syntax`+(t?` - ${t}`:"")+(r?`: ${r}`:""))}}class DataNotFoundError extends BaseError{constructor(e){super(ErrorCode.E_NO_DATA_EXISTS,e)}}class ReducerNotFoundError extends BaseError{constructor(){super(ErrorCode.E_NO_REDUCER_EXISTS,"No reducers found.")}}class DataValidationError extends BaseError{constructor(e){super(ErrorCode.E_VALIDATION_FAILED,`Failed while validating tags. '${e}'`)}}class DataExtractor{tag;doc=document;ctx;constructor(e,t,r){this.tag=e,this.doc=t,this.ctx=r}async extract(e){try{const t=await this.getElements(this.tag),r=this.getData(this.tag,e,t);if(!r)throw new ExtractorReturnedNull(this.tag);return await(this.ctx.hook?.(EXTRACT_STAGE.END,{elements:t,tag:this.tag})),r}catch(e){throw StackedError.handle(e,"extractor")}}async getElements(e){if(!e.selectors)throw new ZeroSelectorsError;const t=e.selectors.includes;if(0===t.length)throw new ZeroSelectorsError;return this.getElementsForSelectors(e.selectors.excludes).forEach((e=>e.remove())),this.getElementsForSelectors(t,!0)}getData(e,t,r){if(!e.selectors)return null;const n=t||{type:"text"};return r.map((t=>this.extractDOM(e,t,n)))}getElementsForSelectors(e,t=!1){if(!e)return[];const r=[];let n=[];for(const a of e){try{"xpath"===a.type?n=this.ctx.evaluateXPath(a.value):"css"===a.type&&(n=Array.from(this.ctx.querySelectorAll(a.value)))}catch(e){throw console.error("error while querying the dom for selector",e),new InvalidSelectorError(a.value)}if(n.length>0){if(t)return n;r.push(...Array.from(n))}}return r}visit(e,t){if(!1!==t(e)&&e.childNodes)for(let r of Array.from(e.childNodes))this.visit(r,t)}isText=e=>e.nodeType==document.TEXT_NODE;getElText(e,t,{visibleOnly:r}={}){this.visit(e,(e=>!["NOSCRIPT","SCRIPT","STYLE","style"].includes(e.nodeName)&&(!(r&&!isElementVisible(e))&&void this.getNodeText(e,t))))}getNodeText(e,t){this.isText(e)&&t.push(e.nodeValue)}extractByJS(el,extractor){globalThis.el=el;const result=eval(extractor.params.script);return globalThis.el=void 0,result}extractDOM(e,t,r){switch(t.setAttribute("distill-tag",e.name),r.type){case"attr":return t.hasAttribute(r.params.name)?t.getAttribute(r.params.name).toString():"";case"prop":{const e=t[r.params.name];if(null==e)throw new PropDoesNotExistError(r.params.name);return e.toString()}case"html":return t.outerHTML;case"text":case"text_visible":{const e="text_visible"===r.type,n=[];return this.getElText(t,n,{visibleOnly:e}),trimText(n.join(" "))}case"js":return this.extractByJS(t,r);default:throw new UnsupportedExtractorTypeError(r.type)}}extractBuiltIn(e){const t=e.selectors;if(!t)return null;if("title"===t.field.type)return this.ctx.getDocument().title;throw new UnsupportedBuiltInTypeError(e)}extractMeta(e){const t=e.selectors;if(!t)return null;const r=this.ctx.getDocument().querySelector(`meta[name=${t.field.type}]`);if(null==r)return null;const n=r.getAttribute("content");return null==n?null:n}}class Proc{tag;data;constructor(e,t){this.tag=e,this.data=t}}class DataMapper extends Proc{mappers;data=[];constructor(e,t,r){super(e,t),this.data=t,this.mappers=r??[]}async map(){if(!this.data)throw StackedError.handle(new DataNotFoundError("Data not found for mapper"),"mapper");let e=this.data;const t=this.mappers;for(let r=0;r<t.length;r++){const n=t[r];try{e=await this.runMapper(n,e)}catch(e){throw e.findLast("mapper").mapper_index=r,e}}return e}async runMapper(e,t){const r=[];for(const n of t)try{let t=n;t=await runExpressions([e],{vars:[{name:"str",dataType:"string",value:t}]}),r.push(t)}catch(e){throw StackedError.handle(e,"mapper",{text:n})}return r}}class DataReducer extends Proc{reducer;constructor(e,t,r){super(e,t),this.reducer=r}async reduce(){try{if(!this.data)throw new DataNotFoundError("Data not found for reducer");if(!this.reducer)throw new ReducerNotFoundError;return await runExpressions([this.reducer],{vars:[{name:"val",dataType:"array<string>",value:this.data}]})}catch(e){throw StackedError.handle(e,"reducer")}}}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function toInteger(e){if(null===e||!0===e||!1===e)return NaN;var t=Number(e);return isNaN(t)?t:t<0?Math.ceil(t):Math.floor(t)}function requiredArgs(e,t){if(t.length<e)throw new TypeError(e+" argument"+(e>1?"s":"")+" required, but only "+t.length+" present")}function toDate(e){requiredArgs(1,arguments);var t=Object.prototype.toString.call(e);return e instanceof Date||"object"===_typeof(e)&&"[object Date]"===t?new Date(e.getTime()):"number"==typeof e||"[object Number]"===t?new Date(e):("string"!=typeof e&&"[object String]"!==t||"undefined"==typeof console||(console.warn("Starting with v2.0.0-beta.1 date-fns doesn't accept strings as date arguments. Please use `parseISO` to parse strings. See: https://github.com/date-fns/date-fns/blob/master/docs/upgradeGuide.md#string-arguments"),console.warn((new Error).stack)),new Date(NaN))}function addMilliseconds(e,t){requiredArgs(2,arguments);var r=toDate(e).getTime(),n=toInteger(t);return new Date(r+n)}var defaultOptions={};function getDefaultOptions(){return defaultOptions}function getTimezoneOffsetInMilliseconds(e){var t=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()));return t.setUTCFullYear(e.getFullYear()),e.getTime()-t.getTime()}var millisecondsInMinute=6e4,millisecondsInHour=36e5,millisecondsInSecond=1e3;function isDate(e){return requiredArgs(1,arguments),e instanceof Date||"object"===_typeof(e)&&"[object Date]"===Object.prototype.toString.call(e)}function isValid(e){if(requiredArgs(1,arguments),!isDate(e)&&"number"!=typeof e)return!1;var t=toDate(e);return!isNaN(Number(t))}function subMilliseconds(e,t){return requiredArgs(2,arguments),addMilliseconds(e,-toInteger(t))}var MILLISECONDS_IN_DAY=864e5;function getUTCDayOfYear(e){requiredArgs(1,arguments);var t=toDate(e),r=t.getTime();t.setUTCMonth(0,1),t.setUTCHours(0,0,0,0);var n=r-t.getTime();return Math.floor(n/MILLISECONDS_IN_DAY)+1}function startOfUTCISOWeek(e){requiredArgs(1,arguments);var t=toDate(e),r=t.getUTCDay(),n=(r<1?7:0)+r-1;return t.setUTCDate(t.getUTCDate()-n),t.setUTCHours(0,0,0,0),t}function getUTCISOWeekYear(e){requiredArgs(1,arguments);var t=toDate(e),r=t.getUTCFullYear(),n=new Date(0);n.setUTCFullYear(r+1,0,4),n.setUTCHours(0,0,0,0);var a=startOfUTCISOWeek(n),s=new Date(0);s.setUTCFullYear(r,0,4),s.setUTCHours(0,0,0,0);var i=startOfUTCISOWeek(s);return t.getTime()>=a.getTime()?r+1:t.getTime()>=i.getTime()?r:r-1}function startOfUTCISOWeekYear(e){requiredArgs(1,arguments);var t=getUTCISOWeekYear(e),r=new Date(0);return r.setUTCFullYear(t,0,4),r.setUTCHours(0,0,0,0),startOfUTCISOWeek(r)}var MILLISECONDS_IN_WEEK$1=6048e5;function getUTCISOWeek(e){requiredArgs(1,arguments);var t=toDate(e),r=startOfUTCISOWeek(t).getTime()-startOfUTCISOWeekYear(t).getTime();return Math.round(r/MILLISECONDS_IN_WEEK$1)+1}function startOfUTCWeek(e,t){var r,n,a,s,i,o,c,u;requiredArgs(1,arguments);var l=getDefaultOptions(),p=toInteger(null!==(r=null!==(n=null!==(a=null!==(s=null==t?void 0:t.weekStartsOn)&&void 0!==s?s:null==t||null===(i=t.locale)||void 0===i||null===(o=i.options)||void 0===o?void 0:o.weekStartsOn)&&void 0!==a?a:l.weekStartsOn)&&void 0!==n?n:null===(c=l.locale)||void 0===c||null===(u=c.options)||void 0===u?void 0:u.weekStartsOn)&&void 0!==r?r:0);if(!(p>=0&&p<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var d=toDate(e),h=d.getUTCDay(),f=(h<p?7:0)+h-p;return d.setUTCDate(d.getUTCDate()-f),d.setUTCHours(0,0,0,0),d}function getUTCWeekYear(e,t){var r,n,a,s,i,o,c,u;requiredArgs(1,arguments);var l=toDate(e),p=l.getUTCFullYear(),d=getDefaultOptions(),h=toInteger(null!==(r=null!==(n=null!==(a=null!==(s=null==t?void 0:t.firstWeekContainsDate)&&void 0!==s?s:null==t||null===(i=t.locale)||void 0===i||null===(o=i.options)||void 0===o?void 0:o.firstWeekContainsDate)&&void 0!==a?a:d.firstWeekContainsDate)&&void 0!==n?n:null===(c=d.locale)||void 0===c||null===(u=c.options)||void 0===u?void 0:u.firstWeekContainsDate)&&void 0!==r?r:1);if(!(h>=1&&h<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var f=new Date(0);f.setUTCFullYear(p+1,0,h),f.setUTCHours(0,0,0,0);var y=startOfUTCWeek(f,t),m=new Date(0);m.setUTCFullYear(p,0,h),m.setUTCHours(0,0,0,0);var g=startOfUTCWeek(m,t);return l.getTime()>=y.getTime()?p+1:l.getTime()>=g.getTime()?p:p-1}function startOfUTCWeekYear(e,t){var r,n,a,s,i,o,c,u;requiredArgs(1,arguments);var l=getDefaultOptions(),p=toInteger(null!==(r=null!==(n=null!==(a=null!==(s=null==t?void 0:t.firstWeekContainsDate)&&void 0!==s?s:null==t||null===(i=t.locale)||void 0===i||null===(o=i.options)||void 0===o?void 0:o.firstWeekContainsDate)&&void 0!==a?a:l.firstWeekContainsDate)&&void 0!==n?n:null===(c=l.locale)||void 0===c||null===(u=c.options)||void 0===u?void 0:u.firstWeekContainsDate)&&void 0!==r?r:1),d=getUTCWeekYear(e,t),h=new Date(0);return h.setUTCFullYear(d,0,p),h.setUTCHours(0,0,0,0),startOfUTCWeek(h,t)}var MILLISECONDS_IN_WEEK=6048e5;function getUTCWeek(e,t){requiredArgs(1,arguments);var r=toDate(e),n=startOfUTCWeek(r,t).getTime()-startOfUTCWeekYear(r,t).getTime();return Math.round(n/MILLISECONDS_IN_WEEK)+1}function addLeadingZeros(e,t){for(var r=e<0?"-":"",n=Math.abs(e).toString();n.length<t;)n="0"+n;return r+n}var formatters$2={y:function(e,t){var r=e.getUTCFullYear(),n=r>0?r:1-r;return addLeadingZeros("yy"===t?n%100:n,t.length)},M:function(e,t){var r=e.getUTCMonth();return"M"===t?String(r+1):addLeadingZeros(r+1,2)},d:function(e,t){return addLeadingZeros(e.getUTCDate(),t.length)},a:function(e,t){var r=e.getUTCHours()/12>=1?"pm":"am";switch(t){case"a":case"aa":return r.toUpperCase();case"aaa":return r;case"aaaaa":return r[0];default:return"am"===r?"a.m.":"p.m."}},h:function(e,t){return addLeadingZeros(e.getUTCHours()%12||12,t.length)},H:function(e,t){return addLeadingZeros(e.getUTCHours(),t.length)},m:function(e,t){return addLeadingZeros(e.getUTCMinutes(),t.length)},s:function(e,t){return addLeadingZeros(e.getUTCSeconds(),t.length)},S:function(e,t){var r=t.length,n=e.getUTCMilliseconds();return addLeadingZeros(Math.floor(n*Math.pow(10,r-3)),t.length)}},formatters$3=formatters$2,dayPeriodEnum={am:"am",pm:"pm",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},formatters={G:function(e,t,r){var n=e.getUTCFullYear()>0?1:0;switch(t){case"G":case"GG":case"GGG":return r.era(n,{width:"abbreviated"});case"GGGGG":return r.era(n,{width:"narrow"});default:return r.era(n,{width:"wide"})}},y:function(e,t,r){if("yo"===t){var n=e.getUTCFullYear(),a=n>0?n:1-n;return r.ordinalNumber(a,{unit:"year"})}return formatters$3.y(e,t)},Y:function(e,t,r,n){var a=getUTCWeekYear(e,n),s=a>0?a:1-a;return"YY"===t?addLeadingZeros(s%100,2):"Yo"===t?r.ordinalNumber(s,{unit:"year"}):addLeadingZeros(s,t.length)},R:function(e,t){return addLeadingZeros(getUTCISOWeekYear(e),t.length)},u:function(e,t){return addLeadingZeros(e.getUTCFullYear(),t.length)},Q:function(e,t,r){var n=Math.ceil((e.getUTCMonth()+1)/3);switch(t){case"Q":return String(n);case"QQ":return addLeadingZeros(n,2);case"Qo":return r.ordinalNumber(n,{unit:"quarter"});case"QQQ":return r.quarter(n,{width:"abbreviated",context:"formatting"});case"QQQQQ":return r.quarter(n,{width:"narrow",context:"formatting"});default:return r.quarter(n,{width:"wide",context:"formatting"})}},q:function(e,t,r){var n=Math.ceil((e.getUTCMonth()+1)/3);switch(t){case"q":return String(n);case"qq":return addLeadingZeros(n,2);case"qo":return r.ordinalNumber(n,{unit:"quarter"});case"qqq":return r.quarter(n,{width:"abbreviated",context:"standalone"});case"qqqqq":return r.quarter(n,{width:"narrow",context:"standalone"});default:return r.quarter(n,{width:"wide",context:"standalone"})}},M:function(e,t,r){var n=e.getUTCMonth();switch(t){case"M":case"MM":return formatters$3.M(e,t);case"Mo":return r.ordinalNumber(n+1,{unit:"month"});case"MMM":return r.month(n,{width:"abbreviated",context:"formatting"});case"MMMMM":return r.month(n,{width:"narrow",context:"formatting"});default:return r.month(n,{width:"wide",context:"formatting"})}},L:function(e,t,r){var n=e.getUTCMonth();switch(t){case"L":return String(n+1);case"LL":return addLeadingZeros(n+1,2);case"Lo":return r.ordinalNumber(n+1,{unit:"month"});case"LLL":return r.month(n,{width:"abbreviated",context:"standalone"});case"LLLLL":return r.month(n,{width:"narrow",context:"standalone"});default:return r.month(n,{width:"wide",context:"standalone"})}},w:function(e,t,r,n){var a=getUTCWeek(e,n);return"wo"===t?r.ordinalNumber(a,{unit:"week"}):addLeadingZeros(a,t.length)},I:function(e,t,r){var n=getUTCISOWeek(e);return"Io"===t?r.ordinalNumber(n,{unit:"week"}):addLeadingZeros(n,t.length)},d:function(e,t,r){return"do"===t?r.ordinalNumber(e.getUTCDate(),{unit:"date"}):formatters$3.d(e,t)},D:function(e,t,r){var n=getUTCDayOfYear(e);return"Do"===t?r.ordinalNumber(n,{unit:"dayOfYear"}):addLeadingZeros(n,t.length)},E:function(e,t,r){var n=e.getUTCDay();switch(t){case"E":case"EE":case"EEE":return r.day(n,{width:"abbreviated",context:"formatting"});case"EEEEE":return r.day(n,{width:"narrow",context:"formatting"});case"EEEEEE":return r.day(n,{width:"short",context:"formatting"});default:return r.day(n,{width:"wide",context:"formatting"})}},e:function(e,t,r,n){var a=e.getUTCDay(),s=(a-n.weekStartsOn+8)%7||7;switch(t){case"e":return String(s);case"ee":return addLeadingZeros(s,2);case"eo":return r.ordinalNumber(s,{unit:"day"});case"eee":return r.day(a,{width:"abbreviated",context:"formatting"});case"eeeee":return r.day(a,{width:"narrow",context:"formatting"});case"eeeeee":return r.day(a,{width:"short",context:"formatting"});default:return r.day(a,{width:"wide",context:"formatting"})}},c:function(e,t,r,n){var a=e.getUTCDay(),s=(a-n.weekStartsOn+8)%7||7;switch(t){case"c":return String(s);case"cc":return addLeadingZeros(s,t.length);case"co":return r.ordinalNumber(s,{unit:"day"});case"ccc":return r.day(a,{width:"abbreviated",context:"standalone"});case"ccccc":return r.day(a,{width:"narrow",context:"standalone"});case"cccccc":return r.day(a,{width:"short",context:"standalone"});default:return r.day(a,{width:"wide",context:"standalone"})}},i:function(e,t,r){var n=e.getUTCDay(),a=0===n?7:n;switch(t){case"i":return String(a);case"ii":return addLeadingZeros(a,t.length);case"io":return r.ordinalNumber(a,{unit:"day"});case"iii":return r.day(n,{width:"abbreviated",context:"formatting"});case"iiiii":return r.day(n,{width:"narrow",context:"formatting"});case"iiiiii":return r.day(n,{width:"short",context:"formatting"});default:return r.day(n,{width:"wide",context:"formatting"})}},a:function(e,t,r){var n=e.getUTCHours()/12>=1?"pm":"am";switch(t){case"a":case"aa":return r.dayPeriod(n,{width:"abbreviated",context:"formatting"});case"aaa":return r.dayPeriod(n,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return r.dayPeriod(n,{width:"narrow",context:"formatting"});default:return r.dayPeriod(n,{width:"wide",context:"formatting"})}},b:function(e,t,r){var n,a=e.getUTCHours();switch(n=12===a?dayPeriodEnum.noon:0===a?dayPeriodEnum.midnight:a/12>=1?"pm":"am",t){case"b":case"bb":return r.dayPeriod(n,{width:"abbreviated",context:"formatting"});case"bbb":return r.dayPeriod(n,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return r.dayPeriod(n,{width:"narrow",context:"formatting"});default:return r.dayPeriod(n,{width:"wide",context:"formatting"})}},B:function(e,t,r){var n,a=e.getUTCHours();switch(n=a>=17?dayPeriodEnum.evening:a>=12?dayPeriodEnum.afternoon:a>=4?dayPeriodEnum.morning:dayPeriodEnum.night,t){case"B":case"BB":case"BBB":return r.dayPeriod(n,{width:"abbreviated",context:"formatting"});case"BBBBB":return r.dayPeriod(n,{width:"narrow",context:"formatting"});default:return r.dayPeriod(n,{width:"wide",context:"formatting"})}},h:function(e,t,r){if("ho"===t){var n=e.getUTCHours()%12;return 0===n&&(n=12),r.ordinalNumber(n,{unit:"hour"})}return formatters$3.h(e,t)},H:function(e,t,r){return"Ho"===t?r.ordinalNumber(e.getUTCHours(),{unit:"hour"}):formatters$3.H(e,t)},K:function(e,t,r){var n=e.getUTCHours()%12;return"Ko"===t?r.ordinalNumber(n,{unit:"hour"}):addLeadingZeros(n,t.length)},k:function(e,t,r){var n=e.getUTCHours();return 0===n&&(n=24),"ko"===t?r.ordinalNumber(n,{unit:"hour"}):addLeadingZeros(n,t.length)},m:function(e,t,r){return"mo"===t?r.ordinalNumber(e.getUTCMinutes(),{unit:"minute"}):formatters$3.m(e,t)},s:function(e,t,r){return"so"===t?r.ordinalNumber(e.getUTCSeconds(),{unit:"second"}):formatters$3.s(e,t)},S:function(e,t){return formatters$3.S(e,t)},X:function(e,t,r,n){var a=(n._originalDate||e).getTimezoneOffset();if(0===a)return"Z";switch(t){case"X":return formatTimezoneWithOptionalMinutes(a);case"XXXX":case"XX":return formatTimezone(a);default:return formatTimezone(a,":")}},x:function(e,t,r,n){var a=(n._originalDate||e).getTimezoneOffset();switch(t){case"x":return formatTimezoneWithOptionalMinutes(a);case"xxxx":case"xx":return formatTimezone(a);default:return formatTimezone(a,":")}},O:function(e,t,r,n){var a=(n._originalDate||e).getTimezoneOffset();switch(t){case"O":case"OO":case"OOO":return"GMT"+formatTimezoneShort(a,":");default:return"GMT"+formatTimezone(a,":")}},z:function(e,t,r,n){var a=(n._originalDate||e).getTimezoneOffset();switch(t){case"z":case"zz":case"zzz":return"GMT"+formatTimezoneShort(a,":");default:return"GMT"+formatTimezone(a,":")}},t:function(e,t,r,n){var a=n._originalDate||e;return addLeadingZeros(Math.floor(a.getTime()/1e3),t.length)},T:function(e,t,r,n){return addLeadingZeros((n._originalDate||e).getTime(),t.length)}};function formatTimezoneShort(e,t){var r=e>0?"-":"+",n=Math.abs(e),a=Math.floor(n/60),s=n%60;if(0===s)return r+String(a);var i=t||"";return r+String(a)+i+addLeadingZeros(s,2)}function formatTimezoneWithOptionalMinutes(e,t){return e%60==0?(e>0?"-":"+")+addLeadingZeros(Math.abs(e)/60,2):formatTimezone(e,t)}function formatTimezone(e,t){var r=t||"",n=e>0?"-":"+",a=Math.abs(e);return n+addLeadingZeros(Math.floor(a/60),2)+r+addLeadingZeros(a%60,2)}var formatters$1=formatters,dateLongFormatter=function(e,t){switch(e){case"P":return t.date({width:"short"});case"PP":return t.date({width:"medium"});case"PPP":return t.date({width:"long"});default:return t.date({width:"full"})}},timeLongFormatter=function(e,t){switch(e){case"p":return t.time({width:"short"});case"pp":return t.time({width:"medium"});case"ppp":return t.time({width:"long"});default:return t.time({width:"full"})}},dateTimeLongFormatter=function(e,t){var r,n=e.match(/(P+)(p+)?/)||[],a=n[1],s=n[2];if(!s)return dateLongFormatter(e,t);switch(a){case"P":r=t.dateTime({width:"short"});break;case"PP":r=t.dateTime({width:"medium"});break;case"PPP":r=t.dateTime({width:"long"});break;default:r=t.dateTime({width:"full"})}return r.replace("{{date}}",dateLongFormatter(a,t)).replace("{{time}}",timeLongFormatter(s,t))},longFormatters={p:timeLongFormatter,P:dateTimeLongFormatter},longFormatters$1=longFormatters,protectedDayOfYearTokens=["D","DD"],protectedWeekYearTokens=["YY","YYYY"];function isProtectedDayOfYearToken(e){return-1!==protectedDayOfYearTokens.indexOf(e)}function isProtectedWeekYearToken(e){return-1!==protectedWeekYearTokens.indexOf(e)}function throwProtectedError(e,t,r){if("YYYY"===e)throw new RangeError("Use `yyyy` instead of `YYYY` (in `".concat(t,"`) for formatting years to the input `").concat(r,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"));if("YY"===e)throw new RangeError("Use `yy` instead of `YY` (in `".concat(t,"`) for formatting years to the input `").concat(r,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"));if("D"===e)throw new RangeError("Use `d` instead of `D` (in `".concat(t,"`) for formatting days of the month to the input `").concat(r,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"));if("DD"===e)throw new RangeError("Use `dd` instead of `DD` (in `".concat(t,"`) for formatting days of the month to the input `").concat(r,"`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md"))}var formatDistanceLocale={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},formatDistance=function(e,t,r){var n,a=formatDistanceLocale[e];return n="string"==typeof a?a:1===t?a.one:a.other.replace("{{count}}",t.toString()),null!=r&&r.addSuffix?r.comparison&&r.comparison>0?"in "+n:n+" ago":n},formatDistance$1=formatDistance;function buildFormatLongFn(e){return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.width?String(t.width):e.defaultWidth;return e.formats[r]||e.formats[e.defaultWidth]}}var dateFormats={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},timeFormats={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},dateTimeFormats={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},formatLong={date:buildFormatLongFn({formats:dateFormats,defaultWidth:"full"}),time:buildFormatLongFn({formats:timeFormats,defaultWidth:"full"}),dateTime:buildFormatLongFn({formats:dateTimeFormats,defaultWidth:"full"})},formatLong$1=formatLong,formatRelativeLocale={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},formatRelative=function(e,t,r,n){return formatRelativeLocale[e]},formatRelative$1=formatRelative;function buildLocalizeFn(e){return function(t,r){var n;if("formatting"===(null!=r&&r.context?String(r.context):"standalone")&&e.formattingValues){var a=e.defaultFormattingWidth||e.defaultWidth,s=null!=r&&r.width?String(r.width):a;n=e.formattingValues[s]||e.formattingValues[a]}else{var i=e.defaultWidth,o=null!=r&&r.width?String(r.width):e.defaultWidth;n=e.values[o]||e.values[i]}return n[e.argumentCallback?e.argumentCallback(t):t]}}var eraValues={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},quarterValues={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},monthValues={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},dayValues={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},dayPeriodValues={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},formattingDayPeriodValues={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},ordinalNumber=function(e,t){var r=Number(e),n=r%100;if(n>20||n<10)switch(n%10){case 1:return r+"st";case 2:return r+"nd";case 3:return r+"rd"}return r+"th"},localize={ordinalNumber:ordinalNumber,era:buildLocalizeFn({values:eraValues,defaultWidth:"wide"}),quarter:buildLocalizeFn({values:quarterValues,defaultWidth:"wide",argumentCallback:function(e){return e-1}}),month:buildLocalizeFn({values:monthValues,defaultWidth:"wide"}),day:buildLocalizeFn({values:dayValues,defaultWidth:"wide"}),dayPeriod:buildLocalizeFn({values:dayPeriodValues,defaultWidth:"wide",formattingValues:formattingDayPeriodValues,defaultFormattingWidth:"wide"})},localize$1=localize;function buildMatchFn(e){return function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.width,a=n&&e.matchPatterns[n]||e.matchPatterns[e.defaultMatchWidth],s=t.match(a);if(!s)return null;var i,o=s[0],c=n&&e.parsePatterns[n]||e.parsePatterns[e.defaultParseWidth],u=Array.isArray(c)?findIndex(c,(function(e){return e.test(o)})):findKey(c,(function(e){return e.test(o)}));return i=e.valueCallback?e.valueCallback(u):u,{value:i=r.valueCallback?r.valueCallback(i):i,rest:t.slice(o.length)}}}function findKey(e,t){for(var r in e)if(e.hasOwnProperty(r)&&t(e[r]))return r}function findIndex(e,t){for(var r=0;r<e.length;r++)if(t(e[r]))return r}function buildMatchPatternFn(e){return function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.match(e.matchPattern);if(!n)return null;var a=n[0],s=t.match(e.parsePattern);if(!s)return null;var i=e.valueCallback?e.valueCallback(s[0]):s[0];return{value:i=r.valueCallback?r.valueCallback(i):i,rest:t.slice(a.length)}}}var matchOrdinalNumberPattern=/^(\d+)(th|st|nd|rd)?/i,parseOrdinalNumberPattern=/\d+/i,matchEraPatterns={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},parseEraPatterns={any:[/^b/i,/^(a|c)/i]},matchQuarterPatterns={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},parseQuarterPatterns={any:[/1/i,/2/i,/3/i,/4/i]},matchMonthPatterns={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},parseMonthPatterns={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},matchDayPatterns={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},parseDayPatterns={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},matchDayPeriodPatterns={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},parseDayPeriodPatterns={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},match={ordinalNumber:buildMatchPatternFn({matchPattern:matchOrdinalNumberPattern,parsePattern:parseOrdinalNumberPattern,valueCallback:function(e){return parseInt(e,10)}}),era:buildMatchFn({matchPatterns:matchEraPatterns,defaultMatchWidth:"wide",parsePatterns:parseEraPatterns,defaultParseWidth:"any"}),quarter:buildMatchFn({matchPatterns:matchQuarterPatterns,defaultMatchWidth:"wide",parsePatterns:parseQuarterPatterns,defaultParseWidth:"any",valueCallback:function(e){return e+1}}),month:buildMatchFn({matchPatterns:matchMonthPatterns,defaultMatchWidth:"wide",parsePatterns:parseMonthPatterns,defaultParseWidth:"any"}),day:buildMatchFn({matchPatterns:matchDayPatterns,defaultMatchWidth:"wide",parsePatterns:parseDayPatterns,defaultParseWidth:"any"}),dayPeriod:buildMatchFn({matchPatterns:matchDayPeriodPatterns,defaultMatchWidth:"any",parsePatterns:parseDayPeriodPatterns,defaultParseWidth:"any"})},match$1=match,locale={code:"en-US",formatDistance:formatDistance$1,formatLong:formatLong$1,formatRelative:formatRelative$1,localize:localize$1,match:match$1,options:{weekStartsOn:0,firstWeekContainsDate:1}},defaultLocale=locale,formattingTokensRegExp$1=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,longFormattingTokensRegExp$1=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,escapedStringRegExp$1=/^'([^]*?)'?$/,doubleQuoteRegExp$1=/''/g,unescapedLatinCharacterRegExp$1=/[a-zA-Z]/;function format(e,t,r){var n,a,s,i,o,c,u,l,p,d,h,f,y,m,g,w,T,E;requiredArgs(2,arguments);var v=String(t),_=getDefaultOptions(),C=null!==(n=null!==(a=null==r?void 0:r.locale)&&void 0!==a?a:_.locale)&&void 0!==n?n:defaultLocale,b=toInteger(null!==(s=null!==(i=null!==(o=null!==(c=null==r?void 0:r.firstWeekContainsDate)&&void 0!==c?c:null==r||null===(u=r.locale)||void 0===u||null===(l=u.options)||void 0===l?void 0:l.firstWeekContainsDate)&&void 0!==o?o:_.firstWeekContainsDate)&&void 0!==i?i:null===(p=_.locale)||void 0===p||null===(d=p.options)||void 0===d?void 0:d.firstWeekContainsDate)&&void 0!==s?s:1);if(!(b>=1&&b<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var S=toInteger(null!==(h=null!==(f=null!==(y=null!==(m=null==r?void 0:r.weekStartsOn)&&void 0!==m?m:null==r||null===(g=r.locale)||void 0===g||null===(w=g.options)||void 0===w?void 0:w.weekStartsOn)&&void 0!==y?y:_.weekStartsOn)&&void 0!==f?f:null===(T=_.locale)||void 0===T||null===(E=T.options)||void 0===E?void 0:E.weekStartsOn)&&void 0!==h?h:0);if(!(S>=0&&S<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");if(!C.localize)throw new RangeError("locale must contain localize property");if(!C.formatLong)throw new RangeError("locale must contain formatLong property");var N=toDate(e);if(!isValid(N))throw new RangeError("Invalid time value");var O=subMilliseconds(N,getTimezoneOffsetInMilliseconds(N)),I={firstWeekContainsDate:b,weekStartsOn:S,locale:C,_originalDate:N};return v.match(longFormattingTokensRegExp$1).map((function(e){var t=e[0];return"p"===t||"P"===t?(0,longFormatters$1[t])(e,C.formatLong):e})).join("").match(formattingTokensRegExp$1).map((function(n){if("''"===n)return"'";var a=n[0];if("'"===a)return cleanEscapedString$1(n);var s=formatters$1[a];if(s)return null!=r&&r.useAdditionalWeekYearTokens||!isProtectedWeekYearToken(n)||throwProtectedError(n,t,String(e)),null!=r&&r.useAdditionalDayOfYearTokens||!isProtectedDayOfYearToken(n)||throwProtectedError(n,t,String(e)),s(O,n,C.localize,I);if(a.match(unescapedLatinCharacterRegExp$1))throw new RangeError("Format string contains an unescaped latin alphabet character `"+a+"`");return n})).join("")}function cleanEscapedString$1(e){var t=e.match(escapedStringRegExp$1);return t?t[1].replace(doubleQuoteRegExp$1,"'"):e}function assign(e,t){if(null==e)throw new TypeError("assign requires that input parameter not be null or undefined");for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,i=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return i=e.done,e},e:function(e){o=!0,s=e},f:function(){try{i||null==r.return||r.return()}finally{if(o)throw s}}}}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _isNativeReflectConstruct(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(_isNativeReflectConstruct=function(){return!!e})()}function _possibleConstructorReturn(e,t){if(t&&("object"==_typeof(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _createSuper(e){var t=_isNativeReflectConstruct();return function(){var r,n=_getPrototypeOf(e);if(t){var a=_getPrototypeOf(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return _possibleConstructorReturn(this,r)}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function toPropertyKey(e){var t=toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,r){return(t=toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var TIMEZONE_UNIT_PRIORITY=10,Setter=function(){function e(){_classCallCheck(this,e),_defineProperty(this,"priority",void 0),_defineProperty(this,"subPriority",0)}return _createClass(e,[{key:"validate",value:function(e,t){return!0}}]),e}(),ValueSetter=function(e){_inherits(r,e);var t=_createSuper(r);function r(e,n,a,s,i){var o;return _classCallCheck(this,r),(o=t.call(this)).value=e,o.validateValue=n,o.setValue=a,o.priority=s,i&&(o.subPriority=i),o}return _createClass(r,[{key:"validate",value:function(e,t){return this.validateValue(e,this.value,t)}},{key:"set",value:function(e,t,r){return this.setValue(e,t,this.value,r)}}]),r}(Setter),DateToSystemTimezoneSetter=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",TIMEZONE_UNIT_PRIORITY),_defineProperty(_assertThisInitialized(e),"subPriority",-1),e}return _createClass(r,[{key:"set",value:function(e,t){if(t.timestampIsSet)return e;var r=new Date(0);return r.setFullYear(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()),r.setHours(e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds()),r}}]),r}(Setter),Parser=function(){function e(){_classCallCheck(this,e),_defineProperty(this,"incompatibleTokens",void 0),_defineProperty(this,"priority",void 0),_defineProperty(this,"subPriority",void 0)}return _createClass(e,[{key:"run",value:function(e,t,r,n){var a=this.parse(e,t,r,n);return a?{setter:new ValueSetter(a.value,this.validate,this.set,this.priority,this.subPriority),rest:a.rest}:null}},{key:"validate",value:function(e,t,r){return!0}}]),e}(),EraParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",140),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["R","u","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"G":case"GG":case"GGG":return r.era(e,{width:"abbreviated"})||r.era(e,{width:"narrow"});case"GGGGG":return r.era(e,{width:"narrow"});default:return r.era(e,{width:"wide"})||r.era(e,{width:"abbreviated"})||r.era(e,{width:"narrow"})}}},{key:"set",value:function(e,t,r){return t.era=r,e.setUTCFullYear(r,0,1),e.setUTCHours(0,0,0,0),e}}]),r}(Parser),numericPatterns={month:/^(1[0-2]|0?\d)/,date:/^(3[0-1]|[0-2]?\d)/,dayOfYear:/^(36[0-6]|3[0-5]\d|[0-2]?\d?\d)/,week:/^(5[0-3]|[0-4]?\d)/,hour23h:/^(2[0-3]|[0-1]?\d)/,hour24h:/^(2[0-4]|[0-1]?\d)/,hour11h:/^(1[0-1]|0?\d)/,hour12h:/^(1[0-2]|0?\d)/,minute:/^[0-5]?\d/,second:/^[0-5]?\d/,singleDigit:/^\d/,twoDigits:/^\d{1,2}/,threeDigits:/^\d{1,3}/,fourDigits:/^\d{1,4}/,anyDigitsSigned:/^-?\d+/,singleDigitSigned:/^-?\d/,twoDigitsSigned:/^-?\d{1,2}/,threeDigitsSigned:/^-?\d{1,3}/,fourDigitsSigned:/^-?\d{1,4}/},timezonePatterns={basicOptionalMinutes:/^([+-])(\d{2})(\d{2})?|Z/,basic:/^([+-])(\d{2})(\d{2})|Z/,basicOptionalSeconds:/^([+-])(\d{2})(\d{2})((\d{2}))?|Z/,extended:/^([+-])(\d{2}):(\d{2})|Z/,extendedOptionalSeconds:/^([+-])(\d{2}):(\d{2})(:(\d{2}))?|Z/};function mapValue(e,t){return e?{value:t(e.value),rest:e.rest}:e}function parseNumericPattern(e,t){var r=t.match(e);return r?{value:parseInt(r[0],10),rest:t.slice(r[0].length)}:null}function parseTimezonePattern(e,t){var r=t.match(e);if(!r)return null;if("Z"===r[0])return{value:0,rest:t.slice(1)};var n="+"===r[1]?1:-1,a=r[2]?parseInt(r[2],10):0,s=r[3]?parseInt(r[3],10):0,i=r[5]?parseInt(r[5],10):0;return{value:n*(a*millisecondsInHour+s*millisecondsInMinute+i*millisecondsInSecond),rest:t.slice(r[0].length)}}function parseAnyDigitsSigned(e){return parseNumericPattern(numericPatterns.anyDigitsSigned,e)}function parseNDigits(e,t){switch(e){case 1:return parseNumericPattern(numericPatterns.singleDigit,t);case 2:return parseNumericPattern(numericPatterns.twoDigits,t);case 3:return parseNumericPattern(numericPatterns.threeDigits,t);case 4:return parseNumericPattern(numericPatterns.fourDigits,t);default:return parseNumericPattern(new RegExp("^\\d{1,"+e+"}"),t)}}function parseNDigitsSigned(e,t){switch(e){case 1:return parseNumericPattern(numericPatterns.singleDigitSigned,t);case 2:return parseNumericPattern(numericPatterns.twoDigitsSigned,t);case 3:return parseNumericPattern(numericPatterns.threeDigitsSigned,t);case 4:return parseNumericPattern(numericPatterns.fourDigitsSigned,t);default:return parseNumericPattern(new RegExp("^-?\\d{1,"+e+"}"),t)}}function dayPeriodEnumToHours(e){switch(e){case"morning":return 4;case"evening":return 17;case"pm":case"noon":case"afternoon":return 12;default:return 0}}function normalizeTwoDigitYear(e,t){var r,n=t>0,a=n?t:1-t;if(a<=50)r=e||100;else{var s=a+50;r=e+100*Math.floor(s/100)-(e>=s%100?100:0)}return n?r:1-r}function isLeapYearIndex(e){return e%400==0||e%4==0&&e%100!=0}var YearParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",130),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["Y","R","u","w","I","i","e","c","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){var n=function(e){return{year:e,isTwoDigitYear:"yy"===t}};switch(t){case"y":return mapValue(parseNDigits(4,e),n);case"yo":return mapValue(r.ordinalNumber(e,{unit:"year"}),n);default:return mapValue(parseNDigits(t.length,e),n)}}},{key:"validate",value:function(e,t){return t.isTwoDigitYear||t.year>0}},{key:"set",value:function(e,t,r){var n=e.getUTCFullYear();if(r.isTwoDigitYear){var a=normalizeTwoDigitYear(r.year,n);return e.setUTCFullYear(a,0,1),e.setUTCHours(0,0,0,0),e}var s="era"in t&&1!==t.era?1-r.year:r.year;return e.setUTCFullYear(s,0,1),e.setUTCHours(0,0,0,0),e}}]),r}(Parser),LocalWeekYearParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",130),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["y","R","u","Q","q","M","L","I","d","D","i","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){var n=function(e){return{year:e,isTwoDigitYear:"YY"===t}};switch(t){case"Y":return mapValue(parseNDigits(4,e),n);case"Yo":return mapValue(r.ordinalNumber(e,{unit:"year"}),n);default:return mapValue(parseNDigits(t.length,e),n)}}},{key:"validate",value:function(e,t){return t.isTwoDigitYear||t.year>0}},{key:"set",value:function(e,t,r,n){var a=getUTCWeekYear(e,n);if(r.isTwoDigitYear){var s=normalizeTwoDigitYear(r.year,a);return e.setUTCFullYear(s,0,n.firstWeekContainsDate),e.setUTCHours(0,0,0,0),startOfUTCWeek(e,n)}var i="era"in t&&1!==t.era?1-r.year:r.year;return e.setUTCFullYear(i,0,n.firstWeekContainsDate),e.setUTCHours(0,0,0,0),startOfUTCWeek(e,n)}}]),r}(Parser),ISOWeekYearParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",130),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["G","y","Y","u","Q","q","M","L","w","d","D","e","c","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t){return parseNDigitsSigned("R"===t?4:t.length,e)}},{key:"set",value:function(e,t,r){var n=new Date(0);return n.setUTCFullYear(r,0,4),n.setUTCHours(0,0,0,0),startOfUTCISOWeek(n)}}]),r}(Parser),ExtendedYearParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",130),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["G","y","Y","R","w","I","i","e","c","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t){return parseNDigitsSigned("u"===t?4:t.length,e)}},{key:"set",value:function(e,t,r){return e.setUTCFullYear(r,0,1),e.setUTCHours(0,0,0,0),e}}]),r}(Parser),QuarterParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",120),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["Y","R","q","M","L","w","I","d","D","i","e","c","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"Q":case"QQ":return parseNDigits(t.length,e);case"Qo":return r.ordinalNumber(e,{unit:"quarter"});case"QQQ":return r.quarter(e,{width:"abbreviated",context:"formatting"})||r.quarter(e,{width:"narrow",context:"formatting"});case"QQQQQ":return r.quarter(e,{width:"narrow",context:"formatting"});default:return r.quarter(e,{width:"wide",context:"formatting"})||r.quarter(e,{width:"abbreviated",context:"formatting"})||r.quarter(e,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(e,t){return t>=1&&t<=4}},{key:"set",value:function(e,t,r){return e.setUTCMonth(3*(r-1),1),e.setUTCHours(0,0,0,0),e}}]),r}(Parser),StandAloneQuarterParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",120),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["Y","R","Q","M","L","w","I","d","D","i","e","c","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"q":case"qq":return parseNDigits(t.length,e);case"qo":return r.ordinalNumber(e,{unit:"quarter"});case"qqq":return r.quarter(e,{width:"abbreviated",context:"standalone"})||r.quarter(e,{width:"narrow",context:"standalone"});case"qqqqq":return r.quarter(e,{width:"narrow",context:"standalone"});default:return r.quarter(e,{width:"wide",context:"standalone"})||r.quarter(e,{width:"abbreviated",context:"standalone"})||r.quarter(e,{width:"narrow",context:"standalone"})}}},{key:"validate",value:function(e,t){return t>=1&&t<=4}},{key:"set",value:function(e,t,r){return e.setUTCMonth(3*(r-1),1),e.setUTCHours(0,0,0,0),e}}]),r}(Parser),MonthParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"incompatibleTokens",["Y","R","q","Q","L","w","I","D","i","e","c","t","T"]),_defineProperty(_assertThisInitialized(e),"priority",110),e}return _createClass(r,[{key:"parse",value:function(e,t,r){var n=function(e){return e-1};switch(t){case"M":return mapValue(parseNumericPattern(numericPatterns.month,e),n);case"MM":return mapValue(parseNDigits(2,e),n);case"Mo":return mapValue(r.ordinalNumber(e,{unit:"month"}),n);case"MMM":return r.month(e,{width:"abbreviated",context:"formatting"})||r.month(e,{width:"narrow",context:"formatting"});case"MMMMM":return r.month(e,{width:"narrow",context:"formatting"});default:return r.month(e,{width:"wide",context:"formatting"})||r.month(e,{width:"abbreviated",context:"formatting"})||r.month(e,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(e,t){return t>=0&&t<=11}},{key:"set",value:function(e,t,r){return e.setUTCMonth(r,1),e.setUTCHours(0,0,0,0),e}}]),r}(Parser),StandAloneMonthParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",110),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["Y","R","q","Q","M","w","I","D","i","e","c","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){var n=function(e){return e-1};switch(t){case"L":return mapValue(parseNumericPattern(numericPatterns.month,e),n);case"LL":return mapValue(parseNDigits(2,e),n);case"Lo":return mapValue(r.ordinalNumber(e,{unit:"month"}),n);case"LLL":return r.month(e,{width:"abbreviated",context:"standalone"})||r.month(e,{width:"narrow",context:"standalone"});case"LLLLL":return r.month(e,{width:"narrow",context:"standalone"});default:return r.month(e,{width:"wide",context:"standalone"})||r.month(e,{width:"abbreviated",context:"standalone"})||r.month(e,{width:"narrow",context:"standalone"})}}},{key:"validate",value:function(e,t){return t>=0&&t<=11}},{key:"set",value:function(e,t,r){return e.setUTCMonth(r,1),e.setUTCHours(0,0,0,0),e}}]),r}(Parser);function setUTCWeek(e,t,r){requiredArgs(2,arguments);var n=toDate(e),a=toInteger(t),s=getUTCWeek(n,r)-a;return n.setUTCDate(n.getUTCDate()-7*s),n}var LocalWeekParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",100),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","i","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"w":return parseNumericPattern(numericPatterns.week,e);case"wo":return r.ordinalNumber(e,{unit:"week"});default:return parseNDigits(t.length,e)}}},{key:"validate",value:function(e,t){return t>=1&&t<=53}},{key:"set",value:function(e,t,r,n){return startOfUTCWeek(setUTCWeek(e,r,n),n)}}]),r}(Parser);function setUTCISOWeek(e,t){requiredArgs(2,arguments);var r=toDate(e),n=toInteger(t),a=getUTCISOWeek(r)-n;return r.setUTCDate(r.getUTCDate()-7*a),r}var ISOWeekParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",100),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["y","Y","u","q","Q","M","L","w","d","D","e","c","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"I":return parseNumericPattern(numericPatterns.week,e);case"Io":return r.ordinalNumber(e,{unit:"week"});default:return parseNDigits(t.length,e)}}},{key:"validate",value:function(e,t){return t>=1&&t<=53}},{key:"set",value:function(e,t,r){return startOfUTCISOWeek(setUTCISOWeek(e,r))}}]),r}(Parser),DAYS_IN_MONTH=[31,28,31,30,31,30,31,31,30,31,30,31],DAYS_IN_MONTH_LEAP_YEAR=[31,29,31,30,31,30,31,31,30,31,30,31],DateParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",90),_defineProperty(_assertThisInitialized(e),"subPriority",1),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["Y","R","q","Q","w","I","D","i","e","c","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"d":return parseNumericPattern(numericPatterns.date,e);case"do":return r.ordinalNumber(e,{unit:"date"});default:return parseNDigits(t.length,e)}}},{key:"validate",value:function(e,t){var r=isLeapYearIndex(e.getUTCFullYear()),n=e.getUTCMonth();return r?t>=1&&t<=DAYS_IN_MONTH_LEAP_YEAR[n]:t>=1&&t<=DAYS_IN_MONTH[n]}},{key:"set",value:function(e,t,r){return e.setUTCDate(r),e.setUTCHours(0,0,0,0),e}}]),r}(Parser),DayOfYearParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",90),_defineProperty(_assertThisInitialized(e),"subpriority",1),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["Y","R","q","Q","M","L","w","I","d","E","i","e","c","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"D":case"DD":return parseNumericPattern(numericPatterns.dayOfYear,e);case"Do":return r.ordinalNumber(e,{unit:"date"});default:return parseNDigits(t.length,e)}}},{key:"validate",value:function(e,t){return isLeapYearIndex(e.getUTCFullYear())?t>=1&&t<=366:t>=1&&t<=365}},{key:"set",value:function(e,t,r){return e.setUTCMonth(0,r),e.setUTCHours(0,0,0,0),e}}]),r}(Parser);function setUTCDay(e,t,r){var n,a,s,i,o,c,u,l;requiredArgs(2,arguments);var p=getDefaultOptions(),d=toInteger(null!==(n=null!==(a=null!==(s=null!==(i=null==r?void 0:r.weekStartsOn)&&void 0!==i?i:null==r||null===(o=r.locale)||void 0===o||null===(c=o.options)||void 0===c?void 0:c.weekStartsOn)&&void 0!==s?s:p.weekStartsOn)&&void 0!==a?a:null===(u=p.locale)||void 0===u||null===(l=u.options)||void 0===l?void 0:l.weekStartsOn)&&void 0!==n?n:0);if(!(d>=0&&d<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var h=toDate(e),f=toInteger(t),y=((f%7+7)%7<d?7:0)+f-h.getUTCDay();return h.setUTCDate(h.getUTCDate()+y),h}var DayParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",90),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["D","i","e","c","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"E":case"EE":case"EEE":return r.day(e,{width:"abbreviated",context:"formatting"})||r.day(e,{width:"short",context:"formatting"})||r.day(e,{width:"narrow",context:"formatting"});case"EEEEE":return r.day(e,{width:"narrow",context:"formatting"});case"EEEEEE":return r.day(e,{width:"short",context:"formatting"})||r.day(e,{width:"narrow",context:"formatting"});default:return r.day(e,{width:"wide",context:"formatting"})||r.day(e,{width:"abbreviated",context:"formatting"})||r.day(e,{width:"short",context:"formatting"})||r.day(e,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(e,t){return t>=0&&t<=6}},{key:"set",value:function(e,t,r,n){return(e=setUTCDay(e,r,n)).setUTCHours(0,0,0,0),e}}]),r}(Parser),LocalDayParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",90),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","E","i","c","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r,n){var a=function(e){var t=7*Math.floor((e-1)/7);return(e+n.weekStartsOn+6)%7+t};switch(t){case"e":case"ee":return mapValue(parseNDigits(t.length,e),a);case"eo":return mapValue(r.ordinalNumber(e,{unit:"day"}),a);case"eee":return r.day(e,{width:"abbreviated",context:"formatting"})||r.day(e,{width:"short",context:"formatting"})||r.day(e,{width:"narrow",context:"formatting"});case"eeeee":return r.day(e,{width:"narrow",context:"formatting"});case"eeeeee":return r.day(e,{width:"short",context:"formatting"})||r.day(e,{width:"narrow",context:"formatting"});default:return r.day(e,{width:"wide",context:"formatting"})||r.day(e,{width:"abbreviated",context:"formatting"})||r.day(e,{width:"short",context:"formatting"})||r.day(e,{width:"narrow",context:"formatting"})}}},{key:"validate",value:function(e,t){return t>=0&&t<=6}},{key:"set",value:function(e,t,r,n){return(e=setUTCDay(e,r,n)).setUTCHours(0,0,0,0),e}}]),r}(Parser),StandAloneLocalDayParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",90),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","E","i","e","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r,n){var a=function(e){var t=7*Math.floor((e-1)/7);return(e+n.weekStartsOn+6)%7+t};switch(t){case"c":case"cc":return mapValue(parseNDigits(t.length,e),a);case"co":return mapValue(r.ordinalNumber(e,{unit:"day"}),a);case"ccc":return r.day(e,{width:"abbreviated",context:"standalone"})||r.day(e,{width:"short",context:"standalone"})||r.day(e,{width:"narrow",context:"standalone"});case"ccccc":return r.day(e,{width:"narrow",context:"standalone"});case"cccccc":return r.day(e,{width:"short",context:"standalone"})||r.day(e,{width:"narrow",context:"standalone"});default:return r.day(e,{width:"wide",context:"standalone"})||r.day(e,{width:"abbreviated",context:"standalone"})||r.day(e,{width:"short",context:"standalone"})||r.day(e,{width:"narrow",context:"standalone"})}}},{key:"validate",value:function(e,t){return t>=0&&t<=6}},{key:"set",value:function(e,t,r,n){return(e=setUTCDay(e,r,n)).setUTCHours(0,0,0,0),e}}]),r}(Parser);function setUTCISODay(e,t){requiredArgs(2,arguments);var r=toInteger(t);r%7==0&&(r-=7);var n=toDate(e),a=((r%7+7)%7<1?7:0)+r-n.getUTCDay();return n.setUTCDate(n.getUTCDate()+a),n}var ISODayParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",90),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["y","Y","u","q","Q","M","L","w","d","D","E","e","c","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){var n=function(e){return 0===e?7:e};switch(t){case"i":case"ii":return parseNDigits(t.length,e);case"io":return r.ordinalNumber(e,{unit:"day"});case"iii":return mapValue(r.day(e,{width:"abbreviated",context:"formatting"})||r.day(e,{width:"short",context:"formatting"})||r.day(e,{width:"narrow",context:"formatting"}),n);case"iiiii":return mapValue(r.day(e,{width:"narrow",context:"formatting"}),n);case"iiiiii":return mapValue(r.day(e,{width:"short",context:"formatting"})||r.day(e,{width:"narrow",context:"formatting"}),n);default:return mapValue(r.day(e,{width:"wide",context:"formatting"})||r.day(e,{width:"abbreviated",context:"formatting"})||r.day(e,{width:"short",context:"formatting"})||r.day(e,{width:"narrow",context:"formatting"}),n)}}},{key:"validate",value:function(e,t){return t>=1&&t<=7}},{key:"set",value:function(e,t,r){return(e=setUTCISODay(e,r)).setUTCHours(0,0,0,0),e}}]),r}(Parser),AMPMParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",80),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["b","B","H","k","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"a":case"aa":case"aaa":return r.dayPeriod(e,{width:"abbreviated",context:"formatting"})||r.dayPeriod(e,{width:"narrow",context:"formatting"});case"aaaaa":return r.dayPeriod(e,{width:"narrow",context:"formatting"});default:return r.dayPeriod(e,{width:"wide",context:"formatting"})||r.dayPeriod(e,{width:"abbreviated",context:"formatting"})||r.dayPeriod(e,{width:"narrow",context:"formatting"})}}},{key:"set",value:function(e,t,r){return e.setUTCHours(dayPeriodEnumToHours(r),0,0,0),e}}]),r}(Parser),AMPMMidnightParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",80),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["a","B","H","k","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"b":case"bb":case"bbb":return r.dayPeriod(e,{width:"abbreviated",context:"formatting"})||r.dayPeriod(e,{width:"narrow",context:"formatting"});case"bbbbb":return r.dayPeriod(e,{width:"narrow",context:"formatting"});default:return r.dayPeriod(e,{width:"wide",context:"formatting"})||r.dayPeriod(e,{width:"abbreviated",context:"formatting"})||r.dayPeriod(e,{width:"narrow",context:"formatting"})}}},{key:"set",value:function(e,t,r){return e.setUTCHours(dayPeriodEnumToHours(r),0,0,0),e}}]),r}(Parser),DayPeriodParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",80),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["a","b","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"B":case"BB":case"BBB":return r.dayPeriod(e,{width:"abbreviated",context:"formatting"})||r.dayPeriod(e,{width:"narrow",context:"formatting"});case"BBBBB":return r.dayPeriod(e,{width:"narrow",context:"formatting"});default:return r.dayPeriod(e,{width:"wide",context:"formatting"})||r.dayPeriod(e,{width:"abbreviated",context:"formatting"})||r.dayPeriod(e,{width:"narrow",context:"formatting"})}}},{key:"set",value:function(e,t,r){return e.setUTCHours(dayPeriodEnumToHours(r),0,0,0),e}}]),r}(Parser),Hour1to12Parser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",70),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["H","K","k","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"h":return parseNumericPattern(numericPatterns.hour12h,e);case"ho":return r.ordinalNumber(e,{unit:"hour"});default:return parseNDigits(t.length,e)}}},{key:"validate",value:function(e,t){return t>=1&&t<=12}},{key:"set",value:function(e,t,r){var n=e.getUTCHours()>=12;return n&&r<12?e.setUTCHours(r+12,0,0,0):n||12!==r?e.setUTCHours(r,0,0,0):e.setUTCHours(0,0,0,0),e}}]),r}(Parser),Hour0to23Parser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",70),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["a","b","h","K","k","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"H":return parseNumericPattern(numericPatterns.hour23h,e);case"Ho":return r.ordinalNumber(e,{unit:"hour"});default:return parseNDigits(t.length,e)}}},{key:"validate",value:function(e,t){return t>=0&&t<=23}},{key:"set",value:function(e,t,r){return e.setUTCHours(r,0,0,0),e}}]),r}(Parser),Hour0To11Parser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",70),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["h","H","k","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"K":return parseNumericPattern(numericPatterns.hour11h,e);case"Ko":return r.ordinalNumber(e,{unit:"hour"});default:return parseNDigits(t.length,e)}}},{key:"validate",value:function(e,t){return t>=0&&t<=11}},{key:"set",value:function(e,t,r){return e.getUTCHours()>=12&&r<12?e.setUTCHours(r+12,0,0,0):e.setUTCHours(r,0,0,0),e}}]),r}(Parser),Hour1To24Parser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",70),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["a","b","h","H","K","t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"k":return parseNumericPattern(numericPatterns.hour24h,e);case"ko":return r.ordinalNumber(e,{unit:"hour"});default:return parseNDigits(t.length,e)}}},{key:"validate",value:function(e,t){return t>=1&&t<=24}},{key:"set",value:function(e,t,r){var n=r<=24?r%24:r;return e.setUTCHours(n,0,0,0),e}}]),r}(Parser),MinuteParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",60),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"m":return parseNumericPattern(numericPatterns.minute,e);case"mo":return r.ordinalNumber(e,{unit:"minute"});default:return parseNDigits(t.length,e)}}},{key:"validate",value:function(e,t){return t>=0&&t<=59}},{key:"set",value:function(e,t,r){return e.setUTCMinutes(r,0,0),e}}]),r}(Parser),SecondParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",50),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t,r){switch(t){case"s":return parseNumericPattern(numericPatterns.second,e);case"so":return r.ordinalNumber(e,{unit:"second"});default:return parseNDigits(t.length,e)}}},{key:"validate",value:function(e,t){return t>=0&&t<=59}},{key:"set",value:function(e,t,r){return e.setUTCSeconds(r,0),e}}]),r}(Parser),FractionOfSecondParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",30),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["t","T"]),e}return _createClass(r,[{key:"parse",value:function(e,t){return mapValue(parseNDigits(t.length,e),(function(e){return Math.floor(e*Math.pow(10,3-t.length))}))}},{key:"set",value:function(e,t,r){return e.setUTCMilliseconds(r),e}}]),r}(Parser),ISOTimezoneWithZParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",10),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["t","T","x"]),e}return _createClass(r,[{key:"parse",value:function(e,t){switch(t){case"X":return parseTimezonePattern(timezonePatterns.basicOptionalMinutes,e);case"XX":return parseTimezonePattern(timezonePatterns.basic,e);case"XXXX":return parseTimezonePattern(timezonePatterns.basicOptionalSeconds,e);case"XXXXX":return parseTimezonePattern(timezonePatterns.extendedOptionalSeconds,e);default:return parseTimezonePattern(timezonePatterns.extended,e)}}},{key:"set",value:function(e,t,r){return t.timestampIsSet?e:new Date(e.getTime()-r)}}]),r}(Parser),ISOTimezoneParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",10),_defineProperty(_assertThisInitialized(e),"incompatibleTokens",["t","T","X"]),e}return _createClass(r,[{key:"parse",value:function(e,t){switch(t){case"x":return parseTimezonePattern(timezonePatterns.basicOptionalMinutes,e);case"xx":return parseTimezonePattern(timezonePatterns.basic,e);case"xxxx":return parseTimezonePattern(timezonePatterns.basicOptionalSeconds,e);case"xxxxx":return parseTimezonePattern(timezonePatterns.extendedOptionalSeconds,e);default:return parseTimezonePattern(timezonePatterns.extended,e)}}},{key:"set",value:function(e,t,r){return t.timestampIsSet?e:new Date(e.getTime()-r)}}]),r}(Parser),TimestampSecondsParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",40),_defineProperty(_assertThisInitialized(e),"incompatibleTokens","*"),e}return _createClass(r,[{key:"parse",value:function(e){return parseAnyDigitsSigned(e)}},{key:"set",value:function(e,t,r){return[new Date(1e3*r),{timestampIsSet:!0}]}}]),r}(Parser),TimestampMillisecondsParser=function(e){_inherits(r,e);var t=_createSuper(r);function r(){var e;_classCallCheck(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return _defineProperty(_assertThisInitialized(e=t.call.apply(t,[this].concat(a))),"priority",20),_defineProperty(_assertThisInitialized(e),"incompatibleTokens","*"),e}return _createClass(r,[{key:"parse",value:function(e){return parseAnyDigitsSigned(e)}},{key:"set",value:function(e,t,r){return[new Date(r),{timestampIsSet:!0}]}}]),r}(Parser),parsers={G:new EraParser,y:new YearParser,Y:new LocalWeekYearParser,R:new ISOWeekYearParser,u:new ExtendedYearParser,Q:new QuarterParser,q:new StandAloneQuarterParser,M:new MonthParser,L:new StandAloneMonthParser,w:new LocalWeekParser,I:new ISOWeekParser,d:new DateParser,D:new DayOfYearParser,E:new DayParser,e:new LocalDayParser,c:new StandAloneLocalDayParser,i:new ISODayParser,a:new AMPMParser,b:new AMPMMidnightParser,B:new DayPeriodParser,h:new Hour1to12Parser,H:new Hour0to23Parser,K:new Hour0To11Parser,k:new Hour1To24Parser,m:new MinuteParser,s:new SecondParser,S:new FractionOfSecondParser,X:new ISOTimezoneWithZParser,x:new ISOTimezoneParser,t:new TimestampSecondsParser,T:new TimestampMillisecondsParser},formattingTokensRegExp=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,longFormattingTokensRegExp=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,escapedStringRegExp=/^'([^]*?)'?$/,doubleQuoteRegExp=/''/g,notWhitespaceRegExp=/\S/,unescapedLatinCharacterRegExp=/[a-zA-Z]/;function parse(e,t,r,n){var a,s,i,o,c,u,l,p,d,h,f,y,m,g,w,T,E,v;requiredArgs(3,arguments);var _=String(e),C=String(t),b=getDefaultOptions(),S=null!==(a=null!==(s=null==n?void 0:n.locale)&&void 0!==s?s:b.locale)&&void 0!==a?a:defaultLocale;if(!S.match)throw new RangeError("locale must contain match property");var N=toInteger(null!==(i=null!==(o=null!==(c=null!==(u=null==n?void 0:n.firstWeekContainsDate)&&void 0!==u?u:null==n||null===(l=n.locale)||void 0===l||null===(p=l.options)||void 0===p?void 0:p.firstWeekContainsDate)&&void 0!==c?c:b.firstWeekContainsDate)&&void 0!==o?o:null===(d=b.locale)||void 0===d||null===(h=d.options)||void 0===h?void 0:h.firstWeekContainsDate)&&void 0!==i?i:1);if(!(N>=1&&N<=7))throw new RangeError("firstWeekContainsDate must be between 1 and 7 inclusively");var O=toInteger(null!==(f=null!==(y=null!==(m=null!==(g=null==n?void 0:n.weekStartsOn)&&void 0!==g?g:null==n||null===(w=n.locale)||void 0===w||null===(T=w.options)||void 0===T?void 0:T.weekStartsOn)&&void 0!==m?m:b.weekStartsOn)&&void 0!==y?y:null===(E=b.locale)||void 0===E||null===(v=E.options)||void 0===v?void 0:v.weekStartsOn)&&void 0!==f?f:0);if(!(O>=0&&O<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");if(""===C)return""===_?toDate(r):new Date(NaN);var I,P={firstWeekContainsDate:N,weekStartsOn:O,locale:S},x=[new DateToSystemTimezoneSetter],A=C.match(longFormattingTokensRegExp).map((function(e){var t=e[0];return t in longFormatters$1?(0,longFormatters$1[t])(e,S.formatLong):e})).join("").match(formattingTokensRegExp),D=[],k=_createForOfIteratorHelper(A);try{var R=function(){var t=I.value;null!=n&&n.useAdditionalWeekYearTokens||!isProtectedWeekYearToken(t)||throwProtectedError(t,C,e),null!=n&&n.useAdditionalDayOfYearTokens||!isProtectedDayOfYearToken(t)||throwProtectedError(t,C,e);var r=t[0],a=parsers[r];if(a){var s=a.incompatibleTokens;if(Array.isArray(s)){var i=D.find((function(e){return s.includes(e.token)||e.token===r}));if(i)throw new RangeError("The format string mustn't contain `".concat(i.fullToken,"` and `").concat(t,"` at the same time"))}else if("*"===a.incompatibleTokens&&D.length>0)throw new RangeError("The format string mustn't contain `".concat(t,"` and any other token at the same time"));D.push({token:r,fullToken:t});var o=a.run(_,t,S.match,P);if(!o)return{v:new Date(NaN)};x.push(o.setter),_=o.rest}else{if(r.match(unescapedLatinCharacterRegExp))throw new RangeError("Format string contains an unescaped latin alphabet character `"+r+"`");if("''"===t?t="'":"'"===r&&(t=cleanEscapedString(t)),0!==_.indexOf(t))return{v:new Date(NaN)};_=_.slice(t.length)}};for(k.s();!(I=k.n()).done;){var L=R();if("object"===_typeof(L))return L.v}}catch(e){k.e(e)}finally{k.f()}if(_.length>0&&notWhitespaceRegExp.test(_))return new Date(NaN);var M=x.map((function(e){return e.priority})).sort((function(e,t){return t-e})).filter((function(e,t,r){return r.indexOf(e)===t})).map((function(e){return x.filter((function(t){return t.priority===e})).sort((function(e,t){return t.subPriority-e.subPriority}))})).map((function(e){return e[0]})),U=toDate(r);if(isNaN(U.getTime()))return new Date(NaN);var F,V=subMilliseconds(U,getTimezoneOffsetInMilliseconds(U)),$={},B=_createForOfIteratorHelper(M);try{for(B.s();!(F=B.n()).done;){var Y=F.value;if(!Y.validate(V,P))return new Date(NaN);var z=Y.set(V,$,P);Array.isArray(z)?(V=z[0],assign($,z[1])):V=z}}catch(e){B.e(e)}finally{B.f()}return V}function cleanEscapedString(e){return e.match(escapedStringRegExp)[1].replace(doubleQuoteRegExp,"'")}const numericParser=(e,t)=>{const r=t?.groupingSeparator?t.groupingSeparator:",",n=t?.decimalSeparator?t.decimalSeparator:".",a=new RegExp(`-{0,1}([0-9]+\\${r}{0,1})*\\d+(\\${n}\\d+)*`,"gm"),s=e.replace(/\s/g,"").match(a);if(!s)throw new InValidFormatError("number",e);let i=s[0].replace(/[^\d\-.,]/g,"");return","==n&&"."==r?(i=i.replace(/\./g,","),i=i.replace(/,/g,".")):"."==n&&","==r&&(i=i.replace(/,/g,"")),i=i.replace(/\.(?=.*\.)/g,""),Number(i)},currencyParser=(e,t)=>{const r=numericParser(e,t);if(!r)throw new InValidFormatError("currency",e);return Math.round(100*r)/100},booleanParser=async(e,t)=>await runExpressions([t.expr],{vars:[{name:"str",dataType:"string",value:e}]}),textParser=e=>String(e),dateParser=(e,t)=>{const r=t?.format||"MM-dd-yyyy",n=parse(e,r,new Date);if(!(isValid(n)&&e===format(n,r)))throw new InValidFormatError("date",e);return n},urlParser=e=>{try{return new URL(e)}catch(t){throw new InValidSyntaxError("URL",e,t.message)}},jsonParser=e=>{try{return JSON.parse(e)}catch(e){throw new InValidSyntaxError("JSON",null,e.message)}},DATA_PARSERS={[Type.string]:textParser,[Type.number]:numericParser,[Type.currency]:currencyParser,[Type.date]:dateParser,[Type.url]:urlParser,[Type.boolean]:booleanParser,[Type.json]:jsonParser};class DataParser extends Proc{data_type;parser;constructor(e,t,r,n){super(e,t),this.data_type=r,this.parser=n}isDatatypeSupported(){const e=getPrimitive(this.data_type);return PRIMITIVES.includes(e)&&DATA_PARSERS.hasOwnProperty(e)}async parse(){try{if(!this.isDatatypeSupported())throw new UnsupportedDataTypeError(this.data_type);if(!isValidData(this.data))throw new DataNotFoundError("Data not found for parsing");if(isArrayType(this.data_type)){const e=getPrimitive(this.data_type),t=[];for(const r of this.data)t.push(await DATA_PARSERS[e](r,this.parser));return t}return await DATA_PARSERS[this.data_type](this.data,this.parser)}catch(e){throw StackedError.handle(e,"parser")}}}function getPrimitive(e){return isArrayType(e)?e.slice(6,-1):e}function isValidData(e){return Array.isArray(e)?e.every((e=>isValidData(e))):"string"==typeof e}class DataValidator extends Proc{validator;data_type;constructor(e,t,r,n){super(e,t),this.validator=n,this.data_type=r}async validate(){try{if(!this.validator)return!0;if(this.validator?.required&&!this.data)throw new DataValidationError(`Empty value not allowed for ${this.tag.name}.`);if(!this.validator.exprs?.length)return!0;let e=this.data_type,t=[this.data];e===Type.number?e="float":isArrayType(this.data_type)?(e=getPrimitive$1(this.data_type),t=this.data):e=resolveAlias(this.data_type);for(const r of t)await runExpressions(this.validator.exprs,{vars:[{name:"val",dataType:e,value:r}]})}catch(e){throw StackedError.handle(e,"validator")}}}async function applyMappers(e,t){return await new DataMapper(e.tag,t,e.procs?.mappers).map()}async function applyReducers(e,t){return await new DataReducer(e.tag,t,e?.procs?.reducer).reduce()}async function applyParser(e,t){return await new DataParser(e.tag,t,e?.data_type,e?.procs.parser).parse()}async function validateTagData(e,t){await new DataValidator(e.tag,t,e?.data_type,e?.procs?.validator).validate()}const TagTypeLeafNode="leaf",TagTypeListOfObject="list",TagTypeSchema="schema";class ExtractionContext{document;currentNode;parentContext;scoped=!0;hook;constructor(e){if(!document)throw new Error("cannot create ExtractionContext without a document or document fragment");this.document=e.document,this.currentNode=e.currentNode,this.parentContext=e.parentContext,this.hook=e.hook}setNoScope(){this.scoped=!1}setScoped(){this.scoped=!0}newContext(e,t){return new ExtractionContext({document:t||e.ownerDocument,currentNode:e,parentContext:this,hook:this.hook})}getDocument(){return this.document}querySelector(e,t={scoped:!0}){let r=this.scoped;return void 0!==t.scoped&&(r=t.scoped),this.currentNode&&r?this.currentNode.querySelector(e):this.document.querySelector(e)}querySelectorAll(e,t={scoped:!0}){let r=this.scoped;return void 0!==t.scoped&&(r=t.scoped),this.currentNode&&r?this.currentNode.querySelectorAll(e):this.document.querySelectorAll(e)}evaluateXPath(e,t={scoped:!0}){let r=this.currentNode||this.document;this.scoped&&t.scoped||(r=this.document);const n=this.document.evaluate(e,r,null,XPathResult.ANY_TYPE,null);let a=n.iterateNext();const s=[];for(;a&&a.nodeType==document.ELEMENT_NODE;)s.push(a),a=n.iterateNext();return s}}const EXTRACT_STAGE={END:"end"};class LeafNodeProperty{id;tag;name;procs;data_type;metadata;field;_parent;constructor(e,t,r,n,a=Type.string,s=null){this.id=e,this.name=t,this.tag=r,this.procs=n,this.data_type=a,this.field=s}type(){return TagTypeLeafNode}get parent(){return this._parent}setParent(e){this._parent=e}async applyProcessors(e){try{const t=await applyMappers(this,e);let r;r=this.procs.reducer?await applyReducers(this,t):t;let n=await applyParser(this,r);return await validateTagData(this,n),n instanceof Date&&(n=n.toISOString()),n}catch(e){throw StackedError.handle(e,"processor")}}async _extract(e){const t=new DataExtractor(this.tag,e.document,e),r=await t.extract(this.field);return Array.isArray(r)?r.map((e=>e.trim())):[r.trim()]}async extract(e){try{const t=await this._extract(e);return await this.applyProcessors(t)}catch(e){throw StackedError.handle(e,"tag",{id:this.tag.id,name:this.tag.name,version:this.tag.version,schema_property_id:this.id})}}toJSON(){return{id:this.id,name:this.name,tag:this.tag,procs:this.procs,field:this.field,data_type:this.data_type,type:TagTypeLeafNode}}}class ListOfObjectsProperty{id;properties;tag;name;treeConversionStrategy;_parent;constructor(e,t,r,n,a){this.id=e,this.name=t,this.tag=r,this.properties=n,this.treeConversionStrategy=a;for(const e of Object.getOwnPropertyNames(this.properties))this.properties[e].setParent(this)}get parent(){return this._parent}setParent(e){this._parent=e}type(){return TagTypeListOfObject}async extract(e){let t=[];const r=new DataExtractor(this.tag,e.document,e),n=await r.getElements(this.tag);for(let r=0;r<n.length;r++){const a={},s=n[r];if(s){for(const t of Object.getOwnPropertyNames(this.properties)){const n=e.newContext(s);a[t]=await this.properties[t].extract(n),a.metadata={depth:getElementDepth(s),rank:r}}t.push(a),await(e.hook?.(EXTRACT_STAGE.END,{elements:[s],tag:this.tag}))}}this.treeConversionStrategy&&(t=this.treeConversionStrategy.toTree(t));const a=e=>{const t={...e};return delete t.metadata,t.children?.length>0&&(t.children=t.children.map(a)),t};return t.map(a)}toJSON(){return{id:this.id,name:this.name,tag:this.tag,properties:this.properties,type:TagTypeListOfObject}}}class Schema{properties;constructor(e){this.properties=e;for(const e of Object.getOwnPropertyNames(this.properties))this.properties[e].setParent(this)}type(){return TagTypeSchema}async extract(e){const t={};for(const r of Object.getOwnPropertyNames(this.properties))t[r]=await this.properties[r].extract(e);return t}toJSON(){return{properties:this.properties,type:TagTypeSchema}}}const context2PropertyMap=new Map,id2PropertyMap=new Map;function addToContextPropertyMap(e,t){context2PropertyMap.has(e)?context2PropertyMap.get(e).push(t):context2PropertyMap.set(e,[t])}function addToIdMap(e,t){id2PropertyMap.set(e,t)}async function scrape(e,t={document:document}){if(t.document||(t.document=document),!context2PropertyMap.has(e))return[null,null];try{const r={},n=context2PropertyMap.get(e);for(let e=0;e<n.length;e++){const a=new ExtractionContext(t);r[n[e].id]=await n[e].extract(a)}return[r,null]}catch(e){return[null,e.toJSON()]}}let ContentLeafNodeProperty$1=class extends LeafNodeProperty{constructor(e,t,r,n,a=Type.string,s){super(e,t,r,n,a,s),addToIdMap(this.id,this)}},ContentListOfObjectsProperty$1=class extends ListOfObjectsProperty{constructor(e,t,r,n,a){super(e,t,r,n,a),addToIdMap(this.id,this)}};function convertPOJOToSchema$1(e){if(e.type===TagTypeLeafNode){const t=new ContentLeafNodeProperty$1(e.id,e.name,e.tag,e.procs,e.data_type,e.field);return t.id=e.id,t}if(e.type===TagTypeListOfObject){const t={};for(const r in e.properties)t[r]=convertPOJOToSchema$1(e.properties[r]);const r=new ContentListOfObjectsProperty$1(e.id,e.name,e.tag,t,null);return r.id=e.id,r}}function parseSchema$1(e){context2PropertyMap.clear(),id2PropertyMap.clear();const t={};for(const r in e.properties)t[r]=convertPOJOToSchema$1(e.properties[r]);const r=new Schema(t);return id2PropertyMap.forEach((e=>{switch(e.type()){case TagTypeLeafNode:case TagTypeListOfObject:let t=e.parent;for(;t&&"list"!==t.type();)t=t.parent;if("list"===t?.type())return;addToContextPropertyMap(e.tag.context,e)}})),r}var extractor=Object.freeze({__proto__:null,ContentLeafNodeProperty:ContentLeafNodeProperty$1,ContentListOfObjectsProperty:ContentListOfObjectsProperty$1,parseSchema:parseSchema$1,scrape:scrape});class ContentLeafNodeProperty extends LeafNodeProperty{data;constructor(e,t,r,n,a=Type.string,s){super(e,t,r,n,a,s),this.data=isArrayType(a)?[]:void 0}setData(e){isArrayType(this.data_type)?this.data=this.data.concat(e):this.data=e}toJSON(){return{...super.toJSON(),data:this.data}}}class ContentListOfObjectsProperty extends ListOfObjectsProperty{data;constructor(e,t,r,n,a){super(e,t,r,n,a),this.data=[]}setData(e){this.data=this.data.concat(e)}toJSON(){return{...super.toJSON(),data:this.data}}}class ContentSchema extends Schema{id2PropertyMap;constructor(e,t){super(e),this.id2PropertyMap=t}getID2PropertyMap(){return this.id2PropertyMap}getData(){const e={};for(const t in this.properties){const r=this.properties[t];e[t]=r.data}return e}}function convertPOJOToSchema(e,t){if(e.type===TagTypeLeafNode){const r=new ContentLeafNodeProperty(e.id,e.name,e.tag,e.procs,e.data_type,e.field);return r.id=e.id,t.set(r.id,r),r}if(e.type===TagTypeListOfObject){const r={};for(const n in e.properties)r[n]=convertPOJOToSchema(e.properties[n],t);const n=new ContentListOfObjectsProperty(e.id,e.name,e.tag,r);return n.id=e.id,t.set(n.id,n),n}throw new Error(`Unknown property type: ${e.type}`)}function parseSchema(e){const t=new Map,r={};for(const n in e.properties)r[n]=convertPOJOToSchema(e.properties[n],t);return new ContentSchema(r,t)}var extractorBG=Object.freeze({__proto__:null,ContentLeafNodeProperty:ContentLeafNodeProperty,ContentListOfObjectsProperty:ContentListOfObjectsProperty,ContentSchema:ContentSchema,parseSchema:parseSchema}),_virtual_index={types:types,expressions:expressions,common:common,macro:macro,workflow:workflow,scraper:scraper,extractor:extractor,extractorBG:extractorBG};return _virtual_index}));
