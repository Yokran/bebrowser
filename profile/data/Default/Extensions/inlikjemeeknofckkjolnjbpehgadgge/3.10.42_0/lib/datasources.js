!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).datasources=t()}(this,(function(){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var t,r,n={exports:{}};function o(){if(r)return t;r=1;var e=1e3,n=60*e,o=60*n,s=24*o,a=7*s,i=365.25*s;function c(e,t,r,n){var o=t>=1.5*r;return Math.round(e/r)+" "+n+(o?"s":"")}return t=function(t,r){r=r||{};var u=typeof t;if("string"===u&&t.length>0)return function(t){if((t=String(t)).length>100)return;var r=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(!r)return;var c=parseFloat(r[1]);switch((r[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return c*i;case"weeks":case"week":case"w":return c*a;case"days":case"day":case"d":return c*s;case"hours":case"hour":case"hrs":case"hr":case"h":return c*o;case"minutes":case"minute":case"mins":case"min":case"m":return c*n;case"seconds":case"second":case"secs":case"sec":case"s":return c*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}(t);if("number"===u&&isFinite(t))return r.long?function(t){var r=Math.abs(t);if(r>=s)return c(t,r,s,"day");if(r>=o)return c(t,r,o,"hour");if(r>=n)return c(t,r,n,"minute");if(r>=e)return c(t,r,e,"second");return t+" ms"}(t):function(t){var r=Math.abs(t);if(r>=s)return Math.round(t/s)+"d";if(r>=o)return Math.round(t/o)+"h";if(r>=n)return Math.round(t/n)+"m";if(r>=e)return Math.round(t/e)+"s";return t+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))}}var s=function(e){function t(e){let n,o,s,a=null;function i(...e){if(!i.enabled)return;const r=i,o=Number(new Date),s=o-(n||o);r.diff=s,r.prev=n,r.curr=o,n=o,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let a=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((n,o)=>{if("%%"===n)return"%";a++;const s=t.formatters[o];if("function"==typeof s){const t=e[a];n=s.call(r,t),e.splice(a,1),a--}return n})),t.formatArgs.call(r,e);(r.log||t.log).apply(r,e)}return i.namespace=e,i.useColors=t.useColors(),i.color=t.selectColor(e),i.extend=r,i.destroy=t.destroy,Object.defineProperty(i,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==a?a:(o!==t.namespaces&&(o=t.namespaces,s=t.enabled(e)),s),set:e=>{a=e}}),"function"==typeof t.init&&t.init(i),i}function r(e,r){const n=t(this.namespace+(void 0===r?":":r)+e);return n.log=this.log,n}function n(e,t){let r=0,n=0,o=-1,s=0;for(;r<e.length;)if(n<t.length&&(t[n]===e[r]||"*"===t[n]))"*"===t[n]?(o=n,s=r,n++):(r++,n++);else{if(-1===o)return!1;n=o+1,s++,r=s}for(;n<t.length&&"*"===t[n];)n++;return n===t.length}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names,...t.skips.map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){t.save(e),t.namespaces=e,t.names=[],t.skips=[];const r=("string"==typeof e?e:"").trim().replace(" ",",").split(",").filter(Boolean);for(const e of r)"-"===e[0]?t.skips.push(e.slice(1)):t.names.push(e)},t.enabled=function(e){for(const r of t.skips)if(n(e,r))return!1;for(const r of t.names)if(n(e,r))return!0;return!1},t.humanize=o(),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((r=>{t[r]=e[r]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return t.colors[Math.abs(r)%t.colors.length]},t.enable(t.load()),t};!function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;t.splice(1,0,r,"color: inherit");let n=0,o=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(n++,"%c"===e&&(o=n))})),t.splice(o,0,r)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let e;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(e[1],10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=s(t);const{formatters:r}=e.exports;r.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}(n,n.exports);var a=e(n.exports);class i{type(){throw new Error("not implemented")}async handle(e,t,r){}}const c=["CERT_HAS_EXPIRED","CERT_UNTRUSTED","ERR_TLS_CERT_ALTNAME_INVALID","DEPTH_ZERO_SELF_SIGNED_CERT","DEPTH_ZERO_SELF_SIGNED_CERT","SELF_SIGNED_CERT_IN_CHAIN","EPROTO"],u="Unable to connected to internet",l="Request timed out";class d extends Error{constructor(e,t,r=null){super(e),this.code=t,this.details=r}toJSON(){return{name:this.constructor.name,code:this.code,message:this.message,details:this.details}}}class f extends d{constructor(e="invalid params passed",t="E_INVALID_PARAMS"){super(e,t)}}class h extends d{constructor(e,t){const r=p(e);super(e.message,r,t),this.retryable=function(e){switch(e){case"ERR_SOCKET_TIMEOUT":case"ETIMEDOUT":return!0}return!1}(r)}toJSON(){return{...super.toJSON(),retryable:this.retryable}}}function p(e){let t=e.errno;return"FETCH_ERROR"===t&&"request-timeout"===e.type||"ERR_SOCKET_TIMEOUT"===t?t="ETIMEDOUT":c.includes(t)&&(t="ESSLCERT"),t||e.message}const C={json:"application/json",urlencoded:"application/x-www-form-urlencoded"},y={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8","Accept-Encoding":"gzip, deflate, br","Accept-Language":"en-US,en;q=0.5","Cache-Control":"no-cache",DNT:"1","Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"none","Sec-Fetch-User":"?1","Upgrade-Insecure-Requests":"1","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0"};let m,g;function w(e){return e.useWrapper?function({fetch:e,serializeResponse:t}={}){return async r=>{let{uri:n,config:o,request:s}=r;s||(s=o.request??{method:"GET",body:{type:"none"},headers:[],timeout:3e4});let{method:a="GET",body:i={type:"none"},headers:c=[],timeout:u,redirect:l="follow"}=s;if(!n)throw new f("a `uri` must be passed ");const d=function(e){const t={};return e?(e.filter((([e,t])=>!!e)).forEach((([e,r])=>{t[e]=r})),t):t}(c);let h,p;if("GET"!=a){let e,{data:t,type:r}=i;switch(d["content-type"]=C[i.type],r){case"json":h=JSON.stringify(i.data);break;case"urlencoded":e=new URLSearchParams;for(let[r,n]of t)e.append(r,n);h=e.toString()}}try{p=structuredClone(y)}catch(e){p=JSON.parse(JSON.stringify(y))}const m=await e({uri:n,fetchOpts:{method:a,cache:"no-cache",headers:{...p,...d},timeout:u,body:h,proxy:r?.proxyGateway,redirect:l},opts:r});return m instanceof Response||t?{url:m.url,status:m.status,statusText:m.statusText,headers:Array.from(m.headers.entries()).reduce(((e,[t,r])=>(e[t]=r,e)),{}),text:await m.text()}:m}}(e):e}function F(e){const t=e?.status?.code??0;return 0===t||t>=400}async function x({timeout:e,proxyGateway:t}={}){const r={uri:"https://1.1.1.1",config:{request:{timeout:e}}};try{return await m({...r,proxyGateway:t}),!0}catch(e){return!1}}const E={100:"Continue",101:"Switching Protocols",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported"};const b=a("ds:json");a("err:ds:json");const T="json";class v extends i{type(){return T}async handle(e){let t,r;e.retryCount??=0,b("json.handle",e),e.getProxy&&(e.proxyGateway=await e.getProxy(this,{retryCount:e.retryCount}));try{return t=await m(e),F({status:{code:t.status},headers:t.headers})&&(e.getProxy&&(e.proxyGateway=await e.getProxy(this,{retryCount:e.retryCount+1})),t=await g(e)),r=t.text,JSON.parse(r)}catch(n){console.error("fetch error",n,n.type,t?.status,r);throw await x()?"TIMEOUT"===n.message&&(n.message=l):n.message=u,new h(n,{uri:e.uri,request:e.request,text:r})}}}const _=a("ds:uptime");a("err:ds:uptime");const S="uptime";class R extends i{type(){return S}async handle(e){e.retryCount??=0,_("uptime.handle",e),e.getProxy&&(e.proxyGateway=await e.getProxy(this,{retryCount:e.retryCount})),e.config??={},e.config.request??={},e.config.request.redirect="manual";let t=await this._handle(e,{useAltFetch:!1});const{code:r}=t.status;if(407===r||0===r){_("retrying on error:",e.id,t.status);if(!await x({timeout:e.config?.request?.timeout||6e4}))throw new h({message:u});await new Promise(((e,t)=>setTimeout(e,5e3)));let n=!1;if(e.proxyGateway&&(n=await x({proxyGateway:e.proxyGateway,timeout:e.config?.request?.timeout||6e4})),n){if(407!==r)return await this._handle(e,{useAltFetch:!1});if(407===r)throw new h({errno:"EPROXY",message:"Proxy Authentication Required"})}else e.retryCount++,e.proxyGateway=!1,t=this._handle(e)}else if(F(t))return await this._handle(e,{useAltFetch:!0});return t}async _handle(e,{useAltFetch:t=!1}={}){let r={status:{},headers:{},body:null};try{let o;o=t?await g(e):await m(e),r.status.code=o.status,r.status.message=o.statusText||(n=o.status,E[n]),r.headers=o.headers,r.body=o.text}catch(e){r.status.code=0;let t=p(e);"TIMEOUT"===t&&(t=l),r.status.message=t}var n;return r}}const O=a("ds:text"),A=a("err:ds:text"),N="text";class I extends i{type(){return N}async handle(e){let t;e.retryCount??=0,O("text.handle",e),e.getProxy&&(e.proxyGateway=await e.getProxy(this,{retryCount:e.retryCount}));try{return t=await m(e),F({status:{code:t.status},headers:t.headers})&&(e.getProxy&&(e.proxyGateway=await e.getProxy(this,{retryCount:e.retryCount+1})),t=await g(e)),t}catch(r){A("fetch error",r,r.type,t?.status,t?.text);throw await x()?"TIMEOUT"===r.message&&(r.message=l):r.message=u,new h(r,{uri:e.uri,request:e.request,text:t?.text})}}}const P=a("datasource");a("err:datasource");const q={};function M(e){if(!e)throw new f("invalid datasource type passed");if(q[e])return q[e]();throw new f("no matching datasource found: "+e)}function U(e,t,r,n=!1){let o,s=r||{},a=s;for(let i=0;i<t.length;i++){let c=t[i];if(c.includes("[]?")){if(void 0===e)throw new Error("Data Undefined");if(o=c.split("[]?")[0],o?(e=e[o],a[o]||(a[o]=[]),a=a[o]):r||(s=[],a=s),t[i+1]){let r=t.splice(i+1);0!==a.length?e.forEach(((e,t)=>U(e,[...r],a[t],!0))):e.forEach((e=>a.push(U(e,[...r],void 0,!0))))}else e.forEach((e=>a.push(e)))}else if(""!==c){if(void 0===(e=e[c])){if(n)return s;throw new Error("Data Undefined")}G(e)&&t[i+1]?(a[c]||(a[c]={}),a=a[c]):a[c]=e}}return s}function G(e){return"Object"===Object.prototype.toString.call(e).slice(8,-1)}return q[T]=(...e)=>new v(...e),q[S]=(...e)=>new R(...e),q[N]=(...e)=>new I(...e),{...Object.freeze({__proto__:null,DatasourceType:"datasourceType",fetchData:async function({type:e,fetchOpts:t,params:r,configuration:n}){P("fetchData",{fetchOpts:t,params:r,configuration:n});const o=M(e);return await o.handle(t,r,n)},findDatasource:M,registerFetch:({fetch:e,altFetch:t})=>{m=w(e),g=t?w(t):m}}),...Object.freeze({__proto__:null,applyFilter:U,applyFilters:function(e,t){let r="Array"===function(e){return Object.prototype.toString.call(e).slice(8,-1)}(e)?[]:{},n=[];if(1===t.length&&"."===t[0])return e;let o=structuredClone(r);return t.forEach((t=>{if(!function(e,t){let r=!1;for(let n of e)if(t.startsWith(n)){r=!0;break}return r}(n,t)){let s=function(e){return e=e.replace(/"/g,""),e.split(".")}(t);try{r=U(e,s,r),o=structuredClone(r)}catch(e){r=structuredClone(o)}n.push(t)}})),r}})}}));
