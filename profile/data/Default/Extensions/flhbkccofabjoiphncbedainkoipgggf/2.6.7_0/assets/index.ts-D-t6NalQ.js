import{m as f,k as m,T as y,M as U,w as A,p as I,h as C,e as ee}from"./const-BL87qZqA.js";import{b as te,A as se,I as ae,h as ne,g as re,C as ie,y as oe,m as ce,u as ue,p as O,d as _,P as $}from"./index-4Xml3FNN.js";function le(s){const{hostMatch:e,extensionId:t,extensionName:a}=s;chrome.tabs.onUpdated.addListener(async(r,i,n)=>{if(n&&n.url&&n&&n.url&&i&&i.status==="loading"){const c=new URL(n.url).hostname;if(e.find(o=>!!~o.indexOf(c))){const o=chrome.runtime.getManifest();chrome.scripting.executeScript({injectImmediately:!0,world:"MAIN",target:{tabId:r,allFrames:!0},func:d=>{window[d.slug]=d},args:[{id:chrome.runtime.id,slug:t,extensionName:a,version:o.version,icons:o.icons,extensionFolderUri:chrome.runtime.getURL("/"),isProdMode:"update_url"in chrome.runtime.getManifest()}]})}}})}var Q=(s=>(s[s.FREE=0]="FREE",s[s.BASIC=1]="BASIC",s[s.PREMIUM=2]="PREMIUM",s))(Q||{});const de={type:"object",properties:{uid:{type:"string",default:""},email:{type:"string",default:""},stripeId:{type:"string",default:""},name:{type:"string",default:""},payments:{type:"array",items:{type:"object",properties:{},required:[],default:{}},default:[]},plan:{type:"string",default:Q.FREE},isSubscriptionActive:{type:"boolean",default:!1},lastCheckAt:{type:"number",default:0}},required:["uid","email","stripeId","name","payments","plan","isSubscriptionActive","lastCheckAt"],default:{}},me={type:"object",properties:{},required:[],default:{}},ge={type:"object",properties:{},required:[],default:{}},x={customerDataV2:de,features:me,persistLocalStorage:ge};function q(s,e){Object.keys(s).map(t=>e(s[t],t,s))}function P(s,e){function t(i,n){switch(i.type){case"object":return a(i,n);case"array":return r(i,n);default:return n!==void 0?n:i.default!==void 0?i.default:void 0}}function a(i,n){const c={},o=i.properties??{};return q(o,(d,p)=>{if(i.required.includes(p)||n!==void 0&&n[p]!==void 0){let u=n!==void 0?n[p]:void 0;!d.properties&&d.default&&d.type==="object"&&d.additionalProperties&&(u=d.default),c[p]=t(d,u)}}),n&&q(n,(d,p)=>{c[p]===void 0&&d!==void 0&&(c[p]=d)}),c}function r(i,n){if(n===void 0)return i.default?i.default:void 0;const c=[];for(let o=0;o<n.length;o++)c.push(t(i.items??{},n[o]));return c}return t(e,s)}const D="__storage-local-version";function fe(s){const e=Object.keys(s);chrome.runtime.onInstalled.addListener(a=>{(a.reason==="install"||a.reason==="update")&&t()});async function t(){let a=(await chrome.storage.local.get(D))[D];const r=chrome.runtime.getManifest().version;if(r!==a){const i=await chrome.storage.local.get(e),n=e.reduce((c,o)=>{let d=i[o]||{};return d=P(d,s[o]),c[o]=d,c},{[D]:r});await chrome.storage.local.set(n)}}}function E(s,e){async function t(n){let c;return await navigator.locks.request(k(n),{mode:"shared"},async()=>{c=(await N(n))[n]}),c===void 0&&(c=P(c,s[n])),c}async function a(n,c){await navigator.locks.request(k(n),{mode:"exclusive"},async()=>{let o=(await N(n))[n];o===void 0&&(o=P(o,s[n]));const d=await c(o);e&&e(n,"update",d),await chrome.storage.local.set({[n]:d})})}async function r(n,c){await navigator.locks.request(k(n),{mode:"exclusive"},async()=>{let o=c||{};c||(o=P(o,s[n])),e&&e(n,"update",o),await chrome.storage.local.set({[n]:o})})}async function i(n){return await navigator.locks.request(k(n),{mode:"exclusive"},async()=>{e&&e(n,"delete",void 0),await chrome.storage.local.remove([n])}),Promise.resolve()}return{updateBucket:a,setBucket:r,getBucket:t,deleteBucket:i}}function k(s){return`storage.local.${s}`}function N(s){return new Promise(e=>{chrome.storage.local.get(s,t=>{e(t)})})}function Y(){return Math.floor(new Date().getTime()/1e3)}function V(s){return s+86400<Y()}async function he(s){const e=await chrome.tabs.query({url:s.filter(t=>!~t.indexOf("esuit"))});for(let t of e)t.id&&await chrome.tabs.reload(t.id)}let S=[];const{updateBucket:K,getBucket:F,deleteBucket:J}=E(x);function pe(s){f("logout",async()=>{await J("customerDataV2"),await J("features")}),f("login",async()=>{const e=new URLSearchParams({[U.RETURN_EXT_LOCAL]:chrome.runtime.id}).toString();await chrome.tabs.create({url:`https://esuit.dev/login?${e}`,active:!0})}),f("closePopup",async()=>{chrome.extension.getViews({type:"popup"}).forEach(e=>{e.window.close()})}),f("openOptionsPage",async e=>{const t=chrome.runtime.getURL("src/pages/options/index.html"+(e?"#showSubscription=1":""));(await chrome.tabs.query({url:[t]})).forEach(a=>(a==null?void 0:a.id)&&chrome.tabs.remove(a.id)),await new Promise(a=>setTimeout(a,300)),await chrome.tabs.create({url:t,active:!0})}),f("getCustomerData",async()=>{const e=await F("customerDataV2");if(e.uid)return V(e.lastCheckAt)&&m("reFetchCustomerData"),e}),f("reFetchCustomerData",async(e=!1)=>{const t=await F("customerDataV2"),a=t.uid;if(!a)return!1;if(!e&&a&&!V(t.lastCheckAt))return!0;let r=null,i=null;try{const[o,d]=await Promise.all([fetch(`https://getusersubscription-57pphaecyq-uc.a.run.app/?token=${te(a,s.projectId)}`).then(p=>p.json()),ye()]);if(o.stripeId&&(r=o),d){const p=d.find(u=>u.projectId===s.projectId);p&&(i=p)}}catch(o){return console.error(o),"Unknown error, please contact the developer."}if(!r||!i)return"ERROR: reFetchCustomerData returned undefined";let n=r.allPayments.filter(o=>se(o.status)||ae(o.status)||ne(o.status)||re(o.status)||ie(o.status)),c=y.FREE;return H(n,i,y.BASIC)&&(c=y.BASIC),H(n,i,y.PREMIUM)&&(c=y.PREMIUM),await K("customerDataV2",async o=>r?{uid:a,stripeId:r.stripeId,email:r.email,name:r.name,payments:r.allPayments,plan:c,isSubscriptionActive:c!==y.FREE,lastCheckAt:Y()}:o),m("rejectFeaturesToWindow"),!0}),f("visitPricingPage",async()=>{const e=`https://esuit.dev/pricing/${s.projectId}`,t=new URLSearchParams({[U.RETURN_EXT_LOCAL]:chrome.runtime.id}).toString();await chrome.tabs.create({url:e+`?${t}`,active:!0})}),f("visitDashboard",async()=>{await chrome.tabs.create({url:"https://esuit.dev/dashboard",active:!0}),m("closePopup")}),A("ifUserLogin",async()=>!!(await F("customerDataV2")).uid),A("userInfoUpdate",async([e])=>{e&&(await K("customerDataV2",t=>(t.uid=e,t)),await m("reFetchCustomerData",!0),m("openOptionsPage",!0),setTimeout(()=>{he(s.hostMatch)},2e3))})}async function ye(){if(S.length>0)return S;const s=await fetch("https://static-data.esuit.dev/index.json").then(e=>e.json());return S=oe(s),S}function H(s,e,t){return!!s.find(a=>{if(![...ce,...ue,...O,..._,...$].includes(a.status)||[...O].includes(a.status)&&(!a.nextBillingDate||a.nextBillingDate<Math.ceil(new Date().getTime()/1e3))||[..._].includes(a.status)&&(!a.nextBillingDate||a.nextBillingDate<Math.ceil(new Date().getTime()/1e3))||[...$].includes(a.status)&&(!a.nextBillingDate||a.nextBillingDate<Math.ceil(new Date().getTime()/1e3)))return!1;const r=e.prices.find(i=>i.id===a.priceId);return!(!r||r.plan!==t)})}var be=Object.defineProperty,we=(s,e,t)=>e in s?be(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,M=(s,e,t)=>(we(s,typeof e!="symbol"?e+"":e,t),t);class j{constructor(e,t){M(this,"listeners",{}),M(this,"tabs",[]),M(this,"slug"),M(this,"isDebugger"),this.slug=e,this.isDebugger=!!t,this.bindMessage(),this.bindEvent()}on(e,t){if(this.listeners[e])throw new Error(`event listener ${String(e)} already exist!`);return this.listeners[e]=t,()=>{delete this.listeners[e]}}async send(e,...t){this.isDebugger&&console.log("send message from background script",{action:e,payload:t,tabs:this.tabs});for(let a of this.tabs)try{const r=await chrome.tabs.get(a);r&&r.id?chrome.tabs.sendMessage(r.id,{from:this.slug,payload:{action:e,payload:t}}):this.deleteTabById(a)}catch(r){console.log(r),this.deleteTabById(a)}}bindMessage(){chrome.runtime.onMessageExternal.addListener((e,t,a)=>{var r,i;if((r=t==null?void 0:t.tab)!=null&&r.id){if(this.isDebugger&&console.log("received message from page",{request:e,sender:t}),e.action==="__connect")return this.tabs.includes(t.tab.id)||this.tabs.push(t.tab.id),a();if(e.action==="__disconnect")return this.deleteTabById(t.tab.id),a();if(this.listeners[e.action])return(i=t==null?void 0:t.tab)!=null&&i.id?(this.tabs.includes(t.tab.id)||this.tabs.push(t.tab.id),this.listeners[e.action](...e.payload).then(n=>{this.isDebugger&&console.log("send to callback from background",{request:e,sender:t,res:n}),a(n)}),!0):a();console.log(`unknown event ${e.action}`)}})}bindEvent(){chrome.tabs.onRemoved.addListener(e=>{this.deleteTabById(e)})}deleteTabById(e){if(this.tabs.includes(e)){const t=this.tabs.indexOf(e);this.tabs.splice(t,1)}}}function ve(s){return[y.FREE,y.BASIC,y.PREMIUM].indexOf(s)}function Ie(s,e){const t=ve(e);return s.limitation?s.limitation[t]:0}function X(s,e){return{[y.FREE]:1,[y.BASIC]:10,[y.PREMIUM]:100}[e]>=s.permission}function L(s,e){return s.map(t=>{e[t.key]?(e[t.key].enable=e[t.key].enable??t.defaultEnable,e[t.key].currentFreeTryCount=e[t.key].currentFreeTryCount??0):e[t.key]={enable:t.defaultEnable,currentFreeTryCount:0}}),e}function Ce(s){const{cacheId:e,defaultMemoConfig:t}=s;f("setUIMemoSettings",async a=>{await chrome.storage.local.set({[e]:a})}),f("getUIMemoSettings",async()=>{const a=await m("getFeaturesDataByPlan");let r=await new Promise(i=>{chrome.storage.local.get([e]).then(n=>{n[e]?i(n[e]):i(!1)})});return r||(r={...t}),Object.keys(r).map(i=>{const n=Object.values(a).find(o=>o._.memoKey===i);if(n&&n.needUpgrade&&(!n.enable||!(n.freeTryLeft>0||n.limitation>0)&&t[i]!==void 0))return c();function c(){r[i]=t[i]}}),{...t,...r}})}let Z=!1;function ke(){return Z}function Se(){Z=!0}const{updateBucket:B,getBucket:W}=E(x);function Me(s){if(ke())return;Se();const e=new j(s,!0);return f("getAllPersistLocalStorage",()=>W("persistLocalStorage")),f("setPersistLocalStorage",async(t,a)=>{await B("persistLocalStorage",r=>{try{a=JSON.stringify(a)}catch{}return r[t]=a,r})}),f("getPersistLocalStorage",async(t,a)=>{const r=await W("persistLocalStorage");if(r[t]){try{return JSON.parse(r[t])}catch{}return r[t]}return a??void 0}),f("clearPersistLocalStorage",async()=>{B("persistLocalStorage",()=>({}))}),f("removePersistLocalStorage",async t=>{B("persistLocalStorage",a=>(delete a[t],a))}),e.on("getAllPersistLocalStorage",()=>m("getAllPersistLocalStorage")),e.on("setPersistLocalStorage",(...t)=>m("setPersistLocalStorage",...t)),e.on("getPersistLocalStorage",(...t)=>m("getPersistLocalStorage",...t)),e.on("clearPersistLocalStorage",()=>m("clearPersistLocalStorage")),void e.on("removePersistLocalStorage",t=>m("removePersistLocalStorage",t))}const{setBucket:z,getBucket:R}=E(x);function Te(s){const{projectId:e,hostMatch:t,cacheId:a,features:r,defaultMemoConfig:i}=s,n=new j(e,!0);return Me(s.projectId),Ce({cacheId:a,defaultMemoConfig:i}),chrome.tabs.onUpdated.addListener(async(u,g,l)=>{if(l&&l.url&&g.status==="loading"){const h=new URL(l.url).hostname;t.find(w=>!!~w.indexOf(h))&&o(u)}}),chrome.storage.onChanged.addListener((u,g)=>{g==="local"&&u&&u.features&&c()}),f("rejectFeaturesToWindow",async()=>{c()}),f("getFeature",async u=>d()[u]),f("consumeFeaturesTreeTryByMemoUIConfigs",async u=>{const g=await d();let l=[];Object.entries(u).map(([h,w])=>{if(i[h]!==void 0&&i[h]!==w){const b=Object.values(g).find(v=>v._.memoKey===h);b&&b.isCanFreeTry&&l.push(b._.key)}}),l.length>0&&m("consumeFeatureTreeTry",l)}),f("consumeFeatureTreeTry",async u=>{let g=L(r,await R("features"));const l=await p();let h=!1;u.map(w=>{const b=r.find(v=>v.key===w||v.memoKey===w);b&&(X(b,l)||(g[b.key].currentFreeTryCount++,h=!0))}),h&&await z("features",g)}),f("saveFeaturesEnables",async u=>{let g=L(r,await R("features"));Object.entries(u).map(([l,h])=>{g[l].enable=h}),await z("features",g)}),f("getFeaturesDataByPlan",d),n.on("getUIMemoSettings",()=>m("getUIMemoSettings")),n.on("setUIMemoSettings",u=>m("setUIMemoSettings",u)),n.on("consumeFeatureTreeTry",u=>m("consumeFeatureTreeTry",u)),n.on("visitPricingPage",()=>m("visitPricingPage")),void n.on("consumeFeaturesTreeTryByMemoUIConfigs",u=>{m("consumeFeaturesTreeTryByMemoUIConfigs",u)});async function c(){const u=await chrome.tabs.query({url:t});u&&u.map(g=>{g&&g.id&&o(g.id)})}async function o(u){const g=await d();chrome.scripting.executeScript({injectImmediately:!0,world:"MAIN",target:{tabId:u,allFrames:!0},func:(l,h)=>{window[h]=JSON.parse(l)},args:[JSON.stringify(g),`${e.replaceAll("-","_")}`]})}async function d(){const u=await p();let g=L(r,await R("features"));return r.map(l=>{var h;const w=X(l,u);let b,v=0;return l.memoKey&&(b=i[l.memoKey]),l.maxFreeTryCount&&g[l.key].currentFreeTryCount!==void 0&&(v=Math.max(0,l.maxFreeTryCount-g[l.key].currentFreeTryCount)),{enable:((h=g[l.key])==null?void 0:h.enable)??l.defaultEnable,needUpgrade:!w,limitation:Ie(l,u),permission:l.permission,freeTryLeft:l.maxFreeTryCount?v:0,isCanFreeTry:!!l.maxFreeTryCount&&l.maxFreeTryCount>0,defaultValue:b,_:l}}).reduce((l,h)=>(l[h._.key]=h,l),{})}async function p(){const u=await m("getCustomerData");return u?u.plan:y.FREE}}function Pe(s,e){(async()=>{let t=0,a=(await chrome.declarativeNetRequest.getDynamicRules()).map(i=>i.id);const r=s.map((i,n)=>(t=n+1,{id:t,priority:1,action:{type:"modifyHeaders",responseHeaders:[{header:"Content-Security-Policy",operation:"remove"},{header:"Content-Security-Policy-Report-Only",operation:"remove"}]},condition:{regexFilter:i,resourceTypes:["main_frame","xmlhttprequest"]}}));e&&e.length>0&&e.map(i=>{i.id=++t,r.push(i)}),await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:a,addRules:r})})()}function xe(s){const e=new j(s,!0);e.on("reFetchCustomerData",t=>m("reFetchCustomerData",t)),e.on("visitDashboard",()=>m("visitDashboard")),e.on("getCustomerData",()=>m("getCustomerData")),e.on("logout",()=>m("logout")),e.on("login",()=>m("login"))}function Ee(s){fe(x),pe(s),xe(s.projectId)}const De=[{key:"fetchLimit",name:"Include Nesting Comment",permission:1,limitation:[200,0,0],defaultEnable:!0,memoKey:null},{key:"nestingComment",name:"Fetch Count limit",permission:10,maxFreeTryCount:5,defaultEnable:!0,memoKey:"isIncludeNesting"},{key:"RESUME_EXPORTING",name:"Resume exporting",permission:10,defaultEnable:!0,memoKey:null}],Fe={fetchLimit:200,isIncludeNesting:!1,fullSpeed:!1,nestingDepth:2};var Le=Object.defineProperty,Be=(s,e,t)=>e in s?Le(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,T=(s,e,t)=>(Be(s,typeof e!="symbol"?e+"":e,t),t);class Re{constructor(e,t){T(this,"listeners",{}),T(this,"tabs",[]),T(this,"slug"),T(this,"isDebugger"),this.slug=e,this.isDebugger=!!t,this.bindMessage(),this.bindEvent()}on(e,t){if(this.listeners[e])throw new Error(`event listener ${String(e)} already exist!`);return this.listeners[e]=t,()=>{delete this.listeners[e]}}async send(e,...t){this.isDebugger&&console.log("send message from background script",{action:e,payload:t,tabs:this.tabs});for(let a of this.tabs)try{const r=await chrome.tabs.get(a);r&&r.id?chrome.tabs.sendMessage(r.id,{from:this.slug,payload:{action:e,payload:t}}):this.deleteTabById(a)}catch(r){console.log(r),this.deleteTabById(a)}}bindMessage(){chrome.runtime.onMessageExternal.addListener((e,t,a)=>{var r,i;if((r=t==null?void 0:t.tab)!=null&&r.id){if(this.isDebugger&&console.log("received message from page",{request:e,sender:t}),e.action==="__connect")return this.tabs.includes(t.tab.id)||this.tabs.push(t.tab.id),a();if(e.action==="__disconnect")return this.deleteTabById(t.tab.id),a();if(this.listeners[e.action])return(i=t==null?void 0:t.tab)!=null&&i.id?(this.tabs.includes(t.tab.id)||this.tabs.push(t.tab.id),this.listeners[e.action](...e.payload).then(n=>{this.isDebugger&&console.log("send to callback from background",{request:e,sender:t,res:n}),a(n)}),!0):a();console.log(`unknown event ${e.action}`)}})}bindEvent(){chrome.tabs.onRemoved.addListener(e=>{this.deleteTabById(e)})}deleteTabById(e){if(this.tabs.includes(e)){const t=this.tabs.indexOf(e);this.tabs.splice(t,1)}}}function je(){return Math.floor(new Date().getTime()/1e3)}const Ue={type:"array",items:{type:"object",properties:{feedbackId:{type:"string",default:""},lastCursor:{type:"string",default:""},lastUpdateAt:{type:"number",default:0}},required:["feedbackId","lastCursor","lastUpdateAt"]},default:[]},Ae={resumeCursor:Ue},{updateBucket:G,setBucket:Ne,getBucket:Oe,deleteBucket:Ve}=E(Ae);function _e(){const s=new Re(I,!0);s.on("visitPricing",async()=>{m("visitPricingPage")}),s.on("setResumeCursor",async e=>{e.feedbackId&&await G("resumeCursor",t=>{const a=t.findIndex(n=>n.feedbackId===e.feedbackId),r=je(),i={...e,lastUpdateAt:r};return~a?t[a]=i:t.push(i),t})}),s.on("getResumeCursor",e=>new Promise(async t=>{const r=(await Oe("resumeCursor")).find(i=>i.feedbackId===e);t(r??null)})),s.on("removeResumeCursor",async e=>{await G("resumeCursor",t=>{const a=t.findIndex(r=>r.feedbackId===e);return~a&&t.splice(a,1),t})})}Pe(C);_e();le({hostMatch:C,extensionId:I,extensionName:ee});Ee({projectId:I,callbackExtId:chrome.runtime.id,hostMatch:C});Te({projectId:I,hostMatch:C,cacheId:"app-2.1.0",features:De,defaultMemoConfig:Fe});chrome.scripting.registerContentScripts([{id:`inject-${I}`,js:["injects/proxy.js"],matches:C,runAt:"document_start",world:"MAIN"}]);chrome.scripting.registerContentScripts([{id:`inject-${I}-module`,js:["injects/vendors.js","injects/index.js"],matches:C,runAt:"document_end",world:"MAIN"}]);
