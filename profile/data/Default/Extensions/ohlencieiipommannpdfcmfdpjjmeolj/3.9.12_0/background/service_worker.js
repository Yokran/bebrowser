(()=>{"use strict";const e={"":"root","pf-core":"core",algo:"algo",serviceWorker:"serviceWorker"},t="3.9.12";var n=function(e){return e.OpenPrintFriendly="openPrintfriendly",e.StartCaptureFullPage="startCaptureFullPage",e.CaptureCurrentView="captureCurrentView",e.ContinueCaptureFullPage="continueCaptureFullPage",e.EndCaptureFullPage="endCaptureFullPage",e.CancelCaptureFullPage="cancelCaptureFullPage",e.ScrollPage="scrollPage",e.ConfigureDefaultButton="configureDefaultButton",e}({}),r=function(e){return e.SettingsTextSize="printfriendly_settings_text_size",e.SettingsImageSize="printfriendly_settings_img_size",e.ScreenshotImages="printfriendly_screenshot_images",e.SettingsScreenshotBanner="printfriendly_settings_screenshot_banner",e.SettingsDefaultMode="printfriendly_settings_default_mode",e.SettingsPaperSize="printfriendly_settings_paper_size",e.SettingsScreenshotFormat="printfriendly_settings_screenshot_format",e.SettingsLanguage="printfriendly_settings_language",e.PopupWindowId="printfriendly_popup_window_id",e.ScreenshotTabId="printfriendly_screenshot_tab_id",e.ScreenshotCapturing="printfriendly_screenshot_capturing",e.ScreenshotImage="printfriendly_screenshot_img",e.ScreenshotSlices="printfriendly_screenshot_slices",e.WebsiteHostname="printfriendly_website_hostname",e.WebsiteUrl="printfriendly_website_url",e.WebsiteTitle="printfriendly_website_title",e.AlreadyShownIntro="alreadyShownIntro",e.ClientId="printfriendly_client_id",e.ScreenshotProgress="printfriendly_screenshot_progress",e.ScreenshotFilename="printfriendly_screenshot_filename",e.PrintInTabPayload="printfriendly_print_in_tab_payload",e}({}),o=function(e){return e.Letter="Letter",e.A4="A4",e}({}),i=function(e){return e.Full="100",e.ThreeQuarters="75",e.Half="50",e.Quarter="25",e.None="0",e}({}),c=function(e){return e.ExtraLarge="130",e.Larger="120",e.Large="110",e.Normal="100",e.Small="90",e.Smaller="80",e.ExtraSmall="70",e}({}),s=function(e){return e.Off="off",e.PrintFriendly="printFriendly",e.ViewScreenshot="viewScreenshot",e.FullPageScreenshot="fullPageScreenshot",e}({});function a(e,t,n,r,o,i,c){try{var s=e[i](c),a=s.value}catch(e){return void n(e)}s.done?t(a):Promise.resolve(a).then(r,o)}function l(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function c(e){a(i,r,o,c,s,"next",e)}function s(e){a(i,r,o,c,s,"throw",e)}c(void 0)}))}}chrome.tabs.onUpdated.addListener(((e,t,n)=>{"complete"===t.status&&n.active&&setTimeout((()=>{chrome.tabs.get(e,(e=>{if(e&&e.url){const t=e.url||"",n=e.title||"";if(t)try{const e=new URL(t).hostname;chrome.storage.local.set({[r.WebsiteHostname]:e})}catch(e){console.error("Failed to construct URL:",e)}chrome.storage.local.set({[r.WebsiteUrl]:t,[r.WebsiteTitle]:n})}}))}),500)}));const u={};function d(e,t,n=0){const r=e[t.destination];r?r.postMessage(t):n<10?setTimeout((()=>d(e,t,n+1)),100*2**n):console.error(`Could not send message to port ${t.destination}`)}function p(e,t,n,r,o,i,c){try{var s=e[i](c),a=s.value}catch(e){return void n(e)}s.done?t(a):Promise.resolve(a).then(r,o)}function h(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function c(e){p(i,r,o,c,s,"next",e)}function s(e){p(i,r,o,c,s,"throw",e)}c(void 0)}))}}function f(){return(f=h((function*(){let e=(yield chrome.storage.local.get(r.ClientId)).clientId;return e||(e=self.crypto.randomUUID(),yield chrome.storage.local.set({[r.ClientId]:e})),e}))).apply(this,arguments)}function g(){return m.apply(this,arguments)}function m(){return m=h((function*(e={}){const n=yield function(){return f.apply(this,arguments)}();console.log(`chrome-extension.${t}.${n}`);try{yield fetch("https://www.google-analytics.com/mp/collect?measurement_id=G-BLWBW4RJE2&api_secret=sN8DehDvT46i0AnXGJUOLg",{method:"POST",body:JSON.stringify({client_id:`chrome-extension.${t}`,events:[e]})})}catch(e){console.warn("Google Analytics request was blocked:",e)}})),m.apply(this,arguments)}let y;function v(){return y="production",y}function w(e,t,n,r,o,i){const c=(e,t)=>{void 0===window.wrappedJSObject?window[e]=t:window.wrappedJSObject[e]=t};c("extensionPath",e),c("extensionTextSize",n),c("extensionImgSize",r),c("extensionIsScreenshotImg",o),c("extensionScreenshotBanner",i);const s="development"===t?"https://v.printfriendly.com":"https://www.printfriendly.com";c("pfOptions",{hosts:{pf:s,email:s},environment:t})}function S(e,t,n,r,o,i,c){try{var s=e[i](c),a=s.value}catch(e){return void n(e)}s.done?t(a):Promise.resolve(a).then(r,o)}function b(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function c(e){S(i,r,o,c,s,"next",e)}function s(e){S(i,r,o,c,s,"throw",e)}c(void 0)}))}}function P(e,t){return _.apply(this,arguments)}function _(){return _=b((function*(e,t){const n=yield chrome.storage.local.get([r.SettingsTextSize,r.SettingsImageSize,r.ScreenshotImages,r.SettingsScreenshotBanner]);yield chrome.scripting.executeScript({target:{tabId:e},func:w,args:[chrome.runtime.getURL("/").replace(/\/$/,""),t,n[r.SettingsTextSize]||c.Normal,n[r.SettingsImageSize]||i.Full,Boolean(n[r.ScreenshotImages].length),void 0===n[r.SettingsScreenshotBanner]||n[r.SettingsScreenshotBanner]]}),yield chrome.scripting.executeScript({target:{tabId:e},files:["/scripts/printfriendly.js"]})})),_.apply(this,arguments)}function I(){return(I=b((function*(e){const[t]=yield chrome.scripting.executeScript({target:{tabId:e},func:()=>!!window.pfPageScrollInjected});t.result||(yield chrome.scripting.executeScript({target:{tabId:e},files:["/scripts/page-scroll.js"]}),yield chrome.scripting.executeScript({target:{tabId:e},func:()=>{window.pfPageScrollInjected=!0}}))}))).apply(this,arguments)}function x(e){return new Promise((t=>{const n=setTimeout((()=>{clearTimeout(n),t()}),e)}))}function C(e,t,n,r,o,i,c){try{var s=e[i](c),a=s.value}catch(e){return void n(e)}s.done?t(a):Promise.resolve(a).then(r,o)}function F(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function c(e){C(i,r,o,c,s,"next",e)}function s(e){C(i,r,o,c,s,"throw",e)}c(void 0)}))}}function O(){return L.apply(this,arguments)}function L(){return(L=F((function*(){const e=yield new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(t=>{const n=t[0];e(n)}))})),{format:t}=yield T(),n=yield chrome.tabs.captureVisibleTab(e.windowId,{format:t});yield chrome.storage.local.set({[r.ScreenshotImages]:[n]})}))).apply(this,arguments)}function T(){return j.apply(this,arguments)}function j(){return(j=F((function*(){const e=yield chrome.storage.local.get(r.SettingsScreenshotFormat);let t="jpeg",n="image/jpeg";return"png"===e[r.SettingsScreenshotFormat]?(t="png",n="image/png"):"jpg"===e[r.SettingsScreenshotFormat]&&(t="jpeg",n="image/jpeg"),{format:t,mimeType:n}}))).apply(this,arguments)}function W(e){const t=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],r=new ArrayBuffer(t.length),o=new Uint8Array(r);for(let e=0;e<t.length;e++)o[e]=t.charCodeAt(e);const i=new Blob([r],{type:n});return createImageBitmap(i)}function A(e){return new Promise((t=>{const n=new FileReader;n.readAsDataURL(e),n.onloadend=()=>{t(n.result)}}))}function D(e){return R.apply(this,arguments)}function R(){return(R=F((function*(e,t=""){const n=yield chrome.tabs.get(e);if(n){const e=function(e,t,n=""){let r=function(e){const t=e.match(/^(https?:\/\/)?([^/]+)/);return t?t[2].trim():""}(e).replace("www.","");return r=r.match("printfriendly")?"":r+"-",r=`${r}${t.replace(/[^[a-zA-Z0-9\s_-]/g,"").substring(0,100)}`,n&&(r=`${r}-${n}`),r}(n.url||"",n.title||"",t);yield chrome.storage.local.set({[r.ScreenshotFilename]:e})}chrome.tabs.create({url:"pages/screenshot.html",index:n.index+1})}))).apply(this,arguments)}function B(){return k.apply(this,arguments)}function k(){return(k=F((function*(){yield chrome.storage.local.set({[r.ScreenshotImages]:[]})}))).apply(this,arguments)}function z(e,t){return E.apply(this,arguments)}function E(){return(E=F((function*(e,t){yield chrome.storage.local.set({[r.ScreenshotCapturing]:e,[r.ScreenshotProgress]:0,[r.ScreenshotTabId]:t})}))).apply(this,arguments)}function M(e,t,n,r,o,i,c){try{var s=e[i](c),a=s.value}catch(e){return void n(e)}s.done?t(a):Promise.resolve(a).then(r,o)}function U(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function c(e){M(i,r,o,c,s,"next",e)}function s(e){M(i,r,o,c,s,"throw",e)}c(void 0)}))}}function V(){return N.apply(this,arguments)}function N(){return(N=U((function*(){switch((yield chrome.storage.local.get(r.SettingsDefaultMode))[r.SettingsDefaultMode]||s.Off){case s.Off:chrome.action.setPopup({popup:"pages/popup.html"});break;case s.PrintFriendly:case s.FullPageScreenshot:case s.ViewScreenshot:chrome.action.setPopup({popup:""})}}))).apply(this,arguments)}function $(e,t,n,r,o,i,c){try{var s=e[i](c),a=s.value}catch(e){return void n(e)}s.done?t(a):Promise.resolve(a).then(r,o)}function H(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function c(e){$(i,r,o,c,s,"next",e)}function s(e){$(i,r,o,c,s,"throw",e)}c(void 0)}))}}function J(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function G(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){J(e,t,n[t])}))}return e}function q(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}const Q=32767;class X{captureVisibleArea(e,t){var n=this;return H((function*(){const r=yield chrome.tabs.get(t),{format:o}=yield T();for(let t=0;t<5;t++)try{const t=yield chrome.tabs.captureVisibleTab(r.windowId,{format:o});n.screens.push(q(G({},e),{data:t}));break}catch(e){if(e.message.includes("MAX_CAPTURE_VISIBLE_TAB_CALLS_PER_SECOND")){yield new Promise((e=>setTimeout(e,400)));continue}}}))()}saveFullPageScreenshot(){var e=this;return H((function*(){if(0===e.screens.length)return;yield chrome.storage.local.remove(String(r.ScreenshotImages)),e.screens.reverse();let t=null,n=null,o=0,i=0,c=0;const s=[],a=[];a.push(e.screens[1]),a.push(e.screens[0]),a.push(...e.screens.slice(2));for(let e=0,r=a.length;e<r;++e){const l=a[e];if(!t){const e=l.totalWidth*l.devicePixelRatio;i=o,o=Math.min(Q,l.totalHeight*l.devicePixelRatio),t=new OffscreenCanvas(e,o),n=t.getContext("2d")}const u=yield W(l.data),d=l.x*l.devicePixelRatio;let p=0;p=c>0?l.y*l.devicePixelRatio-(i||o)*c:l.y*l.devicePixelRatio,l.yOffset&&(p+=l.yOffset*l.devicePixelRatio),null==n||n.drawImage(u,0,0,u.width,u.height,d,p,u.width,u.height);const h=o-p;if(h>0&&h<l.height*l.devicePixelRatio){const p=yield t.convertToBlob(),f=yield A(p);s.push(f),c++;const g=l.totalWidth*l.devicePixelRatio,m=[Q,l.totalHeight*l.devicePixelRatio];if(Math.ceil(m[1]/Q)===c+1){let t=0;for(let n=e;n<r;++n){const e=a[n],r=a[n+1];e&&r&&(t+=r.y-e.y)}t*=l.devicePixelRatio,t+=u.height-h,m.push(t)}i=o,o=Math.min(...m),t=new OffscreenCanvas(g,o),n=t.getContext("2d"),null==n||n.drawImage(u,0,h,u.width,u.height,d,0,u.width,u.height)}}if(t){const e=yield t.convertToBlob(),n=yield A(e);s.push(n)}yield chrome.storage.local.set({[r.ScreenshotImages]:s}),e.screens=[]}))()}cancelFullPageScreenshot(){var e=this;return H((function*(){0!==e.screens.length&&(e.screens=[],yield chrome.storage.local.set({[r.ScreenshotImages]:""}))}))()}constructor(){J(this,"screens",[])}}function Z(e,t,n,r,o,i,c){try{var s=e[i](c),a=s.value}catch(e){return void n(e)}s.done?t(a):Promise.resolve(a).then(r,o)}function K(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function c(e){Z(i,r,o,c,s,"next",e)}function s(e){Z(i,r,o,c,s,"throw",e)}c(void 0)}))}}function Y(){return ee.apply(this,arguments)}function ee(){return(ee=K((function*(){const e=yield chrome.storage.local.get(r.PopupWindowId);try{e[r.PopupWindowId]&&(yield chrome.storage.local.remove(String(r.PopupWindowId)),yield chrome.windows.remove(e[r.PopupWindowId]))}catch(e){}}))).apply(this,arguments)}function te(){return(te=K((function*(e){const t=yield chrome.tabs.get(e),n=t.width||800,o=t.windowId;if(o){const e=yield chrome.windows.get(o),i=yield chrome.windows.create({url:"pages/popup.html",type:"popup",width:300,height:280,left:n-300,top:(e.height||0)-(t.height||0)+(e.top||0)});yield chrome.storage.local.set({[r.PopupWindowId]:i.id})}}))).apply(this,arguments)}function ne(e,t,n,r,o,i,c){try{var s=e[i](c),a=s.value}catch(e){return void n(e)}s.done?t(a):Promise.resolve(a).then(r,o)}function re(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function c(e){ne(i,r,o,c,s,"next",e)}function s(e){ne(i,r,o,c,s,"throw",e)}c(void 0)}))}}const oe=function(){const e=new EventTarget;return{emit(t){const n=new CustomEvent(t.type,{detail:t.data});e.dispatchEvent(n)},on(t,n){e.addEventListener(t,(e=>{n(e.detail)}))},off(t,n){e.removeEventListener(t,n)}}}();chrome.runtime.onInstalled.addListener((()=>{fetch("https://api.printfriendly.com/v2/defaults").then((e=>e.json())).then((e=>{chrome.storage.local.set({[r.SettingsPaperSize]:e.page_size})})).catch((()=>chrome.storage.local.set({[r.SettingsPaperSize]:o.Letter}))),chrome.storage.local.set({[r.ScreenshotImages]:""}),chrome.storage.local.remove(String(r.PopupWindowId)),chrome.storage.local.remove(String(r.ScreenshotImage)),chrome.storage.local.remove(String(r.ScreenshotSlices))})),chrome.runtime.onInstalled.addListener(l((function*(){try{(yield chrome.storage.local.get(r.AlreadyShownIntro))[r.AlreadyShownIntro]||(chrome.tabs.create({url:"https://www.printfriendly.com/users/sign_up/?utm_source=chrome-extension&utm_medium=extension&utm_campaign=onboarding"}),yield chrome.storage.local.set({[r.AlreadyShownIntro]:!0}))}catch(e){console.error("Could not open intro")}})));const ie=function(e){const t=v();return chrome.action.onClicked.addListener(function(){var o=U((function*(o){const i=yield chrome.storage.local.get(r.SettingsDefaultMode);switch(g({name:"extension_navbar_start",params:{}}),i[r.SettingsDefaultMode]||s.Off){case s.Off:case s.PrintFriendly:yield B(),(null==o?void 0:o.id)?yield P(o.id,t):console.warn("printfriendly. No tab found (browser action)");break;case s.ViewScreenshot:yield O(),(null==o?void 0:o.id)?yield D(o.id,"cvscreenshot"):console.warn("viewScreenshot. No tab found (browser action)");break;case s.FullPageScreenshot:e.emit({type:n.StartCaptureFullPage,data:{tabId:null==o?void 0:o.id}})}}));return function(e){return o.apply(this,arguments)}}()),V(),{messageListener:(e,r,o)=>U((function*(){if(e.action===n.OpenPrintFriendly){g({name:"extension_navbar_start",params:{}}),o({success:!0});const n=e.tabId;n?(B(),yield P(n,t)):console.warn("No tab found (openPrintFriendly)")}else e.action===n.ConfigureDefaultButton&&(yield V(),o({success:!0}))}))()}}(oe),ce=function(e){const t=new X,o=function(){var e=re((function*(e){(yield chrome.storage.local.get(r.PopupWindowId))[r.PopupWindowId]!==e.windowId&&(yield s())}));return function(t){return e.apply(this,arguments)}}(),i=function(){var e=re((function*(e,t){e&&(t&&(yield x(t),yield function(e){return te.apply(this,arguments)}(e)),chrome.tabs.onActivated.addListener(o),yield z(!0,e),chrome.action.setPopup({popup:"pages/popup.html"}),yield function(e){return I.apply(this,arguments)}(e),chrome.tabs.sendMessage(e,{action:n.ScrollPage}))}));return function(t,n){return e.apply(this,arguments)}}(),c=function(){var e=re((function*(){yield t.saveFullPageScreenshot(),V();const e=yield chrome.storage.local.get([r.ScreenshotTabId]);return yield Y(),e[r.ScreenshotTabId]&&(yield D(e[r.ScreenshotTabId],"fpscreenshot")),chrome.tabs.onActivated.removeListener(o),yield z(!1,0),{success:!0}}));return function(){return e.apply(this,arguments)}}(),s=function(){var e=re((function*(){return yield z(!1,0),yield t.cancelFullPageScreenshot(),yield Y(),V(),{success:!0}}));return function(){return e.apply(this,arguments)}}(),a=function(){var e=re((function*(e,t){return t&&(yield x(t)),yield B(),yield z(!1,0),yield O(),yield D(e,"cvscreenshot"),{success:!0}}));return function(t,n){return e.apply(this,arguments)}}(),l=function(){var e=re((function*(e){const n=yield chrome.storage.local.get([r.ScreenshotTabId]);return n[r.ScreenshotTabId]&&(yield t.captureVisibleArea(e,n[r.ScreenshotTabId])),{success:!0}}));return function(t){return e.apply(this,arguments)}}();return chrome.runtime.onConnect.addListener((e=>{e.onDisconnect.addListener(re((function*(){(yield chrome.storage.local.get(r.ScreenshotCapturing))[r.ScreenshotCapturing]&&(yield s())})))})),e.on(n.StartCaptureFullPage,(e=>{i(e.tabId,10)})),{messageListener:(e,t,r)=>re((function*(){switch(e.action){case n.CaptureCurrentView:a(e.tabId,e.delay).then(r);break;case n.StartCaptureFullPage:i(e.tabId,e.delay).then((()=>r({success:!0})));break;case n.ContinueCaptureFullPage:l(e.screen).then((()=>r({success:!0})));break;case n.EndCaptureFullPage:c().then(r);break;case n.CancelCaptureFullPage:s().then(r)}}))()}}(oe);var se;!function(){const e=v();chrome.contextMenus.onClicked.addListener(((t,n)=>{"printfriendly"===t.menuItemId&&g({name:"context_menu_start",params:{}}),(null==n?void 0:n.id)?P(n.id,e):console.warn("No tab found (context menu)")})),chrome.runtime.onInstalled.addListener((()=>{chrome.contextMenus.create({id:"printfriendly",title:"Print Friendly and PDF",contexts:["page","selection","link","editable","image","frame"]})}))}(),chrome.runtime.setUninstallURL("https://printfriendly.com/extension_feedback/new"),se=[ie.messageListener,ce.messageListener],chrome.runtime.onMessage.addListener(((e,t,n)=>{var r;const o=(null===(r=t.tab)||void 0===r?void 0:r.id)||0,i=u[o];if(e.action)for(const r of se)r(e,t,n);else if(i)return d(i,e),n({success:!0}),!1;return!0})),chrome.runtime.onConnect.addListener((function(t){var n,r;const o=(null===(r=t.sender)||void 0===r||null===(n=r.tab)||void 0===n?void 0:n.id)||0;u[o]||(u[o]={root:null,core:null,algo:null});const i=u[o],c=e[t.name];i[c]=t,t.onDisconnect.addListener((()=>{delete i[c]})),t.onMessage.addListener((function(e){i[e.destination].postMessage(e)}))}))})();